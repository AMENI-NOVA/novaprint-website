{% extends "base.html" %}

{% block title %}Performance Clients - Projet 9{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- En-tête avec navigation -->
    <div class="row mb-4">
        <div class="col-12">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Accueil</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('projet9.index') }}">Projet 9</a></li>
                    <li class="breadcrumb-item active">Performance Clients</li>
                </ol>
            </nav>
            
            <div class="d-flex justify-content-between align-items-center">
                <h1><i class="fas fa-users me-2"></i>Performance Clients - Analyse Détaillée</h1>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-success" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>Actualiser
                    </button>
                    <a href="{{ url_for('projet9.index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-1"></i>Accueil Projet 9
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Filtres et recherche -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-filter me-2"></i>Filtres et Recherche</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="clientSearch" class="form-label">Rechercher un client</label>
                            <input type="text" class="form-control" id="clientSearch" placeholder="Nom du client..." onkeyup="applyFilters()">
                        </div>
                        <div class="col-md-2">
                            <label for="minCommandes" class="form-label">Min Commandes</label>
                            <input type="number" class="form-control" id="minCommandes" min="0" onchange="applyFilters()">
                        </div>
                        <div class="col-md-2">
                            <label for="minPonctualite" class="form-label">Min Ponctualité (%)</label>
                            <input type="number" class="form-control" id="minPonctualite" min="0" max="100" onchange="applyFilters()">
                        </div>
                        <div class="col-md-2">
                            <label for="sortBy" class="form-label">Trier par</label>
                            <select class="form-select" id="sortBy" onchange="applyFilters()">
                                <option value="total_commandes">Total Commandes</option>
                                <option value="taux_ponctualite">Taux Ponctualité</option>
                                <option value="delai_moyen">Délai Moyen</option>
                                <option value="client">Nom Client</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label for="sortOrder" class="form-label">Ordre</label>
                            <select class="form-select" id="sortOrder" onchange="applyFilters()">
                                <option value="desc">Décroissant</option>
                                <option value="asc">Croissant</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button class="btn btn-outline-secondary" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Effacer les filtres
                            </button>
                            <span class="ms-3 text-muted">
                                <span id="clientCount">0</span> client(s) affiché(s)
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Graphiques de performance -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-bar me-2"></i>Top 10 Clients par Nombre de Commandes</h5>
                </div>
                <div class="card-body">
                    <canvas id="topClientsChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-chart-line me-2"></i>Distribution des Taux de Ponctualité</h5>
                </div>
                <div class="card-body">
                    <canvas id="ponctualiteChart" width="400" height="200"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tableau des performances clients -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-table me-2"></i>Détail des Performances par Client</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="clientsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th>Client</th>
                                    <th>Total Commandes</th>
                                    <th>Commandes Livrées</th>
                                    <th>Livrées à Temps</th>
                                    <th>Taux Ponctualité</th>
                                    <th>Délai Moyen</th>
                                    <th>Statut Performance</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody">
                                <!-- Données chargées dynamiquement -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation vers autres vues -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-link me-2"></i>Navigation</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('projet9.vue_ensemble') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-chart-pie me-1"></i>Vue d'Ensemble
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('projet9.commandes_detaillees') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-list me-1"></i>Commandes Détaillées
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('projet9.analyses_avancees') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-chart-line me-1"></i>Analyses Avancées
                            </a>
                        </div>
                        <div class="col-md-3 mb-2">
                            <a href="{{ url_for('projet9.index') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-home me-1"></i>Page Principale
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allClients = [];
let filteredClients = [];

document.addEventListener('DOMContentLoaded', function() {
    loadPerformanceClients();
});

function loadPerformanceClients() {
    fetch('/projet9/api/performance-par-client')
        .then(res => res.json())
        .then(data => {
            allClients = data;
            filteredClients = [...data];
            applyFilters();
            createCharts();
        })
        .catch(error => {
            console.error('Erreur lors du chargement des performances clients:', error);
            document.getElementById('clientsTableBody').innerHTML = 
                '<tr><td colspan="8" class="text-center text-danger">Erreur lors du chargement des données</td></tr>';
        });
}

function displayClients() {
    const tbody = document.getElementById('clientsTableBody');
    
    if (filteredClients.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Aucun client trouvé</td></tr>';
        return;
    }

    tbody.innerHTML = filteredClients.map(client => `
        <tr>
            <td><strong>${client.client}</strong></td>
            <td><span class="badge bg-primary">${client.total_commandes}</span></td>
            <td><span class="badge bg-info">${client.commandes_livrees}</span></td>
            <td><span class="badge bg-success">${client.livrees_a_temps}</span></td>
            <td>${getPonctualiteDisplay(client.taux_ponctualite)}</td>
            <td><span class="badge bg-secondary">${client.delai_moyen} jours</span></td>
            <td>${getPerformanceStatus(client.taux_ponctualite)}</td>
            <td>
                <button class="btn btn-sm btn-outline-info" onclick="showClientDetails('${client.client}')">
                    <i class="fas fa-eye me-1"></i>Détails
                </button>
            </td>
        </tr>
    `).join('');
}

function getPonctualiteDisplay(taux) {
    const badgeClass = taux >= 80 ? 'bg-success' : taux >= 60 ? 'bg-warning' : 'bg-danger';
    return `<span class="badge ${badgeClass}">${taux}%</span>`;
}

function getPerformanceStatus(taux) {
    if (taux >= 90) return '<span class="badge bg-success">Excellent</span>';
    if (taux >= 80) return '<span class="badge bg-success">Très Bon</span>';
    if (taux >= 70) return '<span class="badge bg-warning">Bon</span>';
    if (taux >= 60) return '<span class="badge bg-warning">Moyen</span>';
    return '<span class="badge bg-danger">À Améliorer</span>';
}

function applyFilters() {
    const clientSearch = document.getElementById('clientSearch').value.toLowerCase();
    const minCommandes = parseInt(document.getElementById('minCommandes').value) || 0;
    const minPonctualite = parseFloat(document.getElementById('minPonctualite').value) || 0;
    const sortBy = document.getElementById('sortBy').value;
    const sortOrder = document.getElementById('sortOrder').value;

    filteredClients = allClients.filter(client => {
        const matchClient = !clientSearch || client.client.toLowerCase().includes(clientSearch);
        const matchMinCommandes = client.total_commandes >= minCommandes;
        const matchMinPonctualite = client.taux_ponctualite >= minPonctualite;

        return matchClient && matchMinCommandes && matchMinPonctualite;
    });

    // Trier les résultats
    filteredClients.sort((a, b) => {
        let aVal, bVal;
        
        switch(sortBy) {
            case 'total_commandes':
                aVal = a.total_commandes;
                bVal = b.total_commandes;
                break;
            case 'taux_ponctualite':
                aVal = a.taux_ponctualite;
                bVal = b.taux_ponctualite;
                break;
            case 'delai_moyen':
                aVal = a.delai_moyen;
                bVal = b.delai_moyen;
                break;
            case 'client':
                aVal = a.client.toLowerCase();
                bVal = b.client.toLowerCase();
                break;
            default:
                aVal = a.total_commandes;
                bVal = b.total_commandes;
        }

        if (sortOrder === 'asc') {
            return aVal > bVal ? 1 : -1;
        } else {
            return aVal < bVal ? 1 : -1;
        }
    });

    displayClients();
    updateClientCount();
}

function clearFilters() {
    document.getElementById('clientSearch').value = '';
    document.getElementById('minCommandes').value = '';
    document.getElementById('minPonctualite').value = '';
    document.getElementById('sortBy').value = 'total_commandes';
    document.getElementById('sortOrder').value = 'desc';
    applyFilters();
}

function updateClientCount() {
    document.getElementById('clientCount').textContent = filteredClients.length;
}

function refreshData() {
    loadPerformanceClients();
}

function showClientDetails(clientName) {
    alert(`Détails pour ${clientName} - Fonctionnalité à développer`);
}

function createCharts() {
    createTopClientsChart();
    createPonctualiteChart();
}

function createTopClientsChart() {
    const top10 = allClients.slice(0, 10);
    const ctx = document.getElementById('topClientsChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'bar',
        data: {
            labels: top10.map(c => c.client.length > 15 ? c.client.substring(0, 15) + '...' : c.client),
            datasets: [{
                label: 'Nombre de Commandes',
                data: top10.map(c => c.total_commandes),
                backgroundColor: 'rgba(54, 162, 235, 0.8)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            },
            plugins: {
                legend: {
                    display: false
                }
            }
        }
    });
}

function createPonctualiteChart() {
    const ranges = [
        { label: '90-100%', min: 90, max: 100, count: 0 },
        { label: '80-89%', min: 80, max: 89, count: 0 },
        { label: '70-79%', min: 70, max: 79, count: 0 },
        { label: '60-69%', min: 60, max: 69, count: 0 },
        { label: '0-59%', min: 0, max: 59, count: 0 }
    ];

    allClients.forEach(client => {
        ranges.forEach(range => {
            if (client.taux_ponctualite >= range.min && client.taux_ponctualite <= range.max) {
                range.count++;
            }
        });
    });

    const ctx = document.getElementById('ponctualiteChart').getContext('2d');
    
    new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ranges.map(r => r.label),
            datasets: [{
                data: ranges.map(r => r.count),
                backgroundColor: [
                    '#28a745',
                    '#20c997',
                    '#ffc107',
                    '#fd7e14',
                    '#dc3545'
                ]
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}
</script>
{% endblock %}
