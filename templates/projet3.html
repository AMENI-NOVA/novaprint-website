{% extends "base.html" %}

{% block title %}Suivi des Commandes – BAT{% endblock %}

{% block content %}
    <h1 class="fade-in">Suivi des Commandes – Commande Manager</h1>

    <div style="text-align: center; margin-bottom: 10px;" class="fade-in">
        <button id="resetFilters" class="btn-action">🔄 Réinitialiser les filtres</button>
    </div>

    <div id="loader" class="fade-in" style="text-align:center; font-weight:bold; color:#e30613; margin: 20px;">
        ⏳ Chargement des données en cours...
    </div>

    <div class="table-wrapper fade-in">
        <table id="commandesTable" class="display novaprint-table" style="width:100%">
            <thead>
                <tr>
                    <th>Numéro</th>
                    <th>Client</th>
                    <th>Date BAT</th>
                    <th>Date Réception</th>
                    <th>Action Réception</th>
                    <th>Prépresse</th>
                    <th>% Reçu</th>
                    <th>Livraison</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
{% endblock %}

{% block extra_js %}
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>

    <script>
    $(document).ready(function () {
        const table = $('#commandesTable').DataTable({
            ajax: {
                url: '/projet3/api/commandes',
                dataSrc: 'data'
            },
            columns: [
                { data: 'Numero' },
                { data: 'RaisonSociale' },
                {
                    data: 'DteBat',
                    render: function (data, type, row) {
                        return `<input type="date" value="${data}" data-id="${row.ID}" class="input-date-bat">`;
                    }
                },
                {
                    data: 'DteReceptElem',
                    render: function (data) {
                        if (!data || data.startsWith('9999')) return '<span class="etat-rouge">❌ Aucune date</span>';
                        return `<span class="etat-vert">${data}</span>`;
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `<button class='btn-action reception' data-id="${row.ID}">✅ Confirmer</button>`;
                    }
                },
                {
                    data: 'EtatPrepress',
                    render: function (data) {
                        if (data == 1) return '<span class="etat-vert">✔️</span>';
                        if (data == 2) return '<span class="etat-orange">🟠</span>';
                        return '<span class="etat-rouge">❌</span>';
                    }
                },
                {
                    data: 'PourcentageReceptElem',
                    render: function (data) {
                        if (data === 100) return '<span class="etat-vert">✔️ 100%</span>';
                        if (data === 0) return '<span class="etat-rouge">❌ 0%</span>';
                        return `<span class="etat-orange">${data}%</span>`;
                    }
                },
                {
                    data: 'EtatLiv',
                    render: function (data) {
                        if (data === 1) return '<span class="etat-vert">✔️ Livré</span>';
                        if (data === 2) return '<span class="etat-orange">🟠 En cours</span>';
                        return '<span class="etat-rouge">❌ Non livré</span>';
                    }
                },
                {
                    data: null,
                    render: function (data, type, row) {
                        return `<button class='btn-action envoyer-bat' data-id="${row.ID}">📤 Envoi BAT</button>`;
                    }
                }
            ],
            order: [[0, 'desc']],
            pageLength: 50,
            dom: 'Bflrtip',
            buttons: [
                {
                    extend: 'excelHtml5',
                    text: '📥 Exporter Excel',
                    className: 'btn-action'
                },
                {
                    extend: 'pdfHtml5',
                    text: '📄 Exporter PDF',
                    className: 'btn-action',
                    orientation: 'landscape',
                    pageSize: 'A4'
                }
            ],
            language: {
                search: "🔍 Rechercher :",
                lengthMenu: "Afficher _MENU_ lignes",
                info: "Affichage de _START_ à _END_ sur _TOTAL_ entrées",
                paginate: {
                    previous: "Précédent",
                    next: "Suivant"
                }
            }
        });

        $('#resetFilters').on('click', function () {
            table.search('').columns().search('').draw();
        });

        $('#commandesTable tbody').on('change', '.input-date-bat', function () {
            const id = $(this).data('id');
            const date = $(this).val();
            fetch(`/projet3/api/commandes/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ DteBat: date })
            }).then(res => res.json()).then(() => table.ajax.reload(null, false));
        });

        $('#commandesTable tbody').on('click', '.reception', function () {
            const id = $(this).data('id');
            fetch(`/projet3/api/commandes/${id}/reception`, {
                method: 'PUT'
            }).then(res => res.json()).then(() => table.ajax.reload(null, false));
        });

        $('#commandesTable tbody').on('click', '.envoyer-bat', function () {
            const id = $(this).data('id');
            fetch(`/projet3/api/commandes/${id}/envoi`, {
                method: 'PUT'
            }).then(res => res.json()).then(() => table.ajax.reload(null, false));
        });

        // Message de debug simple
        fetch('/projet3/api/commandes')
            .then(res => res.json())
            .then(data => {
                document.getElementById('loader').style.display = 'none';
                const debug = document.createElement('p');
                debug.textContent = `✅ ${data.data.length} commandes récupérées`;
                debug.style.textAlign = 'center';
                debug.style.color = '#999';
                document.body.appendChild(debug);
            })
            .catch(() => {
                const debug = document.createElement('p');
                debug.textContent = '❌ Erreur lors de la récupération des commandes';
                debug.style.textAlign = 'center';
                debug.style.color = 'red';
                document.body.appendChild(debug);
            });
    });
    </script>
{% endblock %}
