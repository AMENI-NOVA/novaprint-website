{% extends "base.html" %}

{% block title %}Projet 16 - GMAO{% endblock %}

{% block content %}
<style>
    .gmao-container {
        padding: 20px;
    }

    .gmao-header {
        text-align: center;
        margin-bottom: 30px;
    }

    .gmao-header h2 {
        color: #333;
        font-size: 2em;
        margin-bottom: 10px;
    }

    .gmao-header p {
        color: #666;
        font-size: 1.1em;
    }

    .maintenance-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .maintenance-btn {
        background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        color: white;
        border: none;
        border-radius: 10px;
        padding: 25px;
        font-size: 1.2rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    }

    .maintenance-btn.corrective {
        background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
    }

    .maintenance-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 20px rgba(0,0,0,0.3);
    }

    .corrective-options {
        display: none;
        background: #f8f9fa;
        padding: 25px;
        border-radius: 10px;
        margin-bottom: 30px;
        border: 2px solid #ff9800;
    }

    .corrective-options h3 {
        color: #ff9800;
        font-size: 1.3em;
        margin-bottom: 20px;
        text-align: center;
    }

    .option-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .option-btn {
        background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
        color: white;
        border: none;
        border-radius: 8px;
        padding: 20px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .option-btn.reparation {
        background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    }

    .option-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    }

    .filter-section {
        display: none;
        background: transparent;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 20px;
    }

    .filter-section h4 {
        color: #2e7d32;
        font-size: 1.1em;
        margin-bottom: 15px;
        text-align: center;
    }

    .filter-buttons {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 15px;
    }

    .filter-btn {
        background: transparent;
        color: #333;
        border: 2px solid #ddd;
        border-radius: 8px;
        padding: 15px 20px;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .filter-btn:hover {
        border-color: #4caf50;
        transform: translateY(-2px);
        box-shadow: 0 3px 12px rgba(0,0,0,0.2);
    }

    .filter-btn.active {
        background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);
        color: white;
        border-color: #4caf50;
        box-shadow: 0 4px 15px rgba(76,175,80,0.3);
    }

    .demandes-section {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-top: 30px;
    }

    .demandes-section h3 {
        color: #333;
        font-size: 1.5em;
        margin-bottom: 20px;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 10px;
    }

    .demandes-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    .demandes-table th,
    .demandes-table td {
        padding: 12px;
        text-align: left;
        border-bottom: 1px solid #e0e0e0;
        font-size: 0.9em;
    }

    .demandes-table th {
        background: #f8f9fa;
        color: #333;
        font-weight: 600;
        position: sticky;
        top: 0;
    }

    .demandes-table tr:hover {
        background: #f8f9fa;
    }

    .badge {
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.8em;
        font-weight: 600;
        display: inline-block;
    }

    .badge.urgent {
        background: #ffebee;
        color: #c62828;
    }

    .badge.normal {
        background: #e8f5e9;
        color: #2e7d32;
    }

    .badge.mec {
        background: #e3f2fd;
        color: #1565c0;
    }

    .badge.elec {
        background: #fff3e0;
        color: #e65100;
    }

    .badge.statut-nouveau {
        background: #e3f2fd;
        color: #1976d2;
    }

    .badge.statut-encours {
        background: #fff3e0;
        color: #f57c00;
    }

    .badge.statut-termine {
        background: #e8f5e9;
        color: #388e3c;
    }

    .button-group {
        display: flex;
        gap: 6px;
        justify-content: center;
    }

    .btn-view {
        background: linear-gradient(135deg, #b8d4f1 0%, #d0e4ff 100%);
        color: #1e3a8a;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(184, 212, 241, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-view:hover {
        background: linear-gradient(135deg, #d0e4ff 0%, #b8d4f1 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(184, 212, 241, 0.6);
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #b8e8c4 0%, #d0f5db 100%);
        color: #1e5a2e;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-edit:hover {
        background: linear-gradient(135deg, #d0f5db 0%, #b8e8c4 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
    }

    .btn-delete {
        background: linear-gradient(135deg, #ffc9d4 0%, #ffe0e8 100%);
        color: #be123c;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 201, 212, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-delete:hover {
        background: linear-gradient(135deg, #ffe0e8 0%, #ffc9d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 201, 212, 0.6);
    }

    .btn-repair {
        background: linear-gradient(135deg, #d8b5e8 0%, #e8d4f5 100%);
        color: #6b21a8;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(216, 181, 232, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .btn-repair:hover {
        background: linear-gradient(135deg, #e8d4f5 0%, #d8b5e8 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(216, 181, 232, 0.6);
    }

    /* Checkbox personnalis√© pour √©tat machine */
    .checkbox-etat {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-weight: normal;
        user-select: none;
        vertical-align: middle;
        margin-bottom: 2px;
    }
    
    .checkbox-etat span {
        line-height: 28px;
        display: inline-block;
        vertical-align: middle;
    }

    .checkbox-etat input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 28px;
        height: 28px;
        border: 2px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
        margin-top: -2px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        background: white;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .checkbox-etat input[type="checkbox"]:hover {
        border-color: #e91e63;
    }

    .checkbox-etat input[type="checkbox"]:checked {
        background: white;
        border-color: #e91e63;
    }

    .checkbox-etat input[type="checkbox"]:checked::after {
        content: '‚ùå';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #e91e63;
        font-size: 18px;
        font-weight: bold;
        line-height: 1;
    }

    /* Checkboxes Nature (identiques √† √âtat de la Machine) */
    .checkbox-nature {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        font-weight: normal;
        user-select: none;
        vertical-align: middle;
        margin-bottom: 2px;
    }
    
    .checkbox-nature span {
        line-height: 28px;
        display: inline-block;
        vertical-align: middle;
    }

    .checkbox-nature input[type="checkbox"] {
        appearance: none;
        -webkit-appearance: none;
        width: 28px;
        height: 28px;
        border: 2px solid #ddd;
        border-radius: 4px;
        margin-right: 10px;
        margin-top: -2px;
        cursor: pointer;
        position: relative;
        transition: all 0.3s ease;
        background: white;
        vertical-align: middle;
        flex-shrink: 0;
    }

    .checkbox-nature input[type="checkbox"]:hover {
        border-color: #9c27b0;
    }

    .checkbox-nature input[type="checkbox"]:checked {
        background: white;
        border-color: #9c27b0;
    }

    .checkbox-nature input[type="checkbox"]:checked::after {
        content: '‚úñÔ∏è';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #9c27b0;
        font-size: 18px;
        font-weight: bold;
        line-height: 1;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal.active {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .modal-content {
        background: white;
        border-radius: 15px;
        padding: 30px;
        max-width: 800px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h3 {
        color: #e91e63;
        font-size: 1.8em;
        margin: 0;
    }

    .modal-header h3.reparation {
        color: #9c27b0;
    }

    .modal-header h3.view {
        color: #2196f3;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 1.8em;
        cursor: pointer;
        color: #999;
        line-height: 1;
    }

    .close-btn:hover {
        color: #333;
    }

    .form-group {
        margin-bottom: 20px;
    }

    .form-group label {
        display: block;
        margin-bottom: 8px;
        color: #333;
        font-weight: 600;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 12px;
        border: 2px solid #ddd;
        border-radius: 8px;
        font-size: 1em;
        transition: border-color 0.3s ease;
        font-family: inherit;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #e91e63;
    }
    
    /* Style sp√©cifique pour le modal de r√©paration */
    #reparationModal .form-group input,
    #reparationModal .form-group select,
    #reparationModal .form-group textarea {
        border: 2px solid #ddd;
    }
    
    #reparationModal .form-group input:focus,
    #reparationModal .form-group select:focus,
    #reparationModal .form-group textarea:focus {
        outline: none;
        border-color: #9c27b0;
    }
    
    #reparationModal .select2-container--default .select2-selection--single {
        border: 2px solid #ddd;
    }
    
    #reparationModal .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #9c27b0;
    }

    .form-group textarea {
        resize: vertical;
        min-height: 80px;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
    }

    .form-row-3 {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 10px;
    }

    .articles-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    .articles-section h4 {
        color: #666;
        font-size: 1.1em;
        margin-bottom: 15px;
    }

    .article-row {
        margin-bottom: 10px;
        padding: 10px;
        background: white;
        border-radius: 5px;
    }

    .submit-btn {
        width: 100%;
        background: linear-gradient(135deg, #e91e63 0%, #c2185b 100%);
        color: white;
        border: none;
        padding: 15px;
        border-radius: 8px;
        font-size: 1.1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 3px 10px rgba(0,0,0,0.2);
    }

    .submit-btn.reparation {
        background: linear-gradient(135deg, #9c27b0 0%, #7b1fa2 100%);
    }

    .submit-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    /* Boutons de statut r√©paration */
    .status-btn {
        flex: 1;
        min-width: 150px;
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 1em;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }

    .status-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }

    .status-btn:active {
        transform: translateY(0);
    }

    /* Articles dynamiques */
    .article-dynamic-row {
        display: flex;
        gap: 10px;
        align-items: flex-start;
        margin-bottom: 15px;
        padding: 15px;
        background: #f9f9f9;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .article-dynamic-row .form-group {
        flex: 1;
        margin-bottom: 0;
    }

    .article-dynamic-row .form-group:first-child {
        flex: 2;
    }

    .article-actions {
        display: flex;
        gap: 6px;
        align-items: flex-end;
        margin-top: 24px;
    }

    .btn-add-article-inline {
        background: linear-gradient(135deg, #b8e8c4 0%, #d0f5db 100%);
        color: #1e5a2e;
        padding: 8px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(76, 175, 80, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 36px;
    }

    .btn-add-article-inline:hover {
        background: linear-gradient(135deg, #d0f5db 0%, #b8e8c4 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.6);
    }

    .btn-remove-article {
        background: linear-gradient(135deg, #ffc9d4 0%, #ffe0e8 100%);
        color: #be123c;
        padding: 8px 10px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(255, 201, 212, 0.4);
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 36px;
        height: 36px;
    }

    .btn-remove-article:hover {
        background: linear-gradient(135deg, #ffe0e8 0%, #ffc9d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 201, 212, 0.6);
    }

    .btn-add-article:hover {
        transform: scale(1.05);
        box-shadow: 0 3px 10px rgba(76, 175, 80, 0.4);
    }

    .alert {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .alert.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .alert.active {
        display: block;
    }

    .select2-container {
        width: 100% !important;
    }

    .select2-container--default .select2-selection--single {
        height: 44px;
        border: 2px solid #ddd;
        border-radius: 8px;
    }

    .select2-container--default.select2-container--focus .select2-selection--single {
        border-color: #e91e63;
    }

    .select2-container--default .select2-selection--single .select2-selection__rendered {
        line-height: 40px;
        padding-left: 12px;
    }

    .select2-container--default .select2-selection--single .select2-selection__arrow {
        height: 40px;
    }

    .detail-section {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .detail-section h4 {
        color: #333;
        margin-bottom: 10px;
        border-bottom: 1px solid #ddd;
        padding-bottom: 5px;
    }

    .detail-row {
        display: grid;
        grid-template-columns: 200px 1fr;
        padding: 8px 0;
        border-bottom: 1px solid #e0e0e0;
    }

    .detail-label {
        font-weight: 600;
        color: #666;
    }

    .detail-value {
        color: #333;
    }

    @media (max-width: 768px) {
        .form-row, .form-row-3 {
            grid-template-columns: 1fr;
        }

        .demandes-table {
            font-size: 0.8em;
        }

        .demandes-table th,
        .demandes-table td {
            padding: 8px 4px;
        }

        .action-btns {
            flex-direction: column;
        }
    }
</style>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />

<div class="gmao-container">
    <div class="gmao-header">
        <h2>üõ†Ô∏è GMAO - Gestion de la Maintenance</h2>
        <p>Gestion de la Maintenance Assist√©e par Ordinateur</p>
    </div>

    <!-- Boutons principaux -->
    <div class="maintenance-buttons">
        <button class="maintenance-btn preventive" onclick="selectMaintenanceType('preventive')">
            üîß Maintenance Pr√©ventive
        </button>
        <button class="maintenance-btn corrective" onclick="selectMaintenanceType('corrective')">
            ‚ö†Ô∏è Maintenance Corrective
        </button>
    </div>

    <!-- Options de Maintenance Corrective -->
    <div id="corrective-options" class="corrective-options">
        <h3>Options de Maintenance Corrective</h3>
        <div class="option-buttons">
            <button class="option-btn reclamation" onclick="openDemandeModal()">
                üìù Nouvelle fiche de Demande d'Intervention
            </button>
            <button class="option-btn suivi" onclick="toggleSuiviFiches()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);">
                üìä Suivi des Fiches
            </button>
            <button class="option-btn reparation" onclick="openReparationModalDirect()">
                üîß Nouvelle fiche de R√©paration
            </button>
        </div>
    </div>

    <!-- Filtres pour le suivi des fiches -->
    <div id="filter-section" class="filter-section">
        <h4>üîç Filtrer par type de fiche</h4>
        <div class="filter-buttons">
            <button class="filter-btn" onclick="filterFiches('demandes')">
                üìù Fiches de Demande d'Intervention
            </button>
            <button class="filter-btn" onclick="filterFiches('reparations')">
                üîß Fiches de R√©paration
            </button>
        </div>
    </div>

    <!-- Liste des Demandes d'Intervention -->
    <div class="demandes-section" style="display: none;">
        <h3 id="demandes-title" style="display: none;">üìã Fiches de Demande d'Intervention</h3>
        <div id="demandes-loading" style="text-align: center; padding: 20px; color: #666;">
            Chargement des demandes...
        </div>
        <div style="overflow-x: auto;">
            <table class="demandes-table" id="demandes-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date Demande</th>
                        <th>Op√©rateur Demandeur</th>
                        <th>Machine</th>
                        <th>√âtat de la Machine</th>
                        <th>Description du Probl√®me</th>
                        <th>Statut Demande</th>
                        <th>Statut R√©paration</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="demandes-tbody">
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal R√©clamation -->
<div id="demandeModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìù Fiche de Demande d'Intervention</h3>
            <button class="close-btn" onclick="closeDemandeModal()">&times;</button>
        </div>

        <div id="alert-demande" class="alert"></div>

        <form id="demandeForm">
            <div class="form-group">
                <label for="dte_dem_in">Date et Heure *</label>
                <input type="datetime-local" id="dte_dem_in" name="dte_dem_in" required readonly style="background-color: #f0f0f0; cursor: not-allowed;">
            </div>

            <div class="form-group">
                <label for="operateur_reclamant">Op√©rateur Demandeur *</label>
                <input type="text" 
                       id="operateur_reclamant" 
                       name="operateur_reclamant" 
                       list="operateurs_list"
                       placeholder="-- Tapez pour rechercher un op√©rateur --"
                       autocomplete="off"
                       data-matricule=""
                       required>
                <datalist id="operateurs_list">
                    {% for op in operateurs %}
                    <option value="{{ op.nom }} {{ op.prenom }} (Matricule: {{ op.matricule }})" 
                            data-matricule="{{ op.matricule }}">
                    </option>
                    {% endfor %}
                </datalist>
                <input type="hidden" id="matr_op_dem" name="matr_op_dem">
                <small style="color: #666; font-size: 0.9em;">Tapez un nom ou pr√©nom pour rechercher</small>
            </div>

            <div class="form-group">
                <label for="machine_input">Machine *</label>
                <input type="text" 
                       id="machine_input" 
                       name="machine_input" 
                       list="machines_list"
                       placeholder="-- Tapez pour rechercher une machine --"
                       autocomplete="off"
                       required>
                <datalist id="machines_list">
                    {% for machine in machines %}
                    <option value="{{ machine.nom }}">
                    </option>
                    {% endfor %}
                </datalist>
                <small style="color: #666; font-size: 0.9em;">Tapez le nom de la machine pour rechercher</small>
            </div>

            <div class="form-group">
                <label>√âtat de la Machine *</label>
                <div style="display: flex; gap: 30px; margin-top: 10px;">
                    <label class="checkbox-etat">
                        <input type="checkbox" id="etat_avec_arret" value="1" data-etat="avec">
                        <span>Avec Arr√™t</span>
                    </label>
                    <label class="checkbox-etat">
                        <input type="checkbox" id="etat_sans_arret" value="0" data-etat="sans">
                        <span>Sans Arr√™t</span>
                    </label>
                </div>
                <input type="hidden" id="id_emach_value" name="id_emach" required>
                <small style="color: #666; font-size: 0.9em;">Indiquez si la machine est arr√™t√©e ou fonctionne encore</small>
            </div>

            <div class="form-group">
                <label for="dem_in">Description du Probl√®me</label>
                <textarea id="dem_in" name="dem_in" placeholder="D√©crivez le probl√®me rencontr√©..."></textarea>
            </div>

            <button type="submit" class="submit-btn">üíæ Enregistrer la fiche de Demande d'Intervention</button>
        </form>
    </div>
</div>

<!-- Modal R√©paration -->
<div id="reparationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="reparation">üîß Nouvelle fiche de R√©paration</h3>
            <button class="close-btn" onclick="closeReparationModal()">&times;</button>
        </div>

        <div id="alert-reparation" class="alert"></div>

        <input type="hidden" id="demande_id_rep" value="">

        <!-- S√©lection de la demande (visible seulement pour Nouvelle fiche de R√©paration) -->
        <div id="selection-demande" class="form-group" style="display: none;">
            <label for="select_demande_input">S√©lectionner une demande d'intervention</label>
            <input type="text" 
                   id="select_demande_input" 
                   name="select_demande_input" 
                   list="demandes_list"
                   placeholder="-- Tapez pour rechercher une demande --"
                   autocomplete="off"
                   data-demande-id="">
            <datalist id="demandes_list">
                <!-- Sera rempli dynamiquement -->
            </datalist>
            <input type="hidden" id="select_demande_hidden" name="select_demande_hidden">
            <small style="color: #666; font-size: 0.9em;">S√©lectionnez la demande pour laquelle vous souhaitez enregistrer une r√©paration</small>
        </div>

        <form id="reparationForm">
            <!-- 1. Machine Concern√©e -->
            <div class="form-group" id="machine-reparation-group">
                <label for="machine_reparation">Machine Concern√©e *</label>
                <input type="text" 
                       id="machine_reparation" 
                       name="machine_reparation" 
                       list="machines_list_rep"
                       placeholder="-- Tapez pour rechercher une machine --"
                       autocomplete="off">
                <datalist id="machines_list_rep">
                    {% for machine in machines %}
                    <option value="{{ machine.nom }}">
                    </option>
                    {% endfor %}
                </datalist>
                <small style="color: #666; font-size: 0.9em;">Machine sur laquelle la r√©paration sera effectu√©e</small>
            </div>

            <!-- 2. Intervenant -->
            <div class="form-group">
                <label for="intervenant_input">Intervenant *</label>
                <input type="text" 
                       id="intervenant_input" 
                       name="intervenant_input" 
                       list="intervenants_list"
                       placeholder="-- Tapez pour rechercher un intervenant --"
                       autocomplete="off"
                       data-matricule=""
                       required>
                <datalist id="intervenants_list">
                    {% for op in operateurs %}
                    <option value="{{ op.nom }} {{ op.prenom }} (Matricule: {{ op.matricule }})" 
                            data-matricule="{{ op.matricule }}">
                    </option>
                    {% endfor %}
                </datalist>
                <input type="hidden" id="mat_inter" name="mat_inter">
            </div>

            <!-- 3. Date/Heure D√©but, Fin et Temps R√©el -->
            <div class="form-row" style="grid-template-columns: 1fr 1fr 1fr;">
                <div class="form-group">
                    <label for="dte_deb">Date/Heure D√©but *</label>
                    <input type="datetime-local" id="dte_deb" name="dte_deb" required>
                </div>

                <div class="form-group">
                    <label for="dte_fin">Date/Heure Fin</label>
                    <input type="datetime-local" id="dte_fin" name="dte_fin">
                </div>

                <div class="form-group">
                    <label for="tps_reel">Temps R√©el</label>
                    <input type="text" id="tps_reel" name="tps_reel" placeholder="00:00" pattern="[0-9]{1,2}:[0-5][0-9]" maxlength="5">
                    <small style="color: #666; font-size: 0.85em;">Format HH:MM (ex: 01:30 = 1h30)</small>
                </div>
            </div>

            <!-- 5. Articles / Pi√®ces D√©tach√©es -->
            <div class="articles-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h4 style="margin: 0;">üî© Articles / Pi√®ces D√©tach√©es</h4>
                    <button type="button" class="btn-add-article" onclick="ajouterLigneArticle()" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                        ‚ûï Ajouter un article
                    </button>
                </div>
                
                <datalist id="articles_list_rep">
                    {% for article in articles %}
                    <option value="{{ article.designation }}" data-id="{{ article.id }}">
                    </option>
                    {% endfor %}
                </datalist>
                
                <div id="articles-container">
                    <!-- Les lignes d'articles seront ajout√©es dynamiquement -->
                </div>
                
                <p id="no-articles-message" style="text-align: center; color: #999; font-style: italic; padding: 20px;">
                    Aucun article ajout√©. Cliquez sur "‚ûï Ajouter un article" pour commencer.
                </p>
            </div>

            <!-- 6. Nature de la r√©paration -->
            <div class="form-group">
                <label>Nature *</label>
                <div style="display: flex; gap: 30px; margin-top: 10px;">
                    <label class="checkbox-nature">
                        <input type="checkbox" id="nature_mecanique" value="Mec" data-nature="mec">
                        <span>M√©canique</span>
                    </label>
                    <label class="checkbox-nature">
                        <input type="checkbox" id="nature_electrique" value="Elec" data-nature="elec">
                        <span>√âlectrique</span>
                    </label>
                </div>
                <input type="hidden" id="nat_rep_value" name="nat_rep" required>
                <small style="color: #666; font-size: 0.9em;">Type de r√©paration effectu√©e</small>
            </div>

            <!-- Boutons de statut -->
            <div class="form-group status-buttons-container" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; justify-content: center;">
                    <button type="button" class="status-btn btn-annule" onclick="enregistrerReparation('annule')" style="background: linear-gradient(135deg, #f44336 0%, #d32f2f 100%);">
                        ‚ùå Annul√©
                    </button>
                    <button type="button" class="status-btn btn-cloturer" onclick="enregistrerReparation('cloturer')" style="background: linear-gradient(135deg, #4caf50 0%, #388e3c 100%);">
                        ‚úÖ Cl√¥turer
                    </button>
                    <button type="button" class="status-btn btn-en-attente" onclick="enregistrerReparation('en_attente')" style="background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);">
                        ‚è∏Ô∏è En Attente
                    </button>
                    <button type="button" class="status-btn btn-temporaire" onclick="enregistrerReparation('temporaire')" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                        ‚è±Ô∏è Temporaire
                    </button>
                </div>
            </div>
            
            <!-- Bouton Fermer pour mode lecture seule -->
            <div class="form-group close-button-container" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 2px solid #e0e0e0;">
                <div style="display: flex; justify-content: center;">
                    <button type="button" class="submit-btn" onclick="closeReparationModal()" style="background: linear-gradient(135deg, #757575 0%, #616161 100%); color: white; padding: 12px 30px;">
                        Fermer
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal D√©tails -->
<div id="detailsModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>üìù Fiche de Demande d'Intervention</h3>
            <button class="close-btn" onclick="closeDetailsModal()">&times;</button>
        </div>

        <div id="details-content">
            <!-- Le contenu sera charg√© dynamiquement avec le formulaire en lecture seule -->
        </div>

        <div style="display: flex; gap: 15px; justify-content: center; padding: 20px; border-top: 2px solid #e0e0e0; margin-top: 20px;">
            <button class="submit-btn" onclick="closeDetailsModal()" style="background: linear-gradient(135deg, #757575 0%, #616161 100%);">
                Fermer
            </button>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    // S√©lection du type de maintenance
    function selectMaintenanceType(type) {
        if (type === 'corrective') {
            // Toggle: si d√©j√† visible, on cache, sinon on affiche
            if ($('#corrective-options').is(':visible')) {
                $('#corrective-options').slideUp(300);
                $('.demandes-section').slideUp(300);
            } else {
                $('#corrective-options').slideDown(300);
                // Ne pas afficher automatiquement la liste des demandes
            }
        } else if (type === 'preventive') {
            // Cacher les sections correctives si elles sont visibles
            $('#corrective-options').slideUp(300);
            $('.demandes-section').slideUp(300);
            alert('Maintenance Pr√©ventive - Fonctionnalit√© en cours de d√©veloppement');
        }
    }

    // Toggle pour le suivi des fiches
    function toggleSuiviFiches() {
        if ($('#filter-section').is(':visible')) {
            $('#filter-section').slideUp(300);
            $('.demandes-section').slideUp(300);
        } else {
            $('#filter-section').slideDown(300);
            // Ne pas afficher automatiquement la liste - elle s'affichera au clic sur un filtre
        }
    }

    // Filtrer les fiches par type
    function filterFiches(type) {
        const clickedBtn = event.target;
        const isAlreadyActive = clickedBtn.classList.contains('active');
        
        // Si le bouton cliqu√© est d√©j√† actif, on masque la liste
        if (isAlreadyActive) {
            $('.demandes-section').slideUp(300);
            clickedBtn.classList.remove('active');
            return;
        }
        
        // Sinon, on met √† jour le style des boutons
        $('.filter-btn').removeClass('active');
        clickedBtn.classList.add('active');
        
        // Afficher la section des demandes
        if (!$('.demandes-section').is(':visible')) {
            $('.demandes-section').slideDown(300);
        }
        
        if (type === 'demandes') {
            // Afficher les fiches de demande d'intervention
            // Charger les demandes seulement au premier affichage
            if (!window.demandesLoaded) {
                loadDemandes();
                window.demandesLoaded = true;
            } else {
                loadDemandes();
            }
        } else if (type === 'reparations') {
            // Afficher les fiches de r√©paration
            loadReparations();
        }
    }

    // Gestion des modals
    function openDemandeModal() {
        // R√©initialiser le formulaire
        document.getElementById('demandeForm').reset();
        delete document.getElementById('demandeForm').dataset.demandeId;
        
        // Vider les champs
        $('#operateur_reclamant').val('').attr('data-matricule', '');
        $('#matr_op_dem').val('');
        $('#machine_input').val('');
        $('.checkbox-etat input[type="checkbox"]').prop('checked', false);
        $('#id_emach_value').val('');
        
        // Mettre la date et heure actuelles
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('dte_dem_in').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Ouvrir le modal
        document.getElementById('demandeModal').classList.add('active');
        
        // Placer le curseur automatiquement dans le champ Op√©rateur Demandeur
        setTimeout(function() {
            $('#operateur_reclamant').focus();
        }, 300);
    }

    function closeDemandeModal() {
        document.getElementById('demandeModal').classList.remove('active');
        document.getElementById('demandeForm').reset();
        delete document.getElementById('demandeForm').dataset.demandeId;
        $('#operateur_reclamant').val('').attr('data-matricule', '');
        $('#matr_op_dem').val('');
        $('#machine_input').val('');
        $('.checkbox-etat input[type="checkbox"]').prop('checked', false);
        $('#id_emach_value').val('');
        $('#alert-demande').removeClass('active');
    }

    function openReparationModal(demandeId) {
        // R√©initialiser le formulaire
        document.getElementById('reparationForm').reset();
        reparationEnCoursId = null;
        
        // Mode: Depuis la liste - Cacher la s√©lection de demande
        $('#selection-demande').hide();
        
        // R√©initialiser le champ machine
        $('#machine_reparation').prop('readonly', false).prop('required', true).css('background-color', 'white');
        
        // Charger les infos de la demande pour pr√©-remplir
        $.ajax({
            url: '/projet16/api/demande/' + demandeId,
            method: 'GET',
            success: function(demande) {
                // Si c'est une fiche "En cours" (ID_StatRep = 0), utiliser son ID
                if (demande.statut_reparation_id === 0) {
                    reparationEnCoursId = demande.id;
                }
                
                // Pr√©-remplir la machine (non modifiable car depuis une demande existante)
                $('#machine_reparation').val(demande.postes_reel || '').prop('readonly', true).css('background-color', '#f0f0f0');
                $('#machine-reparation-group small').text('Machine de la demande s√©lectionn√©e (non modifiable)');
                
                // Pr√©-remplir la nature si elle existe dans la demande
                if (demande.nat) {
                    $('.checkbox-nature input[type="checkbox"]').prop('checked', false);
                    if (demande.nat === 'Mec') {
                        $('#nature_mecanique').prop('checked', true);
                    } else if (demande.nat === 'Elec') {
                        $('#nature_electrique').prop('checked', true);
                    }
                    $('#nat_rep_value').val(demande.nat);
                }
                
                // Pr√©-remplir l'intervenant si une r√©paration existe d√©j√†
                if (demande.intervenant && demande.mat_inter) {
                    const texteIntervenant = demande.intervenant + ' (Matricule: ' + demande.mat_inter + ')';
                    $('#intervenant_input').val(texteIntervenant).attr('data-matricule', demande.mat_inter);
                    $('#mat_inter').val(demande.mat_inter);
                }
                
                // Pr√©-remplir les dates si une r√©paration existe d√©j√†
                if (demande.dte_deb) {
                    $('#dte_deb').val(demande.dte_deb);
                } else {
                    // Mettre la date et heure actuelles par d√©faut
                    const now = new Date();
                    const year = now.getFullYear();
                    const month = String(now.getMonth() + 1).padStart(2, '0');
                    const day = String(now.getDate()).padStart(2, '0');
                    const hours = String(now.getHours()).padStart(2, '0');
                    const minutes = String(now.getMinutes()).padStart(2, '0');
                    $('#dte_deb').val(`${year}-${month}-${day}T${hours}:${minutes}`);
                }
                if (demande.dte_fin) {
                    $('#dte_fin').val(demande.dte_fin);
                }
                
                // Si machine et intervenant sont remplis, cr√©er la fiche en cours
                if (demande.postes_reel && demande.mat_inter) {
                    checkAndCreateFicheEnCours();
                }
                
                // Pr√©-remplir le temps r√©el si disponible (format HH:MM)
                if (demande.tps_reel) {
                    $('#tps_reel').val(demande.tps_reel);
                }
                
                // Charger les articles de la fiche
                chargerArticlesDeFiche(demandeId);
            }
        });
        
        document.getElementById('demande_id_rep').value = demandeId;
        
        // Ouvrir le modal
        document.getElementById('reparationModal').classList.add('active');
    }

    function openReparationModalDirect() {
        // R√©initialiser le formulaire
        document.getElementById('reparationForm').reset();
        reparationEnCoursId = null;
        
        // Mode: Depuis "Nouvelle fiche" - Afficher la s√©lection de demande
        $('#selection-demande').show();
        document.getElementById('demande_id_rep').value = '';
        
        // Rendre le champ machine modifiable et obligatoire
        $('#machine_reparation').val('').prop('readonly', false).prop('required', true).css('background-color', 'white');
        $('#machine-reparation-group small').text('Machine sur laquelle la r√©paration sera effectu√©e');
        
        // Charger la liste des demandes non cl√¥tur√©es
        $.ajax({
            url: '/projet16/api/demandes',
            method: 'GET',
            success: function(demandes) {
                const datalist = $('#demandes_list');
                datalist.empty();
                
                // Filtrer pour n'afficher que les demandes non cl√¥tur√©es (ID_StatDemIn != 1)
                const demandesNonCloturees = demandes.filter(d => d.statut_demande_id !== 1);
                
                if (demandesNonCloturees.length === 0) {
                    // Afficher un message si aucune demande
                    $('#select_demande_input').attr('placeholder', 'Aucune demande disponible');
                } else {
                    demandesNonCloturees.forEach(function(demande) {
                        const dateStr = demande.dte_dem_in ? new Date(demande.dte_dem_in).toLocaleString('fr-FR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        }) : '';
                        const statutBadge = demande.statut_demande || 'Non Clotur√©e';
                        const texte = `ID ${demande.id} - ${dateStr} - ${demande.oper_dem || ''} - ${demande.postes_reel || ''} - [${statutBadge}]`;
                        
                        datalist.append(`<option value="${texte}" 
                            data-demande-id="${demande.id}" 
                            data-machine="${demande.postes_reel || ''}" 
                            data-nature="${demande.nat || ''}">
                        </option>`);
                    });
                }
            },
            error: function() {
                alert('Erreur lors du chargement des demandes');
            }
        });
        
        // Mettre la date et heure actuelles
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('dte_deb').value = `${year}-${month}-${day}T${hours}:${minutes}`;
        
        // Ouvrir le modal
        document.getElementById('reparationModal').classList.add('active');
    }

    function openReparationDetailsModal(reparationId) {
        // Charger les donn√©es de la r√©paration
        $.ajax({
            url: '/projet16/api/demande/' + reparationId,
            method: 'GET',
            success: function(demande) {
                // Cacher la s√©lection de demande
                $('#selection-demande').hide();
                
                // Rendre tous les champs en lecture seule
                $('#reparationForm input, #reparationForm textarea, #reparationForm select').prop('readonly', true).prop('disabled', true).css('background-color', '#f0f0f0').css('cursor', 'not-allowed');
                $('#reparationForm input[type="checkbox"]').prop('disabled', true);
                
                // Masquer les boutons d'action
                $('.status-buttons-container').hide();
                $('.btn-add-article').hide();
                $('.btn-remove-article').hide();
                $('.btn-add-article-inline').hide();
                
                // Afficher le bouton Fermer
                $('.close-button-container').show();
                
                // Changer le titre du modal
                $('#reparationModal .modal-header h3').text('üîß Fiche de R√©paration');
                
                // Pr√©-remplir tous les champs
                $('#machine_reparation').val(demande.postes_reel || '').prop('readonly', true).css('background-color', '#f0f0f0');
                
                // Intervenant
                if (demande.intervenant && demande.mat_inter) {
                    const texteIntervenant = demande.intervenant + ' (Matricule: ' + demande.mat_inter + ')';
                    $('#intervenant_input').val(texteIntervenant).attr('data-matricule', demande.mat_inter);
                    $('#mat_inter').val(demande.mat_inter);
                }
                
                // Dates
                if (demande.dte_deb) {
                    $('#dte_deb').val(demande.dte_deb);
                }
                if (demande.dte_fin) {
                    $('#dte_fin').val(demande.dte_fin);
                }
                
                // Temps r√©el
                if (demande.tps_reel) {
                    $('#tps_reel').val(demande.tps_reel);
                }
                
                // Nature
                if (demande.nat) {
                    $('.checkbox-nature input[type="checkbox"]').prop('checked', false);
                    if (demande.nat === 'Mec') {
                        $('#nature_mecanique').prop('checked', true);
                    } else if (demande.nat === 'Elec') {
                        $('#nature_electrique').prop('checked', true);
                    }
                    $('#nat_rep_value').val(demande.nat);
                }
                
                // Charger les articles
                chargerArticlesDeFiche(reparationId);
                
                // Masquer les boutons d'action des articles apr√®s chargement
                setTimeout(function() {
                    $('.btn-remove-article').hide();
                    $('.btn-add-article-inline').hide();
                    $('#articles-container input, #articles-container select').prop('readonly', true).prop('disabled', true).css('background-color', '#f0f0f0').css('cursor', 'not-allowed');
                }, 500);
                
                // Stocker l'ID pour r√©f√©rence
                document.getElementById('demande_id_rep').value = reparationId;
                
                // Ouvrir le modal
                document.getElementById('reparationModal').classList.add('active');
            },
            error: function() {
                alert('Erreur lors du chargement de la r√©paration');
            }
        });
    }

    function closeReparationModal() {
        document.getElementById('reparationModal').classList.remove('active');
        document.getElementById('reparationForm').reset();
        document.getElementById('demande_id_rep').value = '';
        
        // R√©initialiser les champs en mode √©dition
        $('#reparationForm input, #reparationForm textarea, #reparationForm select').prop('readonly', false).prop('disabled', false).css('background-color', '').css('cursor', '');
        $('#reparationForm input[type="checkbox"]').prop('disabled', false);
        $('.status-buttons-container').show();
        $('.btn-add-article').show();
        $('.close-button-container').hide();
        $('#reparationModal .modal-header h3').text('üîß Nouvelle fiche de R√©paration');
        $('#select_demande_input').val('').attr('data-demande-id', '');
        $('#select_demande_hidden').val('');
        $('#selection-demande').hide();
        $('#machine_reparation').val('').prop('readonly', false).prop('required', false).css('background-color', 'white');
        $('#intervenant_input').val('').attr('data-matricule', '');
        $('#mat_inter').val('');
        $('.checkbox-nature input[type="checkbox"]').prop('checked', false);
        $('#nat_rep_value').val('');
        $('#alert-reparation').removeClass('active');
        $('#tps_reel').val('');
        // Vider les articles
        $('#articles-container').empty();
        $('#no-articles-message').show();
        articleCounter = 0;
        reparationEnCoursId = null; // R√©initialiser l'ID de la fiche en cours
    }

    // Variable globale pour stocker l'ID de la demande en cours de visualisation
    let currentDemandeId = null;

    function openDetailsModal(demandeId) {
        currentDemandeId = demandeId;
        $.ajax({
            url: '/projet16/api/demande/' + demandeId,
            method: 'GET',
            success: function(demande) {
                // Formater la date pour l'input datetime-local
                let dateValue = '';
                if (demande.dte_dem_in) {
                    const date = new Date(demande.dte_dem_in);
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    dateValue = `${year}-${month}-${day}T${hours}:${minutes}`;
                }
                
                // D√©terminer l'√©tat de la machine
                let etatAvecArretChecked = '';
                let etatSansArretChecked = '';
                if (demande.id_emach === 1) {
                    etatAvecArretChecked = 'checked';
                } else if (demande.id_emach === 0) {
                    etatSansArretChecked = 'checked';
                }
                
                // G√©n√©rer le formulaire identique au formulaire de saisie mais en lecture seule
                let html = '<form id="detailsForm" style="pointer-events: none;">';
                
                // Date et Heure
                html += '<div class="form-group">';
                html += '<label for="details_dte_dem_in">Date et Heure *</label>';
                html += '<input type="datetime-local" id="details_dte_dem_in" value="' + dateValue + '" readonly style="background-color: #f0f0f0; cursor: not-allowed;">';
                html += '</div>';
                
                // Op√©rateur Demandeur
                html += '<div class="form-group">';
                html += '<label for="details_operateur">Op√©rateur Demandeur *</label>';
                html += '<input type="text" id="details_operateur" value="' + (demande.oper_dem || '') + '" readonly style="background-color: #f0f0f0; cursor: not-allowed;">';
                html += '<small style="color: #666; font-size: 0.9em;">Tapez un nom ou pr√©nom pour rechercher</small>';
                html += '</div>';
                
                // Machine
                html += '<div class="form-group">';
                html += '<label for="details_machine">Machine *</label>';
                html += '<input type="text" id="details_machine" value="' + (demande.postes_reel || '') + '" readonly style="background-color: #f0f0f0; cursor: not-allowed;">';
                html += '<small style="color: #666; font-size: 0.9em;">Tapez le nom de la machine pour rechercher</small>';
                html += '</div>';
                
                // √âtat de la Machine
                html += '<div class="form-group">';
                html += '<label>√âtat de la Machine *</label>';
                html += '<div style="display: flex; gap: 30px; margin-top: 10px;">';
                html += '<label class="checkbox-etat">';
                html += '<input type="checkbox" id="details_etat_avec_arret" ' + etatAvecArretChecked + ' disabled>';
                html += '<span>Avec Arr√™t</span>';
                html += '</label>';
                html += '<label class="checkbox-etat">';
                html += '<input type="checkbox" id="details_etat_sans_arret" ' + etatSansArretChecked + ' disabled>';
                html += '<span>Sans Arr√™t</span>';
                html += '</label>';
                html += '</div>';
                html += '<small style="color: #666; font-size: 0.9em;">Indiquez si la machine est arr√™t√©e ou fonctionne encore</small>';
                html += '</div>';
                
                // Description du Probl√®me
                html += '<div class="form-group">';
                html += '<label for="details_dem_in">Description du Probl√®me</label>';
                html += '<textarea id="details_dem_in" readonly style="background-color: #f0f0f0; cursor: not-allowed; resize: none; min-height: 100px;">' + (demande.dem_in || '') + '</textarea>';
                html += '</div>';
                
                html += '</form>';
                
                $('#details-content').html(html);
                document.getElementById('detailsModal').classList.add('active');
            },
            error: function() {
                alert('Erreur lors du chargement des d√©tails');
            }
        });
    }
    
    function enregistrerFichePDF() {
        if (!currentDemandeId) {
            alert('Aucune fiche √† enregistrer');
            return;
        }
        // Cr√©er un lien de t√©l√©chargement sans affecter le popup
        const link = document.createElement('a');
        link.href = '/projet16/api/demande/' + currentDemandeId + '/pdf';
        link.download = 'fiche_demande_' + currentDemandeId + '.pdf';
        link.style.display = 'none';
        document.body.appendChild(link);
        link.click();
        // Nettoyer imm√©diatement
        setTimeout(function() {
            document.body.removeChild(link);
        }, 100);
        // Le popup reste ouvert et intact, aucun changement de focus
    }
    
    function imprimerFiche() {
        if (!currentDemandeId) {
            alert('Aucune fiche √† imprimer');
            return;
        }
        // G√©n√©rer le PDF et l'ouvrir pour impression sans affecter le popup
        const pdfUrl = '/projet16/api/demande/' + currentDemandeId + '/pdf';
        fetch(pdfUrl)
            .then(response => response.blob())
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                // Cr√©er un iframe compl√®tement cach√© pour l'impression
                const iframe = document.createElement('iframe');
                iframe.style.position = 'fixed';
                iframe.style.left = '-9999px';
                iframe.style.top = '-9999px';
                iframe.style.width = '1px';
                iframe.style.height = '1px';
                iframe.style.border = 'none';
                iframe.style.opacity = '0';
                iframe.style.pointerEvents = 'none';
                iframe.src = url;
                document.body.appendChild(iframe);
                
                iframe.onload = function() {
                    setTimeout(function() {
                        try {
                            iframe.contentWindow.focus();
                            iframe.contentWindow.print();
                        } catch (e) {
                            console.error('Erreur lors de l\'impression:', e);
                            // Fallback: ouvrir dans un nouvel onglet si l'impression directe √©choue
                            const printWindow = window.open(url, '_blank');
                            if (printWindow) {
                                printWindow.onload = function() {
                                    setTimeout(function() {
                                        printWindow.print();
                                    }, 500);
                                };
                            }
                        }
                        // Nettoyer apr√®s impression
                        setTimeout(function() {
                            if (iframe.parentNode) {
                                document.body.removeChild(iframe);
                            }
                            window.URL.revokeObjectURL(url);
                        }, 2000);
                    }, 500);
                };
                
                // Gestion d'erreur si le chargement √©choue
                iframe.onerror = function() {
                    console.error('Erreur lors du chargement du PDF');
                    document.body.removeChild(iframe);
                    window.URL.revokeObjectURL(url);
                    alert('Erreur lors de la g√©n√©ration du PDF pour impression');
                };
            })
            .catch(error => {
                console.error('Erreur lors de la g√©n√©ration du PDF:', error);
                alert('Erreur lors de la g√©n√©ration du PDF pour impression');
            });
    }

    function closeDetailsModal() {
        document.getElementById('detailsModal').classList.remove('active');
    }

    // Modifier une demande
    function modifierDemande(demandeId) {
        $.ajax({
            url: '/projet16/api/demande/' + demandeId,
            method: 'GET',
            success: function(demande) {
                // R√©initialiser le formulaire
                document.getElementById('demandeForm').reset();
                
                // Remplir le champ date (non modifiable)
                document.getElementById('dte_dem_in').value = demande.dte_dem_in ? demande.dte_dem_in : '';
                
                // Pr√©-remplir l'op√©rateur
                if (demande.matr_op_dem && demande.oper_dem) {
                    const texteOperateur = `${demande.oper_dem} (Matricule: ${demande.matr_op_dem})`;
                    $('#operateur_reclamant').val(texteOperateur).attr('data-matricule', demande.matr_op_dem);
                    $('#matr_op_dem').val(demande.matr_op_dem);
                }
                
                // Pr√©-remplir la machine (juste le nom)
                if (demande.postes_reel) {
                    $('#machine_input').val(demande.postes_reel);
                }
                
                // Pr√©-s√©lectionner l'√©tat de la machine (0=Sans Arr√™t, 1=Avec Arr√™t)
                $('.checkbox-etat input[type="checkbox"]').prop('checked', false);
                if (demande.id_emach !== null && demande.id_emach !== undefined) {
                    if (demande.id_emach == 1) {
                        $('#etat_avec_arret').prop('checked', true);
                    } else if (demande.id_emach == 0) {
                        $('#etat_sans_arret').prop('checked', true);
                    }
                    $('#id_emach_value').val(demande.id_emach);
                }
                
                // Remplir les autres champs
                document.getElementById('dem_in').value = demande.dem_in || '';
                
                // Stocker l'ID pour la mise √† jour
                document.getElementById('demandeForm').dataset.demandeId = demandeId;
                
                // Ouvrir le modal
                document.getElementById('demandeModal').classList.add('active');
            },
            error: function() {
                alert('Erreur lors du chargement de la demande');
            }
        });
    }

    // Supprimer une demande
    function supprimerDemande(demandeId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer cette demande d\'intervention ? Cette action supprimera √©galement les informations de r√©paration associ√©es.')) {
            $.ajax({
                url: '/projet16/api/delete_demande/' + demandeId,
                method: 'DELETE',
                success: function() {
                    alert('Demande supprim√©e avec succ√®s');
                    // Recharger la liste actuellement affich√©e
                    const activeFilter = $('.filter-btn.active');
                    if (activeFilter.length > 0) {
                        const filterType = activeFilter.attr('onclick').includes('demandes') ? 'demandes' : 'reparations';
                        if (filterType === 'demandes') {
                            loadDemandes();
                        } else {
                            loadReparations();
                        }
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur lors de la suppression';
                    alert(error);
                }
            });
        }
    }

    // Supprimer une r√©paration (remet √† NULL les champs de r√©paration, la demande reste)
    function supprimerReparation(demandeId) {
        if (confirm('√ätes-vous s√ªr de vouloir supprimer les informations de r√©paration ? La demande d\'intervention restera enregistr√©e.')) {
            $.ajax({
                url: '/projet16/api/delete_reparation/' + demandeId,
                method: 'DELETE',
                success: function() {
                    alert('Informations de r√©paration supprim√©es avec succ√®s');
                    // Recharger la liste actuellement affich√©e
                    const activeFilter = $('.filter-btn.active');
                    if (activeFilter.length > 0) {
                        const filterType = activeFilter.attr('onclick').includes('demandes') ? 'demandes' : 'reparations';
                        if (filterType === 'demandes') {
                            loadDemandes();
                        } else {
                            loadReparations();
                        }
                    }
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur lors de la suppression';
                    alert(error);
                }
            });
        }
    }

    // Gestion des alertes
    function showAlert(elementId, message, type) {
        const alert = document.getElementById(elementId);
        alert.textContent = message;
        alert.className = `alert ${type} active`;
    }

    // Charger les demandes
    function loadDemandes() {
        $.ajax({
            url: '/projet16/api/demandes',
            method: 'GET',
            success: function(demandes) {
                $('#demandes-loading').hide();
                $('#demandes-table').show();
                
                // Restaurer l'en-t√™te du tableau pour les demandes d'intervention
                const thead = $('#demandes-table thead tr');
                thead.html(`
                    <th>ID</th>
                    <th>Date Demande</th>
                    <th>Op√©rateur Demandeur</th>
                    <th>Machine</th>
                    <th>√âtat de la Machine</th>
                    <th>Description du Probl√®me</th>
                    <th>Statut Demande</th>
                    <th>Statut R√©paration</th>
                    <th>Actions</th>
                `);
                
                const tbody = $('#demandes-tbody');
                tbody.empty();
                
                // Filtrer pour n'afficher que les demandes d'intervention
                // Une demande d'intervention est identifi√©e par : MatrOpDem, OperDem, DteDemIn renseign√©s
                const demandesFiltrees = demandes.filter(function(d) {
                    return d.matr_op_dem && d.matr_op_dem !== '' && 
                           d.oper_dem && d.oper_dem !== '' && 
                           d.dte_dem_in && d.dte_dem_in !== '';
                });
                
                if (demandesFiltrees.length === 0) {
                    tbody.append('<tr><td colspan="9" style="text-align: center; color: #666;">Aucune demande d\'intervention enregistr√©e</td></tr>');
                    return;
                }
                
                demandesFiltrees.forEach(function(demande) {
                    let statutDemClass = 'statut-nouveau';
                    if (demande.statut_demande_id === 1) statutDemClass = 'statut-encours';
                    if (demande.statut_demande_id === 2) statutDemClass = 'statut-termine';
                    const statutDemBadge = '<span class="badge ' + statutDemClass + '">' + demande.statut_demande + '</span>';
                    
                    let statutRepClass = 'statut-nouveau';
                    if (demande.statut_reparation_id === 1) statutRepClass = 'statut-encours';
                    if (demande.statut_reparation_id === 2) statutRepClass = 'statut-termine';
                    const statutRepBadge = '<span class="badge ' + statutRepClass + '">' + demande.statut_reparation + '</span>';
                    
                    const dateStr = demande.dte_dem_in ? new Date(demande.dte_dem_in).toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    
                    tbody.append(`
                        <tr>
                            <td>${demande.id}</td>
                            <td>${dateStr}</td>
                            <td>${demande.oper_dem || '-'}</td>
                            <td>${demande.postes_reel || '-'}</td>
                            <td>${demande.etat_machine || '-'}</td>
                            <td>${demande.dem_in || '-'}</td>
                            <td>${statutDemBadge}</td>
                            <td>${statutRepBadge}</td>
                            <td>
                                <div class="button-group">
                                    <button class="btn-view" onclick="openDetailsModal(${demande.id})" title="Voir d√©tails">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                    <button class="btn-repair" onclick="openReparationModal(${demande.id})" title="Ajouter/Modifier r√©paration">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-edit" onclick="modifierDemande(${demande.id})" title="Modifier la demande">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-delete" onclick="supprimerDemande(${demande.id})" title="Supprimer">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            },
            error: function() {
                $('#demandes-loading').html('<span style="color: #c62828;">Erreur lors du chargement des demandes</span>');
            }
        });
    }

    // Charger les r√©parations (fiches avec r√©paration uniquement)
    function loadReparations() {
        $.ajax({
            url: '/projet16/api/demandes',
            method: 'GET',
            success: function(demandes) {
                $('#demandes-loading').hide();
                $('#demandes-table').show();
                
                // Modifier l'en-t√™te du tableau pour les r√©parations
                const thead = $('#demandes-table thead tr');
                thead.html(`
                    <th>ID</th>
                    <th>Date Demande</th>
                    <th>Date de R√©paration</th>
                    <th>Temps</th>
                    <th>Machine</th>
                    <th>Intervenant</th>
                    <th>Nature</th>
                    <th>Statut R√©paration</th>
                    <th>Actions</th>
                `);
                
                const tbody = $('#demandes-tbody');
                tbody.empty();
                
                // Filtrer pour n'afficher que les fiches de r√©paration
                // Une r√©paration est identifi√©e par : MatInter et Internvenant renseign√©s
                const reparations = demandes.filter(function(d) {
                    return d.mat_inter && d.mat_inter !== '' && 
                           d.intervenant && d.intervenant !== '';
                });
                
                if (reparations.length === 0) {
                    tbody.append('<tr><td colspan="9" style="text-align: center; color: #666;">Aucune fiche de r√©paration enregistr√©e</td></tr>');
                    return;
                }
                
                reparations.forEach(function(demande) {
                    let statutRepClass = 'statut-nouveau';
                    if (demande.statut_reparation_id === 0) statutRepClass = 'statut-encours'; // En cours
                    else if (demande.statut_reparation_id === 1) statutRepClass = 'statut-encours';
                    else if (demande.statut_reparation_id === 2) statutRepClass = 'statut-termine';
                    const statutRepBadge = '<span class="badge ' + statutRepClass + '">' + demande.statut_reparation + '</span>';
                    
                    const dateStr = demande.dte_dem_in ? new Date(demande.dte_dem_in).toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    
                    // Formater la date de r√©paration (dte_deb)
                    const dateRepStr = demande.dte_deb ? new Date(demande.dte_deb).toLocaleString('fr-FR', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    }) : '-';
                    
                    // Formater le temps r√©el (tps_reel)
                    let tempsStr = '-';
                    if (demande.tps_reel) {
                        try {
                            if (typeof demande.tps_reel === 'string' && demande.tps_reel.includes(':')) {
                                // D√©j√† en format HH:MM
                                tempsStr = demande.tps_reel;
                            } else {
                                // Convertir de heures d√©cimales en HH:MM
                                const tpsReelHours = parseFloat(demande.tps_reel);
                                const hours = Math.floor(tpsReelHours);
                                const minutes = Math.round((tpsReelHours - hours) * 60);
                                tempsStr = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
                            }
                        } catch (e) {
                            tempsStr = '-';
                        }
                    }
                    
                    tbody.append(`
                        <tr>
                            <td>${demande.id}</td>
                            <td>${dateStr}</td>
                            <td>${dateRepStr}</td>
                            <td>${tempsStr}</td>
                            <td>${demande.postes_reel || '-'}</td>
                            <td>${demande.intervenant || '-'}</td>
                            <td>${demande.nat || '-'}</td>
                            <td>${statutRepBadge}</td>
                            <td>
                                <div class="button-group">
                                    <button class="btn-view" onclick="openReparationDetailsModal(${demande.id})" title="Voir d√©tails">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                            <circle cx="12" cy="12" r="3"></circle>
                                        </svg>
                                    </button>
                                    <button class="btn-repair" onclick="openReparationModal(${demande.id})" title="Modifier r√©paration">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path>
                                        </svg>
                                    </button>
                                    <button class="btn-delete" onclick="supprimerDemande(${demande.id})" title="Supprimer">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="3 6 5 6 21 6"></polyline>
                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                            <line x1="10" y1="11" x2="10" y2="17"></line>
                                            <line x1="14" y1="11" x2="14" y2="17"></line>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `);
                });
            },
            error: function() {
                $('#demandes-loading').html('<span style="color: #c62828;">Erreur lors du chargement des r√©parations</span>');
            }
        });
    }

    // ========== VARIABLES GLOBALES ==========
    let reparationEnCoursId = null; // ID de la fiche "En cours" cr√©√©e automatiquement
    let articleCounter = 0; // Compteur pour g√©n√©rer des IDs uniques pour les articles

    // ========== FONCTIONS ARTICLES DYNAMIQUES ==========
    function ajouterLigneArticle(articleData = null) {
        articleCounter++;
        const articleId = 'article_' + articleCounter;
        
        const articleRow = $(`
            <div class="article-dynamic-row" data-article-id="${articleId}" data-db-id="${articleData ? articleData.id : ''}">
                <div class="form-group">
                    <label>Article</label>
                    <input type="text" 
                           class="article-input" 
                           id="${articleId}_input" 
                           data-article-id="${articleId}"
                           list="articles_list_rep"
                           placeholder="-- Tapez pour rechercher un article --"
                           autocomplete="off"
                           data-id-article="">
                    <input type="hidden" class="article-id-hidden" id="${articleId}_id_hidden" value="${articleData ? articleData.id_article : ''}">
                </div>
                <div class="form-group">
                    <label>Quantit√©</label>
                    <input type="number" class="article-quantite" id="${articleId}_quantite" step="1" min="0" placeholder="0" value="${articleData ? Math.round(articleData.quantite || 0) : ''}">
                </div>
                <div class="article-actions">
                    <button type="button" class="btn-add-article-inline" onclick="ajouterLigneArticle()" title="Ajouter un article">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <button type="button" class="btn-remove-article" onclick="supprimerLigneArticle('${articleId}')" title="Supprimer cet article">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="3 6 5 6 21 6"></polyline>
                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                            <line x1="10" y1="11" x2="10" y2="17"></line>
                            <line x1="14" y1="11" x2="14" y2="17"></line>
                        </svg>
                    </button>
                </div>
            </div>
        `);
        
        $('#articles-container').append(articleRow);
        $('#no-articles-message').hide();
        
        // Pr√©-remplir si donn√©es fournies
        if (articleData && articleData.designation) {
            $(`#${articleId}_input`).val(articleData.designation);
            $(`#${articleId}_id_hidden`).val(articleData.id_article || '');
        }
        
        // Gestion du champ Article avec datalist (comme Machine Concern√©e)
        $(`#${articleId}_input`).on('input change', function() {
            const valeur = $(this).val();
            
            // Extraire l'ID de l'article depuis le datalist
            const option = $('#articles_list_rep option').filter(function() {
                return $(this).val() === valeur;
            }).first();
            
            if (option.length > 0) {
                const idArticle = option.attr('data-id');
                $(this).attr('data-id-article', idArticle);
                $(`#${articleId}_id_hidden`).val(idArticle);
                
                // Mettre √† jour la fiche en cours si elle existe
                if (reparationEnCoursId) {
                    setTimeout(sauvegarderArticles, 500);
                }
            } else {
                // Si pas de correspondance, vider les champs
                $(this).attr('data-id-article', '');
                $(`#${articleId}_id_hidden`).val('');
            }
        });
        
        // Focus sur le champ Article : s√©lectionner le texte
        $(`#${articleId}_input`).on('focus', function() {
            $(this).select();
        });
        
        // √âv√©nement sur changement de quantit√© avec validation pour nombres entiers uniquement
        $(`#${articleId}_quantite`).on('input change', function() {
            let valeur = $(this).val();
            // S'assurer que c'est un nombre entier positif
            if (valeur !== '' && valeur !== null) {
                const valeurEntiere = parseInt(valeur, 10);
                if (isNaN(valeurEntiere) || valeurEntiere < 0) {
                    // Si ce n'est pas un entier valide, arrondir ou mettre √† 0
                    $(this).val(Math.max(0, Math.round(parseFloat(valeur) || 0)));
                } else if (parseFloat(valeur) !== valeurEntiere) {
                    // Si c'est un d√©cimal, arrondir √† l'entier le plus proche
                    $(this).val(valeurEntiere);
                }
            }
            
            if (reparationEnCoursId) {
                setTimeout(sauvegarderArticles, 500);
            }
        });
        
        // Emp√™cher la saisie de caract√®res non num√©riques (sauf pour le contr√¥le)
        $(`#${articleId}_quantite`).on('keypress', function(e) {
            // Autoriser: backspace, delete, tab, escape, enter, point d√©cimal (mais on le convertira en entier)
            if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
                // Autoriser: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Autoriser: home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39)) {
                return;
            }
            // S'assurer que c'est un nombre
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });
        
        return articleId;
    }

    function supprimerLigneArticle(articleId) {
        const row = $(`.article-dynamic-row[data-article-id="${articleId}"]`);
        const dbId = row.attr('data-db-id');
        
        // Si l'article est enregistr√© en BD, le supprimer
        if (dbId && reparationEnCoursId) {
            $.ajax({
                url: `/projet16/api/delete_article/${dbId}`,
                method: 'DELETE',
                success: function() {
                    row.remove();
                    verifierArticlesVides();
                },
                error: function(xhr) {
                    console.error('Erreur lors de la suppression de l\'article:', xhr);
                    // Supprimer quand m√™me de l'interface
                    row.remove();
                    verifierArticlesVides();
                }
            });
        } else {
            row.remove();
            verifierArticlesVides();
        }
    }

    function verifierArticlesVides() {
        if ($('#articles-container .article-dynamic-row').length === 0) {
            $('#no-articles-message').show();
        }
    }

    function recupererArticlesDuFormulaire() {
        const articles = [];
        $('#articles-container .article-dynamic-row').each(function() {
            const row = $(this);
            const articleId = row.attr('data-article-id');
            const dbId = row.attr('data-db-id');
            const idGsArticles = $(`#${articleId}_id_hidden`).val();
            const quantite = $(`#${articleId}_quantite`).val();
            
            if (idGsArticles && quantite) {
                // Convertir en entier et s'assurer que c'est un nombre valide
                const quantiteEntiere = parseInt(quantite, 10);
                if (!isNaN(quantiteEntiere) && quantiteEntiere > 0) {
                    articles.push({
                        db_id: dbId || null,
                        id_gs_articles: idGsArticles,
                        quantite: quantiteEntiere
                    });
                }
            }
        });
        return articles;
    }

    function sauvegarderArticles() {
        if (!reparationEnCoursId) return;
        
        const articles = recupererArticlesDuFormulaire();
        
        $.ajax({
            url: `/projet16/api/save_articles/${reparationEnCoursId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ articles: articles }),
            success: function(response) {
                // Mettre √† jour les data-db-id avec les IDs retourn√©s
                if (response.articles && response.articles.length > 0) {
                    let articleIndex = 0;
                    $('#articles-container .article-dynamic-row').each(function() {
                        const row = $(this);
                        const articleId = row.attr('data-article-id');
                        const idGsArticles = $(`#${articleId}_id_hidden`).val();
                        const quantite = parseInt($(`#${articleId}_quantite`).val(), 10);
                        
                        if (idGsArticles && quantite > 0) {
                            // Trouver l'article correspondant dans la r√©ponse
                            const savedArticle = response.articles[articleIndex];
                            if (savedArticle && savedArticle.db_id) {
                                // Mettre √† jour le data-db-id
                                row.attr('data-db-id', savedArticle.db_id);
                            }
                            articleIndex++;
                        }
                    });
                }
            },
            error: function(xhr) {
                console.error('Erreur lors de la sauvegarde des articles:', xhr);
            }
        });
    }

    function chargerArticlesDeFiche(ficheId) {
        $.ajax({
            url: `/projet16/api/articles/${ficheId}`,
            method: 'GET',
            success: function(articles) {
                // Vider le conteneur
                $('#articles-container').empty();
                articleCounter = 0;
                
                if (articles && articles.length > 0) {
                    // Ajouter chaque article
                    articles.forEach(function(art) {
                        ajouterLigneArticle(art);
                    });
                    $('#no-articles-message').hide();
                } else {
                    $('#no-articles-message').show();
                }
            },
            error: function(xhr) {
                console.error('Erreur lors du chargement des articles:', xhr);
            }
        });
    }

    // ========== FONCTIONS DE CALCUL TEMPS ==========
    function heuresDecimalesVersHHMM(heuresDecimales) {
        const heures = Math.floor(heuresDecimales);
        const minutes = Math.round((heuresDecimales - heures) * 60);
        return String(heures).padStart(2, '0') + ':' + String(minutes).padStart(2, '0');
    }

    function HHMMVersHeuresDecimales(hhmm) {
        if (!hhmm || hhmm === '') return 0;
        const parts = hhmm.split(':');
        if (parts.length !== 2) return 0;
        const heures = parseInt(parts[0], 10) || 0;
        const minutes = parseInt(parts[1], 10) || 0;
        return heures + (minutes / 60);
    }

    function calculerTpsReel() {
        const dteDeb = $('#dte_deb').val();
        const dteFin = $('#dte_fin').val();
        
        if (dteDeb && dteFin) {
            const debut = new Date(dteDeb);
            const fin = new Date(dteFin);
            
            if (fin > debut) {
                const diffMs = fin - debut;
                const diffHours = diffMs / (1000 * 60 * 60);
                const hhmm = heuresDecimalesVersHHMM(diffHours);
                $('#tps_reel').val(hhmm);
            }
        }
    }

    function calculerDteFin() {
        const dteDeb = $('#dte_deb').val();
        const tpsReelHHMM = $('#tps_reel').val();
        
        if (dteDeb && tpsReelHHMM && tpsReelHHMM !== '') {
            const heuresDecimales = HHMMVersHeuresDecimales(tpsReelHHMM);
            
            if (heuresDecimales > 0) {
                const debut = new Date(dteDeb);
                const fin = new Date(debut.getTime() + (heuresDecimales * 60 * 60 * 1000));
                
                // Formater pour datetime-local
                const year = fin.getFullYear();
                const month = String(fin.getMonth() + 1).padStart(2, '0');
                const day = String(fin.getDate()).padStart(2, '0');
                const hours = String(fin.getHours()).padStart(2, '0');
                const minutes = String(fin.getMinutes()).padStart(2, '0');
                
                $('#dte_fin').val(`${year}-${month}-${day}T${hours}:${minutes}`);
            }
        }
    }
    
    // Validation et formatage automatique du champ HH:MM
    function formaterHHMM(input) {
        let valeur = input.value.replace(/[^0-9:]/g, ''); // Garder seulement les chiffres et :
        
        // Si l'utilisateur tape sans les deux-points, les ajouter automatiquement
        if (valeur.length >= 2 && !valeur.includes(':')) {
            valeur = valeur.substring(0, 2) + ':' + valeur.substring(2);
        }
        
        // Limiter √† 5 caract√®res (HH:MM)
        if (valeur.length > 5) {
            valeur = valeur.substring(0, 5);
        }
        
        // S'assurer que les minutes sont valides (00-59)
        if (valeur.includes(':')) {
            const parts = valeur.split(':');
            if (parts.length === 2) {
                const heures = parts[0];
                let minutes = parts[1];
                
                // Limiter les minutes √† 59
                if (minutes.length >= 2) {
                    const minInt = parseInt(minutes.substring(0, 2), 10);
                    if (minInt > 59) {
                        minutes = '59';
                    } else {
                        minutes = minutes.substring(0, 2);
                    }
                }
                
                valeur = heures + ':' + minutes;
            }
        }
        
        input.value = valeur;
    }

    function checkAndCreateFicheEnCours() {
        const hasMachine = $('#machine_reparation').val() !== '';
        const hasIntervenant = $('#mat_inter').val() !== '';
        
        if (hasMachine && hasIntervenant && !reparationEnCoursId) {
            // Cr√©er automatiquement une fiche "En cours" (ID_StatRep = 0)
            creerFicheEnCours();
        }
    }

    function creerFicheEnCours() {
        // Si une fiche en cours existe d√©j√†, la mettre √† jour au lieu d'en cr√©er une nouvelle
        if (reparationEnCoursId) {
            mettreAJourFicheEnCours();
            return;
        }

        // V√©rifier si une demande est s√©lectionn√©e
        let demandeId = $('#demande_id_rep').val();
        if (!demandeId) {
            demandeId = $('#select_demande_hidden').val();
        }

        // Convertir TpsReel de HH:MM en heures d√©cimales pour le backend
        const tpsReelHHMM = $('#tps_reel').val();
        const tpsReelDecimal = tpsReelHHMM ? HHMMVersHeuresDecimales(tpsReelHHMM) : null;
        
        const formData = {
            dte_deb: $('#dte_deb').val() || new Date().toISOString().slice(0, 16),
            dte_fin: $('#dte_fin').val() || '',
            mat_inter: $('#mat_inter').val(),
            postes_reel: $('#machine_reparation').val(),
            nat: $('#nat_rep_value').val() || 'Mec',
            id_stat_rep: 0, // En cours
            tps_reel: tpsReelDecimal
        };

        // Si une demande est s√©lectionn√©e, mettre √† jour cette demande
        if (demandeId) {
            $.ajax({
                url: '/projet16/api/update_reparation/' + demandeId,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function() {
                    reparationEnCoursId = demandeId;
                    $('#demande_id_rep').val(reparationEnCoursId);
                },
                error: function(xhr) {
                    console.error('Erreur lors de la cr√©ation de la fiche en cours:', xhr);
                }
            });
        } else {
            // Sinon, cr√©er une nouvelle fiche directe
            $.ajax({
                url: '/projet16/api/create_reparation_direct',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    reparationEnCoursId = response.id;
                    $('#demande_id_rep').val(reparationEnCoursId);
                },
                error: function(xhr) {
                    console.error('Erreur lors de la cr√©ation de la fiche en cours:', xhr);
                }
            });
        }
    }

    function mettreAJourFicheEnCours() {
        // Mettre √† jour la fiche en cours avec les donn√©es actuelles
        if (!reparationEnCoursId) return;

        // Convertir TpsReel de HH:MM en heures d√©cimales pour le backend
        const tpsReelHHMM = $('#tps_reel').val();
        const tpsReelDecimal = tpsReelHHMM ? HHMMVersHeuresDecimales(tpsReelHHMM) : null;
        
        const formData = {
            dte_deb: $('#dte_deb').val(),
            dte_fin: $('#dte_fin').val() || '',
            mat_inter: $('#mat_inter').val(),
            postes_reel: $('#machine_reparation').val(),
            nat: $('#nat_rep_value').val() || 'Mec',
            id_stat_rep: 0, // Rester en cours
            tps_reel: tpsReelDecimal
        };

        $.ajax({
            url: '/projet16/api/update_reparation/' + reparationEnCoursId,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function() {
                // Mise √† jour silencieuse r√©ussie
                // Sauvegarder aussi les articles
                sauvegarderArticles();
            },
            error: function(xhr) {
                console.error('Erreur lors de la mise √† jour de la fiche en cours:', xhr);
            }
        });
    }

    function enregistrerReparation(statut) {
        if (statut === 'annule') {
            // Annuler : fermer le popup sans enregistrer
            if (reparationEnCoursId && confirm('Voulez-vous vraiment annuler cette fiche de r√©paration ?')) {
                // Supprimer la fiche en cours si elle existe
                $.ajax({
                    url: '/projet16/api/delete_reparation/' + reparationEnCoursId,
                    method: 'DELETE',
                    success: function() {
                        closeReparationModal();
                    }
                });
            } else {
                closeReparationModal();
            }
            return;
        }

        // R√©cup√©rer l'ID de la demande (soit existant, soit la fiche en cours)
        let demandeId = $('#demande_id_rep').val() || reparationEnCoursId;
        if (!demandeId) {
            demandeId = $('#select_demande_hidden').val();
        }

        if (!demandeId) {
            showAlert('alert-reparation', 'Erreur: Impossible de d√©terminer l\'ID de la r√©paration', 'error');
            return;
        }

        // Convertir TpsReel de HH:MM en heures d√©cimales pour le backend
        const tpsReelHHMM = $('#tps_reel').val();
        const tpsReelDecimal = tpsReelHHMM ? HHMMVersHeuresDecimales(tpsReelHHMM) : null;
        
        const formData = {
            dte_deb: $('#dte_deb').val(),
            dte_fin: $('#dte_fin').val(),
            mat_inter: $('#mat_inter').val(),
            postes_reel: $('#machine_reparation').val(),
            nat: $('#nat_rep_value').val(),
            statut: statut, // 'cloturer', 'en_attente', 'temporaire'
            tps_reel: tpsReelDecimal
        };

        // Validation des champs obligatoires
        if (!formData.dte_deb) {
            showAlert('alert-reparation', 'Veuillez remplir la date/heure de d√©but', 'error');
            return;
        }
        if (!formData.mat_inter || !$('#intervenant_input').val()) {
            showAlert('alert-reparation', 'Veuillez s√©lectionner un intervenant', 'error');
            return;
        }
        if (!formData.postes_reel) {
            showAlert('alert-reparation', 'Veuillez remplir la machine concern√©e', 'error');
            return;
        }
        if (!formData.nat) {
            showAlert('alert-reparation', 'Veuillez s√©lectionner la nature de la r√©paration', 'error');
            return;
        }

        // Sauvegarder les articles avant de finaliser
        $.ajax({
            url: `/projet16/api/save_articles/${demandeId}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({ articles: recupererArticlesDuFormulaire() }),
            success: function() {
                // Articles sauvegard√©s, maintenant mettre √† jour le statut
                $.ajax({
                    url: '/projet16/api/update_reparation_status/' + demandeId,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(formData),
                    success: function(response) {
                const messages = {
                    'cloturer': 'Fiche de r√©paration cl√¥tur√©e avec succ√®s !',
                    'en_attente': 'Fiche de r√©paration mise en attente avec succ√®s !',
                    'temporaire': 'Fiche de r√©paration enregistr√©e temporairement avec succ√®s !'
                };
                        showAlert('alert-reparation', messages[statut] || 'Fiche de r√©paration enregistr√©e avec succ√®s !', 'success');
                        setTimeout(function() {
                            closeReparationModal();
                            // Recharger la liste actuellement affich√©e
                            const activeFilter = $('.filter-btn.active');
                            if (activeFilter.length > 0) {
                                const filterType = activeFilter.attr('onclick').includes('demandes') ? 'demandes' : 'reparations';
                                if (filterType === 'demandes') {
                                    loadDemandes();
                                } else {
                                    loadReparations();
                                }
                            } else {
                                loadDemandes();
                            }
                        }, 2000);
                    },
                    error: function(xhr) {
                        const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur lors de l\'enregistrement';
                        showAlert('alert-reparation', error, 'error');
                    }
                });
            },
            error: function(xhr) {
                showAlert('alert-reparation', 'Erreur lors de la sauvegarde des articles', 'error');
            }
        });
    }

    // Initialisation
    $(document).ready(function() {
        // Ne pas charger les demandes au d√©marrage - attendre le clic sur Maintenance Corrective
        // loadDemandes();

        // Gestion du champ Op√©rateur Demandeur avec datalist (comme projet 11)
        $('#operateur_reclamant').on('input change', function() {
            const valeur = $(this).val();
            // Extraire le matricule entre parenth√®ses : "Nom Prenom (Matricule: 123)"
            const match = valeur.match(/Matricule:\s*(\d+)/);
            if (match) {
                $(this).attr('data-matricule', match[1]);
                $('#matr_op_dem').val(match[1]);
            } else {
                $(this).attr('data-matricule', '');
                $('#matr_op_dem').val('');
            }
        });
        
        // S√©lectionner tout le texte au focus
        $('#operateur_reclamant').on('focus', function() {
            $(this).select();
        });
        
        // Navigation Tab vers le champ Machine
        $('#operateur_reclamant').on('keydown', function(e) {
            if (e.key === 'Tab' && !e.shiftKey) {
                e.preventDefault();
                $('#machine_input').focus();
            }
        });
        
        // Gestion du champ Machine avec datalist (comme projet 11)
        // Le nom de la machine sera stock√© directement dans PostesReel
        $('#machine_input').on('focus', function() {
            $(this).select(); // S√©lectionner tout le texte au focus
        });
        
        // Gestion des checkboxes √âtat de la Machine (une seule s√©lection possible)
        $('.checkbox-etat input[type="checkbox"]').on('change', function() {
            const estCoche = $(this).is(':checked');
            
            if (estCoche) {
                // D√©cocher l'autre checkbox
                $('.checkbox-etat input[type="checkbox"]').not(this).prop('checked', false);
                // Mettre √† jour la valeur dans le champ cach√©
                $('#id_emach_value').val($(this).val());
                // D√©placer automatiquement le curseur vers Description du Probl√®me
                setTimeout(function() {
                    $('#dem_in').focus();
                }, 100);
            } else {
                // Si on d√©coche, vider le champ cach√©
                $('#id_emach_value').val('');
            }
        });
        
        // Permettre le clic clavier (Entr√©e) pour cocher/d√©cocher
        $('.checkbox-etat').on('keypress', function(e) {
            if (e.which === 13) { // Touche Entr√©e
                e.preventDefault();
                const checkbox = $(this).find('input[type="checkbox"]');
                checkbox.prop('checked', !checkbox.is(':checked')).trigger('change');
            }
        });

        // Gestion des checkboxes Nature (identique √† √âtat de la Machine)
        $('.checkbox-nature input[type="checkbox"]').on('change', function() {
            const estCoche = $(this).is(':checked');
            
            if (estCoche) {
                // D√©cocher l'autre checkbox
                $('.checkbox-nature input[type="checkbox"]').not(this).prop('checked', false);
                // Mettre √† jour la valeur dans le champ cach√©
                $('#nat_rep_value').val($(this).val());
            } else {
                // Si on d√©coche, vider le champ cach√©
                $('#nat_rep_value').val('');
            }
        });
        
        // Permettre le clic clavier (Entr√©e) pour cocher/d√©cocher
        $('.checkbox-nature').on('keypress', function(e) {
            if (e.which === 13) { // Touche Entr√©e
                e.preventDefault();
                const checkbox = $(this).find('input[type="checkbox"]');
                checkbox.prop('checked', !checkbox.is(':checked')).trigger('change');
            }
        });

        // Note: Machine n'utilise plus Select2, maintenant input + datalist natif comme projet 11

        // Gestion du s√©lecteur de demande dans le popup de r√©paration (identique √† Intervenant)
        $('#select_demande_input').on('input change', function() {
            const valeur = $(this).val();
            
            // Extraire l'ID de la demande depuis le datalist
            const option = $('#demandes_list option').filter(function() {
                return $(this).val() === valeur;
            }).first();
            
            if (option.length > 0) {
                const demandeId = option.attr('data-demande-id');
                const machine = option.attr('data-machine');
                const nature = option.attr('data-nature');
                
                // Stocker l'ID de la demande
                $(this).attr('data-demande-id', demandeId);
                $('#select_demande_hidden').val(demandeId);
                $('#demande_id_rep').val(demandeId);
                
                // Pr√©-remplir la machine et la nature
                if (machine) {
                    $('#machine_reparation').val(machine);
                }
                if (nature && nature !== '') {
                    $('.checkbox-nature input[type="checkbox"]').prop('checked', false);
                    if (nature === 'Mec') {
                        $('#nature_mecanique').prop('checked', true);
                    } else if (nature === 'Elec') {
                        $('#nature_electrique').prop('checked', true);
                    }
                    $('#nat_rep_value').val(nature);
                }
            } else {
                // Si pas de correspondance, vider les champs
                $(this).attr('data-demande-id', '');
                $('#select_demande_hidden').val('');
                $('#demande_id_rep').val('');
            }
        });
        
        // Focus sur le champ de s√©lection de demande : s√©lectionner le texte
        $('#select_demande_input').on('focus', function() {
            $(this).select();
        });

        // Gestion du champ Intervenant (identique √† Op√©rateur Demandeur)
        $('#intervenant_input').on('input change', function() {
            const valeur = $(this).val();
            // Extraire le matricule entre parenth√®ses : "Nom Prenom (Matricule: 123)"
            const match = valeur.match(/Matricule:\s*(\d+)/);
            if (match) {
                $(this).attr('data-matricule', match[1]);
                $('#mat_inter').val(match[1]);
            } else {
                $(this).attr('data-matricule', '');
                $('#mat_inter').val('');
            }
        });
        
        // Focus sur le champ Intervenant : s√©lectionner le texte
        $('#intervenant_input').on('focus', function() {
            $(this).select();
        });

        // Cr√©er fiche en cours quand machine ET intervenant sont remplis
        $('#machine_reparation').on('input change', function() {
            checkAndCreateFicheEnCours();
            // Mettre √† jour la fiche en cours si elle existe
            if (reparationEnCoursId) {
                setTimeout(mettreAJourFicheEnCours, 500);
            }
        });

        $('#intervenant_input').on('input change', function() {
            const valeur = $(this).val();
            const match = valeur.match(/Matricule:\s*(\d+)/);
            if (match) {
                $(this).attr('data-matricule', match[1]);
                $('#mat_inter').val(match[1]);
                checkAndCreateFicheEnCours();
            } else {
                $(this).attr('data-matricule', '');
                $('#mat_inter').val('');
            }
            // Mettre √† jour la fiche en cours si elle existe
            if (reparationEnCoursId) {
                setTimeout(mettreAJourFicheEnCours, 500);
            }
        });
        
        // Calculs automatiques pour Date/Heure Fin et Temps R√©el
        $('#dte_deb, #dte_fin').on('change', function() {
            calculerTpsReel();
        });
        
        // Formatage automatique et calcul DteFin pour le champ Temps R√©el
        $('#tps_reel').on('input', function() {
            formaterHHMM(this);
        });
        
        $('#tps_reel').on('change blur', function() {
            calculerDteFin();
            // Mettre √† jour la fiche en cours si elle existe
            if (reparationEnCoursId) {
                setTimeout(mettreAJourFicheEnCours, 500);
            }
        });

        // Mettre √† jour la fiche en cours lors des changements de champs
        $('#nat_rep_value').on('change', function() {
            if (reparationEnCoursId) {
                setTimeout(mettreAJourFicheEnCours, 500);
            }
        });

        $('#dte_deb, #dte_fin').on('change', function() {
            if (reparationEnCoursId) {
                setTimeout(mettreAJourFicheEnCours, 500);
            }
        });

        // Articles g√©r√©s dynamiquement via ajouterLigneArticle()
        // Pas besoin d'initialisation statique

        // Soumission formulaire r√©clamation
        $('#demandeForm').on('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                dte_dem_in: $('#dte_dem_in').val(),
                matr_op_dem: $('#matr_op_dem').val(),
                postes_reel: $('#machine_input').val(),
                id_emach: $('#id_emach_value').val(),
                dem_in: $('#dem_in').val()
            };

            if (!formData.dte_dem_in || !formData.matr_op_dem || !formData.postes_reel || !formData.id_emach) {
                showAlert('alert-demande', 'Veuillez remplir tous les champs obligatoires', 'error');
                return;
            }

            // V√©rifier si c'est une modification ou une cr√©ation
            const demandeId = this.dataset.demandeId;
            const url = demandeId ? '/projet16/api/update_demande/' + demandeId : '/projet16/api/create_demande';
            const successMessage = demandeId ? 'Fiche d\'intervention modifi√©e avec succ√®s !' : 'Fiche d\'intervention cr√©√©e avec succ√®s !';

            $.ajax({
                url: url,
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(response) {
                    showAlert('alert-demande', successMessage, 'success');
                    setTimeout(function() {
                        closeDemandeModal();
                        // Recharger la liste actuellement affich√©e
                        const activeFilter = $('.filter-btn.active');
                        if (activeFilter.length > 0) {
                            const filterType = activeFilter.attr('onclick').includes('demandes') ? 'demandes' : 'reparations';
                            if (filterType === 'demandes') {
                                loadDemandes();
                            } else {
                                loadReparations();
                            }
                        } else {
                            loadDemandes();
                        }
                    }, 2000);
                },
                error: function(xhr) {
                    const error = xhr.responseJSON ? xhr.responseJSON.error : 'Erreur lors de l\'op√©ration';
                    showAlert('alert-demande', error, 'error');
                }
            });
        });

        // Emp√™cher la soumission classique du formulaire
        $('#reparationForm').on('submit', function(e) {
            e.preventDefault();
        });

        // Fermer les modals en cliquant √† l'ext√©rieur
        window.onclick = function(event) {
            if (event.target.id === 'demandeModal') {
                closeDemandeModal();
            }
            if (event.target.id === 'reparationModal') {
                closeReparationModal();
            }
            if (event.target.id === 'detailsModal') {
                closeDetailsModal();
            }
        };
    });
</script>
{% endblock %}
