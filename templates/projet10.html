{% extends "base.html" %}

{% block title %}Feuille de suivi machine contr√¥le qualit√©{% endblock %}


{% block content %}
    <div class="container-fluid">
        <!-- En-t√™te du formulaire -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white text-center">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <span class="fw-bold" style="writing-mode: vertical-rl; text-orientation: mixed;">Formulaire</span>
                            </div>
                            <div class="col-8">
                                <h2 class="mb-0">Feuille de suivi machine contr√¥le qualit√©</h2>
                            </div>
                            <div class="col-2 text-end">
                                <img src="{{ url_for('static', filename='logo-novaprint.png') }}" alt="NOVA" style="height: 40px;">
                                <div class="fw-bold">NOVA</div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-3">
                                <small>Code : FOR-SMI-14</small>
                            </div>
                            <div class="col-3">
                                <small>Version : 00</small>
                            </div>
                            <div class="col-3">
                                <small>Date : <span id="form-date"></span></small>
                            </div>
                            <div class="col-3">
                                <small>Page : 1/1</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Onglets principaux -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="margin-bottom: 1rem;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="controles-tab" data-bs-toggle="tab" data-bs-target="#controles" type="button" role="tab">
                üìã Contr√¥les
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="nouveau-tab" data-bs-toggle="tab" data-bs-target="#nouveau" type="button" role="tab">
                ‚ûï Nouveau Contr√¥le
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="statistiques-tab" data-bs-toggle="tab" data-bs-target="#statistiques" type="button" role="tab">
                üìä Statistiques
            </button>
        </li>
    </ul>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="mainTabContent">
        <!-- Onglet Contr√¥les -->
        <div class="tab-pane fade show active" id="controles" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Liste des Contr√¥les Qualit√©</h3>
                <button class="btn btn-primary" onclick="actualiserControles()">
                    üîÑ Actualiser
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped" id="tableControles">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>N¬∞ Dossier</th>
                            <th>Op√©rateur</th>
                            <th>Machine Impression</th>
                            <th>Machine D√©coupe</th>
                            <th>Rebus</th>
                            <th>Validation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyControles">
                        <!-- Donn√©es charg√©es via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Onglet Nouveau Contr√¥le -->
        <div class="tab-pane fade" id="nouveau" role="tabpanel">
            <div class="card">
                <div class="card-body">
            <form id="formNouveauControle">
                        <!-- Informations g√©n√©rales -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìã Informations G√©n√©rales</h5>
                            </div>
                            <div class="card-body">
                <div class="row">
                                    <div class="col-md-4">
                        <div class="mb-3">
                                            <label for="date_controle" class="form-label">üìÖ Date :</label>
                            <input type="date" class="form-control" id="date_controle" name="date_controle" required>
                        </div>
                                    </div>
                                    <div class="col-md-4">
                        <div class="mb-3">
                                            <label for="numero_dossier" class="form-label">üìÅ N¬∞ Dossier :</label>
                            <select class="form-control" id="numero_dossier" name="numero_dossier" required>
                                <option value="">S√©lectionner un num√©ro...</option>
                            </select>
                        </div>
                                    </div>
                                    <div class="col-md-4">
                        <div class="mb-3">
                                            <label for="operateur" class="form-label">üë§ Op√©rateur Contr√¥le :</label>
                                            <input type="text" class="form-control" id="operateur" name="operateur" required placeholder="Nom de l'op√©rateur contr√¥le">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Machine d'impression -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üñ®Ô∏è Machine d'Impression :</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="machine_impression" class="form-label">Machine d'impression :</label>
                                            <input type="text" class="form-control" id="machine_impression" name="machine_impression" placeholder="Ex: Heidelberg Speedmaster">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="operateur_machine_impression" class="form-label">üë• Op√©rateur(s) Machine d'impression :</label>
                                            <textarea class="form-control" id="operateur_machine_impression" name="operateur_machine_impression" rows="2" placeholder="Saisir les noms des op√©rateurs (s√©par√©s par des virgules)"></textarea>
                                            <small class="form-text text-muted">Ex: Jean Dupont, Marie Martin</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Machine de d√©coupe -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">‚úÇÔ∏è Machine de D√©coupe :</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="machine_decoupe" class="form-label">Machine de d√©coupe :</label>
                                            <input type="text" class="form-control" id="machine_decoupe" name="machine_decoupe" placeholder="Ex: Bobst SP 104 E">
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="operateur_machine_decoupe" class="form-label">üë• Op√©rateur(s) Machine de d√©coupe :</label>
                                            <textarea class="form-control" id="operateur_machine_decoupe" name="operateur_machine_decoupe" rows="2" placeholder="Saisir les noms des op√©rateurs (s√©par√©s par des virgules)"></textarea>
                                            <small class="form-text text-muted">Ex: Pierre Durand, Sophie Leroy</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tableau des tol√©rances -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìä Contr√¥le des Tol√©rances et Quantit√©s</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                    <thead class="table-primary">
                                        <tr>
                                            <th class="text-center" style="width: 40%;">Les tol√©rances des triages</th>
                                            <th class="text-center" style="width: 30%;">Quantit√© Conforme</th>
                                            <th class="text-center" style="width: 30%;">Quantit√© Non-conforme</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tolerances-container">
                                        <!-- 9 lignes de tol√©rances comme dans le formulaire papier -->
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2">Tol√©rance :</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td class="text-center fw-bold">TOTAL</td>
                                            <td class="text-center fw-bold" id="total-conforme">0</td>
                                            <td class="text-center fw-bold" id="total-non-conforme">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Section validation -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="rebus" class="form-label">üóëÔ∏è Rebus :</label>
                                            <input type="number" class="form-control" id="rebus" name="rebus" min="0" value="0" onchange="calculerTotaux()" placeholder="Quantit√© de rebus">
                                        </div>
                        </div>
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="validation_chef" class="form-label">‚úÖ Validation du chef section :</label>
                                            <input type="text" class="form-control" id="validation_chef" name="validation_chef" placeholder="Nom du chef de section">
                                        </div>
                                    </div>
                        </div>
                    </div>
                </div>
                
                        <!-- R√©sum√© automatique -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìà R√©sum√© automatique</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total Conforme :</strong> <span id="resume-conforme" class="text-success">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total Non-conforme :</strong> <span id="resume-non-conforme" class="text-danger">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Rebus :</strong> <span id="resume-rebus" class="text-warning">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total G√©n√©ral :</strong> <span id="resume-total" class="text-primary">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Enregistrer le Contr√¥le
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="reinitialiserFormulaire()">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                            <button type="button" class="btn btn-info" onclick="imprimerFormulaire()">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                        </div>
                    </form>
                </div>
                </div>
        </div>

        <!-- Onglet Statistiques -->
        <div class="tab-pane fade" id="statistiques" role="tabpanel">
            <h3>Statistiques de Contr√¥le Qualit√©</h3>
            
            <div class="row" id="statistiques-container">
                <!-- Statistiques charg√©es via JavaScript -->
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    
    // Charger les num√©ros de commandes disponibles
    chargerNumerosCommandes();
    
    // Charger les contr√¥les existants
    chargerControles();
    
    // Gestion du formulaire
    document.getElementById('formNouveauControle').addEventListener('submit', function(e) {
        e.preventDefault();
        creerControle();
    });
    
    // Gestion des onglets
    document.getElementById('statistiques-tab').addEventListener('click', function() {
        chargerStatistiques();
    });
    
    // Initialiser la date d'aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_controle').value = today;
    
    // Initialiser les calculs
    calculerTotaux();
    
    // Mettre √† jour la date du formulaire
    document.getElementById('form-date').textContent = new Date().toLocaleDateString('fr-FR');
});

// Charger les num√©ros de commandes disponibles
function chargerNumerosCommandes() {
    fetch('/projet10/api/numeros-commandes')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('numero_dossier');
            select.innerHTML = '<option value="">S√©lectionner un num√©ro...</option>';
            
            data.forEach(numero => {
                const option = document.createElement('option');
                option.value = numero;
                option.textContent = numero;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des num√©ros:', error);
        });
}

// Charger les contr√¥les existants
function chargerControles() {
    fetch('/projet10/api/controles')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('tbodyControles');
            tbody.innerHTML = '';
            
            data.forEach(controle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${controle.id}</td>
                    <td>${new Date(controle.date_controle).toLocaleDateString('fr-FR')}</td>
                    <td>${controle.numero_dossier}</td>
                    <td>${controle.operateur}</td>
                    <td>${controle.machine_impression || '-'}</td>
                    <td>${controle.machine_decoupe || '-'}</td>
                    <td>${controle.rebus}</td>
                    <td>${controle.validation_chef || 'Non valid√©'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="voirControle(${controle.id})">Voir</button>
                        <button class="btn btn-sm btn-warning" onclick="editerControle(${controle.id})">√âditer</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des contr√¥les:', error);
        });
}

// Charger les statistiques
function chargerStatistiques() {
    fetch('/projet10/api/statistiques')
        .then(res => res.json())
        .then(data => {
            const container = document.getElementById('statistiques-container');
            container.innerHTML = `
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Contr√¥les</h5>
                            <h2 class="text-primary">${data.total_controles}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Contr√¥les Valid√©s</h5>
                            <h2 class="text-success">${data.controles_valides}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Rebus Moyen</h5>
                            <h2 class="text-warning">${data.rebus_moyen}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title">Total Rebus</h5>
                            <h2 class="text-danger">${data.total_rebus}</h2>
                        </div>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Erreur lors du chargement des statistiques:', error);
        });
}

// Cr√©er un nouveau contr√¥le
function creerControle() {
    // Validation avant envoi
    if (!validerFormulaire()) {
        return;
    }
    
    const formData = new FormData(document.getElementById('formNouveauControle'));
    const data = {};
    
    // R√©cup√©rer les donn√©es du formulaire
    for (let [key, value] of formData.entries()) {
        if (key.includes('[]')) {
            const fieldName = key.replace('[]', '');
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
        } else {
            data[key] = value;
        }
    }
    
    // Organiser les tol√©rances
    if (data.tolerance && data.quantite_conforme && data.quantite_non_conforme) {
        data.tol√©rances = [];
        for (let i = 0; i < data.tolerance.length; i++) {
            if (data.tolerance[i] && data.tolerance[i].trim() !== '') {
                data.tol√©rances.push({
                    tolerance: data.tolerance[i].trim(),
                    quantite_conforme: parseInt(data.quantite_conforme[i]) || 0,
                    quantite_non_conforme: parseInt(data.quantite_non_conforme[i]) || 0
                });
            }
        }
    }
    
    // Supprimer les champs temporaires
    delete data.tolerance;
    delete data.quantite_conforme;
    delete data.quantite_non_conforme;
    
    // Afficher un indicateur de chargement
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;
    
    fetch('/projet10/api/controle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.status === 'success') {
            // Succ√®s
            showNotification('Contr√¥le cr√©√© avec succ√®s!', 'success');
            reinitialiserFormulaire();
            chargerControles();
            // Basculer vers l'onglet des contr√¥les
            document.getElementById('controles-tab').click();
        } else {
            showNotification('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la cr√©ation du contr√¥le', 'error');
    })
    .finally(() => {
        // Restaurer le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Valider le formulaire
function validerFormulaire() {
    const dateControle = document.getElementById('date_controle').value;
    const operateur = document.getElementById('operateur').value.trim();
    const numeroDossier = document.getElementById('numero_dossier').value;
    
    // Validation des champs obligatoires
    if (!dateControle) {
        showNotification('La date de contr√¥le est obligatoire', 'error');
        document.getElementById('date_controle').focus();
        return false;
    }
    
    if (!operateur) {
        showNotification('L\'op√©rateur est obligatoire', 'error');
        document.getElementById('operateur').focus();
        return false;
    }
    
    if (!numeroDossier) {
        showNotification('Le num√©ro de dossier est obligatoire', 'error');
        document.getElementById('numero_dossier').focus();
        return false;
    }
    
    // Validation des tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    let hasValidTolerance = false;
    for (let i = 0; i < toleranceInputs.length; i++) {
        const tolerance = toleranceInputs[i].value.trim();
        const conforme = parseInt(conformeInputs[i].value) || 0;
        const nonConforme = parseInt(nonConformeInputs[i].value) || 0;
        
        if (tolerance && (conforme > 0 || nonConforme > 0)) {
            hasValidTolerance = true;
            break;
        }
    }
    
    if (!hasValidTolerance) {
        showNotification('Au moins une tol√©rance avec des quantit√©s doit √™tre renseign√©e', 'error');
        return false;
    }
    
    return true;
}

// Afficher une notification
function showNotification(message, type = 'info') {
    // Cr√©er l'√©l√©ment de notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Supprimer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Ajouter une tol√©rance
function ajouterTolerance() {
    const container = document.getElementById('tolerances-container');
    const div = document.createElement('div');
    div.className = 'tolerance-row row mb-2';
    div.innerHTML = `
        <div class="col-md-4">
            <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="quantite_conforme[]" placeholder="Quantit√© conforme" min="0">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="quantite_non_conforme[]" placeholder="Quantit√© non conforme" min="0">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger" onclick="supprimerTolerance(this)">Supprimer</button>
        </div>
    `;
    container.appendChild(div);
}

// Supprimer une tol√©rance
function supprimerTolerance(button) {
    button.closest('.tolerance-row').remove();
}

// R√©initialiser le formulaire
function reinitialiserFormulaire() {
    document.getElementById('formNouveauControle').reset();
    document.getElementById('tolerances-container').innerHTML = `
        <div class="tolerance-row row mb-2">
            <div class="col-md-4">
                <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="quantite_conforme[]" placeholder="Quantit√© conforme" min="0">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="quantite_non_conforme[]" placeholder="Quantit√© non conforme" min="0">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger" onclick="supprimerTolerance(this)">Supprimer</button>
            </div>
        </div>
    `;
}

// Voir un contr√¥le
function voirControle(id) {
    fetch(`/projet10/api/controle/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                alert('Erreur: ' + data.error);
            } else {
                // Afficher les d√©tails du contr√¥le dans une modal ou une nouvelle page
                alert(`Contr√¥le ${id}: ${data.numero_dossier} - ${data.operateur}`);
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement du contr√¥le');
        });
}

// √âditer un contr√¥le
function editerControle(id) {
    // Impl√©menter l'√©dition
    alert('Fonction d\'√©dition √† impl√©menter');
}

// Actualiser les contr√¥les
function actualiserControles() {
    chargerControles();
}

// Calculer les totaux automatiquement
function calculerTotaux() {
    let totalConforme = 0;
    let totalNonConforme = 0;
    let rebus = parseInt(document.getElementById('rebus').value) || 0;
    
    // Calculer les totaux des tol√©rances
    const inputsConforme = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const inputsNonConforme = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    inputsConforme.forEach(input => {
        totalConforme += parseInt(input.value) || 0;
    });
    
    inputsNonConforme.forEach(input => {
        totalNonConforme += parseInt(input.value) || 0;
    });
    
    // Mettre √† jour les totaux dans le tableau
    document.getElementById('total-conforme').textContent = totalConforme;
    document.getElementById('total-non-conforme').textContent = totalNonConforme;
    
    // Mettre √† jour le r√©sum√©
    document.getElementById('resume-conforme').textContent = totalConforme;
    document.getElementById('resume-non-conforme').textContent = totalNonConforme;
    document.getElementById('resume-rebus').textContent = rebus;
    document.getElementById('resume-total').textContent = totalConforme + totalNonConforme + rebus;
}

// Imprimer le formulaire
function imprimerFormulaire() {
    // Cr√©er une nouvelle fen√™tre pour l'impression
    const printWindow = window.open('', '_blank');
    
    // R√©cup√©rer les donn√©es du formulaire
    const dateControle = document.getElementById('date_controle').value;
    const operateur = document.getElementById('operateur').value;
    const numeroDossier = document.getElementById('numero_dossier').value;
    const rebus = document.getElementById('rebus').value;
    const validationChef = document.getElementById('validation_chef').value;
    
    // Construire le contenu HTML pour l'impression
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Feuille de suivi machine contr√¥le qualit√©</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border: 2px solid #000; padding: 10px; margin-bottom: 20px; }
                .form-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .form-info { font-size: 12px; margin-bottom: 5px; }
                .form-section { margin-bottom: 20px; }
                .form-row { display: flex; margin-bottom: 10px; }
                .form-label { font-weight: bold; margin-right: 10px; min-width: 120px; }
                .form-value { border-bottom: 1px solid #000; flex: 1; padding: 5px; }
                .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .table th, .table td { border: 1px solid #000; padding: 8px; text-align: center; }
                .table th { background-color: #f0f0f0; font-weight: bold; }
                .table .tolerance-col { text-align: left; }
                .footer { margin-top: 30px; }
                .footer-row { display: flex; margin-bottom: 15px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="writing-mode: vertical-rl; text-orientation: mixed; font-weight: bold;">Formulaire</div>
                    <div>
                        <div class="form-title">Feuille de suivi machine contr√¥le qualit√©</div>
                        <div class="form-info">Code : FOR-SMI-14</div>
                        <div class="form-info">Version : 00</div>
                        <div class="form-info">Date : ${new Date().toLocaleDateString('fr-FR')}</div>
                        <div class="form-info">Page : 1/1</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold;">NOVA</div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-row">
                    <div class="form-label">Date :</div>
                    <div class="form-value">${dateControle || '_________________'}</div>
                </div>
                <div class="form-row">
                    <div class="form-label">Op√©rateur :</div>
                    <div class="form-value">${operateur || '_________________'}</div>
                </div>
                <div class="form-row">
                    <div class="form-label">N¬∞ dossier :</div>
                    <div class="form-value">${numeroDossier || '_________________'}</div>
                </div>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Les tol√©rances des triages</th>
                        <th style="width: 30%;">Quantit√© Conforme</th>
                        <th style="width: 30%;">Quantit√© Non-conforme</th>
                    </tr>
                </thead>
                <tbody>`;
    
    // Ajouter les lignes de tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    for (let i = 0; i < 9; i++) {
        const tolerance = toleranceInputs[i] ? toleranceInputs[i].value : '';
        const conforme = conformeInputs[i] ? conformeInputs[i].value : '';
        const nonConforme = nonConformeInputs[i] ? nonConformeInputs[i].value : '';
        
        printContent += `
            <tr>
                <td class="tolerance-col">Tol√©rance : ${tolerance || '_________________'}</td>
                <td>${conforme || '0'}</td>
                <td>${nonConforme || '0'}</td>
            </tr>`;
    }
    
    printContent += `
                </tbody>
            </table>
            
            <div class="footer">
                <div class="footer-row">
                    <div class="form-label">Rebus :</div>
                    <div class="form-value">${rebus || '0'}</div>
                </div>
                <div class="footer-row">
                    <div class="form-label">Validation du chef section :</div>
                    <div class="form-value">${validationChef || '_________________'}</div>
                </div>
            </div>
        </body>
        </html>`;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

// R√©initialiser le formulaire avec la structure correcte
function reinitialiserFormulaire() {
    document.getElementById('formNouveauControle').reset();
    
    // R√©initialiser tous les champs de tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    toleranceInputs.forEach(input => input.value = '');
    conformeInputs.forEach(input => input.value = '');
    nonConformeInputs.forEach(input => input.value = '');
    
    // R√©initialiser les totaux
    calculerTotaux();
    
    // D√©finir la date d'aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_controle').value = today;
}
</script>
{% endblock %}