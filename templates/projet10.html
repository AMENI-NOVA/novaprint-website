{% extends "base.html" %}

{% block title %}Feuille de suivi machine contr√¥le qualit√©{% endblock %}


{% block content %}
    <div class="container-fluid">
        <!-- En-t√™te du formulaire -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white text-center">
                        <div class="row align-items-center">
                            <div class="col-2">
                                <span class="fw-bold" style="writing-mode: vertical-rl; text-orientation: mixed;">Formulaire</span>
                            </div>
                            <div class="col-8">
                                <h2 class="mb-0">Feuille de suivi machine contr√¥le qualit√©</h2>
                            </div>
                            <div class="col-2 text-end">
                                <img src="{{ url_for('static', filename='logo-novaprint.png') }}" alt="NOVA" style="height: 40px;">
                                <div class="fw-bold">NOVA</div>
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-3">
                                <small>Code : FOR-SMI-14</small>
                            </div>
                            <div class="col-3">
                                <small>Version : 00</small>
                            </div>
                            <div class="col-3">
                                <small>Date : <span id="form-date"></span></small>
                            </div>
                            <div class="col-3">
                                <small>Page : 1/1</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <!-- Onglets principaux -->
    <ul class="nav nav-tabs" id="mainTabs" role="tablist" style="margin-bottom: 1rem;">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="controles-tab" data-bs-toggle="tab" data-bs-target="#controles" type="button" role="tab">
                üìã Contr√¥les
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="nouveau-tab" data-bs-toggle="tab" data-bs-target="#nouveau" type="button" role="tab">
                ‚ûï Nouveau Contr√¥le
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <a class="nav-link" href="/projet10/stat" target="_blank">
                üìä Statistiques
            </a>
        </li>
    </ul>

    <!-- Contenu des onglets -->
    <div class="tab-content" id="mainTabContent">
        <!-- Onglet Contr√¥les -->
        <div class="tab-pane fade show active" id="controles" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Liste des Contr√¥les Qualit√©</h3>
                <button class="btn btn-primary" onclick="actualiserControles()">
                    üîÑ Actualiser
                </button>
            </div>
            
            <div class="table-responsive">
                <table class="table table-striped" id="tableControles">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Date</th>
                            <th>N¬∞ Dossier</th>
                            <th>Op√©rateur</th>
                            <th>Machine Impression</th>
                            <th>Machine D√©coupe</th>
                            <th>Rebus</th>
                            <th>Validation</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tbodyControles">
                        <!-- Donn√©es charg√©es via JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Onglet Nouveau Contr√¥le -->
        <div class="tab-pane fade" id="nouveau" role="tabpanel">
            <div class="card">
                <div class="card-body">
            <form id="formNouveauControle">
                        <!-- Informations g√©n√©rales -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìã Informations G√©n√©rales</h5>
                            </div>
                            <div class="card-body">
                <div class="row">
                                    <div class="col-md-4">
                        <div class="mb-3">
                                            <label for="date_controle" class="form-label">üìÖ Date :</label>
                            <input type="date" class="form-control" id="date_controle" name="date_controle" required>
                        </div>
                                    </div>
                                    <div class="col-md-4">
                        <div class="mb-3">
                                            <label for="Numero_COMMANDES" class="form-label">üìÅ N¬∞ Dossier :</label>
                            <select class="form-control" id="Numero_COMMANDES" name="Numero_COMMANDES" required>
                                <option value="">S√©lectionner un num√©ro...</option>
                            </select>
                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-8">
                        <div class="mb-3 position-relative">
                                            <label class="form-label" for="op_ctrl_input">üë§ Op√©rateur Contr√¥le :</label>
                                            <input class="form-control" id="op_ctrl_input" placeholder="Saisir matricule/nom et cliquer une suggestion..." autocomplete="off">
                                            <div id="op_ctrl_suggestions" class="list-group" style="position:absolute; z-index:1050; max-height:240px; overflow:auto; display:none; width:100%;"></div>
                                            <div class="mt-2 small text-muted">S√©lectionn√©:</div>
                                            <div id="op_ctrl_tags" class="mt-1 d-flex flex-wrap gap-2"></div>
                                            <small class="form-text text-muted">Tapez pour rechercher, cliquez pour s√©lectionner. Cliquez sur l'√©tiquette pour enlever.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Machine d'impression -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üñ®Ô∏è Machine d'Impression :</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="machine_impression" class="form-label">Machine d'impression :</label>
                                            <select class="form-select" id="machine_impression" name="machine_impression">
                                                <option value="">-- S√©lectionner une machine --</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                        <div class="mb-3 position-relative">
                                            <label class="form-label" for="op_impression_input">üë• Op√©rateur(s) Machine d'impression :</label>
                                            <input class="form-control" id="op_impression_input" placeholder="Saisir matricule/nom et cliquer une suggestion..." autocomplete="off">
                                            <div id="op_impression_suggestions" class="list-group" style="position:absolute; z-index:1050; max-height:240px; overflow:auto; display:none; width:100%;"></div>
                                            <div class="mt-2 small text-muted">S√©lectionn√©s:</div>
                                            <div id="op_impression_tags" class="mt-1 d-flex flex-wrap gap-2"></div>
                                            <small class="form-text text-muted">Tapez pour rechercher, cliquez pour ajouter. Cliquez sur une √©tiquette pour enlever.</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Machine de d√©coupe (d√©sactiv√©e) -->
                        
                        <!-- Tableau des tol√©rances -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìä Contr√¥le des Tol√©rances et Quantit√©s</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table table-bordered table-striped">
                                    <thead class="table-primary">
                                        <tr>
                                            <th class="text-center" style="width: 40%;">Les tol√©rances des triages</th>
                                            <th class="text-center" style="width: 30%;">Quantit√© Conforme</th>
                                            <th class="text-center" style="width: 30%;">Quantit√© Non-conforme</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tolerances-container">
                                        <!-- 9 lignes de tol√©rances comme dans le formulaire papier -->
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="d-flex align-items-center">
                                                    <span class="me-2 text-nowrap">Tol√©rance&nbsp;:</span>
                                                    <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                            <td class="text-center">
                                                <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="table-secondary">
                                        <tr>
                                            <td class="text-center fw-bold">TOTAL</td>
                                            <td class="text-center fw-bold" id="total-conforme">0</td>
                                            <td class="text-center fw-bold" id="total-non-conforme">0</td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Section validation -->
                        <div class="card mb-4">
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                        <div class="mb-3">
                                            <label for="rebus" class="form-label">üóëÔ∏è Rebus (calcul√© automatiquement) :</label>
                                            <input type="number" class="form-control bg-light" id="rebus" name="rebus" min="0" value="0" readonly title="Calcul√© automatiquement = Quantit√© non-conforme de la derni√®re ligne">
                                            <small class="form-text text-muted">= Quantit√© non-conforme de la derni√®re ligne du tableau</small>
                                        </div>
                        </div>
                                    <div class="col-md-6">
                        <div class="mb-3 position-relative">
                                            <label class="form-label">‚úÖ Validation du chef section :</label>
                                            <input class="form-control" id="op_chef_input" placeholder="Saisir matricule/nom et cliquer une suggestion..." autocomplete="off">
                                            <div id="op_chef_suggestions" class="list-group" style="position:absolute; z-index:1050; max-height:240px; overflow:auto; display:none; width:100%;"></div>
                                            <div class="mt-2 small text-muted">S√©lectionn√©:</div>
                                            <div id="op_chef_tags" class="mt-1 d-flex flex-wrap gap-2"></div>
                                                </div>
                                    </div>
                        </div>
                    </div>
                </div>
                
                        <!-- R√©sum√© automatique -->
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="mb-0">üìà R√©sum√© automatique</h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total Conforme :</strong> <span id="resume-conforme" class="text-success">0</span>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total Non-conforme :</strong> <span id="resume-non-conforme" class="text-danger">0</span>
                                        </div>
                            </div>
                            <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Rebus :</strong> <span id="resume-rebus" class="text-warning">0</span>
                                        </div>
                            </div>
                            <div class="col-md-3">
                                        <div class="text-center">
                                            <strong>Total G√©n√©ral :</strong> <span id="resume-total" class="text-primary">0</span>
                                        </div>
                                    </div>
                            </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-center">
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save"></i> Enregistrer le Contr√¥le
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="reinitialiserFormulaire()">
                                <i class="fas fa-undo"></i> R√©initialiser
                            </button>
                            <button type="button" class="btn btn-info" onclick="imprimerFormulaire()">
                                <i class="fas fa-print"></i> Imprimer
                            </button>
                    </div>
                    </form>
                </div>
                </div>
        </div>

        <!-- Onglet Statistiques (maintenant un lien externe) -->
        <div class="tab-pane fade" id="statistiques" role="tabpanel" style="min-height: 240px; padding: 12px 8px; display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Statistiques de Contr√¥le Qualit√©</h3>
                <button class="btn btn-primary btn-sm" onclick="chargerStatistiques()">
                    üîÑ Actualiser les statistiques
                </button>
            </div>
            <div class="row" id="statistiques-container">
                <div class="col-12 text-center text-muted py-4" id="stats-placeholder">
                    Chargement des statistiques...
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<!-- Biblioth√®que pour g√©n√©rer des PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
// Modal de visualisation
const VIEW_MODAL_HTML = `
<div class="modal fade" id="viewControleModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">D√©tails du contr√¥le</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="viewControleContent"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
      </div>
    </div>
  </div>
</div>`;
if (!document.getElementById('viewControleModal')) {
  const div = document.createElement('div');
  div.innerHTML = VIEW_MODAL_HTML;
  document.body.appendChild(div.firstElementChild);
}
let __EDIT_ID__ = null;
document.addEventListener('DOMContentLoaded', function () {
    
    // Charger les num√©ros de commandes disponibles
    chargerNumerosCommandes();

    // Charger les op√©rateurs disponibles
    chargerOperateurs();
    
    // Charger les machines d'impression disponibles
    chargerMachinesImpression();
    
    // Charger les contr√¥les existants
    chargerControles();
    
    // Gestion du formulaire
    document.getElementById('formNouveauControle').addEventListener('submit', function(e) {
        e.preventDefault();
        if (__EDIT_ID__) {
            updateControle(__EDIT_ID__);
        } else {
        creerControle();
        }
    });
    
    // Gestion des onglets - Charger les statistiques lors du clic
    const statsTab = document.getElementById('statistiques-tab');
    if (statsTab) {
        statsTab.addEventListener('shown.bs.tab', function () {
            console.log('Onglet Statistiques affich√©');
            chargerStatistiques();
        });
    }
    
    // Charger les statistiques au d√©marrage (pour qu'elles soient pr√™tes)
    setTimeout(() => {
        chargerStatistiques();
    }, 500);
    
    // Initialiser la date d'aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_controle').value = today;
    
    // Initialiser les calculs
    calculerTotaux();
    
    // Mettre √† jour la date du formulaire
    document.getElementById('form-date').textContent = new Date().toLocaleDateString('fr-FR');
});

// Charger les num√©ros de commandes disponibles
function chargerNumerosCommandes() {
    fetch('/projet10/api/numeros-commandes')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('Numero_COMMANDES');
            select.innerHTML = '<option value="">S√©lectionner un num√©ro...</option>';
            
            data.forEach(numero => {
                const option = document.createElement('option');
                option.value = numero;
                option.textContent = numero;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des num√©ros:', error);
        });
}

// Charger les machines d'impression disponibles
function chargerMachinesImpression() {
    fetch('/projet10/api/machines-disponibles')
        .then(res => res.json())
        .then(data => {
            const select = document.getElementById('machine_impression');
            select.innerHTML = '<option value="">-- S√©lectionner une machine --</option>';
            
            data.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine;
                option.textContent = machine;
                select.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des machines:', error);
        });
}

// Charger les op√©rateurs disponibles
function chargerOperateurs() {
    console.log('Chargement des op√©rateurs...');
    fetch('/projet10/api/operateurs')
        .then(res => res.json())
        .then(data => {
            console.log('Op√©rateurs re√ßus:', data);
            // M√©moriser globalement
            window.__OPERATEURS__ = data;
            // Remplir le select matricule pour l'op√©rateur contr√¥le
            const selectOper = document.getElementById('operateur_matricule');
            if (selectOper) {
                selectOper.innerHTML = '<option value="">S√©lectionner...</option>';
            data.forEach(o => {
                const opt = document.createElement('option');
                    opt.value = (o.matricule||'').trim();
                    opt.textContent = `${(o.matricule||'').trim()} - ${(o.nom||'').trim()} ${(o.prenom||'').trim()}`.trim();
                    opt.dataset.nom = o.nom || '';
                    opt.dataset.prenom = o.prenom || '';
                    selectOper.appendChild(opt);
                });
            }

            // Chef de section ‚Äî m√™me UX que op√©rateur contr√¥le (s√©lection simple)
            const opChefInput = document.getElementById('op_chef_input');
            const opChefSugg = document.getElementById('op_chef_suggestions');
            const opChefTags = document.getElementById('op_chef_tags');

            // Tables pour op√©rateurs machines
            // Pickers Impression / D√©coupe
            const opImpInput = document.getElementById('op_impression_input');
            const opImpSugg = document.getElementById('op_impression_suggestions');
            const opImpTags = document.getElementById('op_impression_tags');
            // D√©coupe d√©sactiv√©e
            const opDecInput = null;
            const opDecSugg = document.createElement('div');
            const opDecTags = document.createElement('div');

            // (op√©rations sp√©cifiques chef/op√©rateur sont g√©r√©es par les pickers ci-dessous)

            // Op√©rateur contr√¥le: suggestions + tag unique (m√™me UX que impression)
            const opCtrlInput = document.getElementById('op_ctrl_input');
            const opCtrlSugg = document.getElementById('op_ctrl_suggestions');
            const opCtrlTags = document.getElementById('op_ctrl_tags');
            function renderCtrlSuggestions(term) {
                const t = term.toLowerCase();
                const results = (window.__OPERATEURS__||[]).filter(o =>
                    (o.matricule||'').toLowerCase().includes(t) ||
                    (o.nom||'').toLowerCase().includes(t) ||
                    (o.prenom||'').toLowerCase().includes(t)
                ).slice(0,20);
                if (!results.length) { opCtrlSugg.style.display='none'; opCtrlSugg.innerHTML=''; return; }
                opCtrlSugg.innerHTML = results.map(o => `
                    <button type="button" class="list-group-item list-group-item-action" data-m="${(o.matricule||'').replaceAll('"','&quot;')}" data-n="${(o.nom||'').replaceAll('"','&quot;')}" data-p="${(o.prenom||'').replaceAll('"','&quot;')}">
                        <strong>${o.matricule||''}</strong> ‚Äî ${(o.nom||'')} ${(o.prenom||'')}
                    </button>
                `).join('');
                opCtrlSugg.style.display='block';
            }
            function addCtrlTag(m,n,p){
                // √©viter doublons par matricule
                const exists = Array.from(opCtrlTags.querySelectorAll('span.badge')).some(b => b.getAttribute('data-m')===m);
                if (exists) return;
                const tag = document.createElement('span');
                tag.className = 'badge bg-primary';
                tag.textContent = `${m} ‚Äî ${n} ${p}`;
                tag.setAttribute('data-m', m);
                tag.setAttribute('data-n', n);
                tag.setAttribute('data-p', p);
                tag.style.cursor = 'pointer';
                tag.addEventListener('click', () => tag.remove());
                opCtrlTags.appendChild(tag);
            }
            if (opCtrlInput) {
                opCtrlInput.addEventListener('input', function(){
                    renderCtrlSuggestions(this.value.trim());
                });
            }
            if (opCtrlSugg) {
                opCtrlSugg.addEventListener('click', function(e){
                    const btn = e.target.closest('button'); if (!btn) return;
                    addCtrlTag(btn.getAttribute('data-m')||'', btn.getAttribute('data-n')||'', btn.getAttribute('data-p')||'');
                    opCtrlSugg.style.display='none'; opCtrlInput.value='';
                });
            }
            document.addEventListener('click', function(e){
                if (!opCtrlSugg.contains(e.target) && e.target!==opCtrlInput) opCtrlSugg.style.display='none';
            });

            // Utils multi-pick
            function filterOps(term) {
                const t = term.toLowerCase();
                return (window.__OPERATEURS__ || []).filter(o =>
                    (o.matricule||'').toLowerCase().includes(t) ||
                    (o.nom||'').toLowerCase().includes(t) ||
                    (o.prenom||'').toLowerCase().includes(t)
                ).slice(0,20);
            }
            function renderOpSuggestions(container, results) {
                if (!results.length) { container.style.display='none'; container.innerHTML=''; return; }
                container.innerHTML = results.map(o => `
                    <button type="button" class="list-group-item list-group-item-action" data-m="${(o.matricule||'').replaceAll('"','&quot;')}" data-n="${(o.nom||'').replaceAll('"','&quot;')}" data-p="${(o.prenom||'').replaceAll('"','&quot;')}">
                        <strong>${o.matricule||''}</strong> ‚Äî ${(o.nom||'')} ${(o.prenom||'')}
                    </button>
                `).join('');
                container.style.display='block';
            }
            function addTag(container, m,n,p) {
                // √©viter doublons
                const exists = Array.from(container.querySelectorAll('span.badge')).some(b => b.getAttribute('data-m')===m);
                if (exists) return;
                const tag = document.createElement('span');
                tag.className = 'badge bg-primary';
                tag.textContent = `${m} ‚Äî ${n} ${p}`;
                tag.setAttribute('data-m', m);
                tag.setAttribute('data-n', n);
                tag.setAttribute('data-p', p);
                tag.style.cursor = 'pointer';
                tag.addEventListener('click', () => tag.remove());
                container.appendChild(tag);
            }
            // Impression
            opImpInput.addEventListener('input', function(){
                renderOpSuggestions(opImpSugg, filterOps(this.value.trim()));
            });
            opImpSugg.addEventListener('click', function(e){
                const btn = e.target.closest('button'); if (!btn) return;
                addTag(opImpTags, btn.getAttribute('data-m')||'', btn.getAttribute('data-n')||'', btn.getAttribute('data-p')||'');
                opImpSugg.style.display='none'; opImpInput.value='';
            });
            // D√©coupe (aucune interaction)
            document.addEventListener('click', function(e){
                if (!opImpSugg.contains(e.target) && e.target!==opImpInput) opImpSugg.style.display='none';
                // pas de gestion d√©coupe
            });

            function renderChefSuggestions(term) {
                if (!term) { opChefSugg.style.display='none'; opChefSugg.innerHTML=''; return; }
                const t = term.toLowerCase();
                const results = (window.__OPERATEURS__||[]).filter(o =>
                    (o.matricule||'').toLowerCase().includes(t) ||
                    (o.nom||'').toLowerCase().includes(t) ||
                    (o.prenom||'').toLowerCase().includes(t)
                ).slice(0,20);
                if (!results.length) { opChefSugg.style.display='none'; opChefSugg.innerHTML=''; return; }
                opChefSugg.style.minWidth = (opChefInput ? opChefInput.offsetWidth : 0) + 'px';
                opChefSugg.innerHTML = results.map(o => `
                    <button type="button" class="list-group-item list-group-item-action" data-m="${(o.matricule||'').replaceAll('"','&quot;')}" data-n="${(o.nom||'').replaceAll('"','&quot;')}" data-p="${(o.prenom||'').replaceAll('"','&quot;')}">
                        <strong>${o.matricule||''}</strong> ‚Äî ${(o.nom||'')} ${(o.prenom||'')}
                    </button>
                `).join('');
                opChefSugg.style.display='block';
            }
            function setChefTag(m,n,p){
                opChefTags.innerHTML = '';
                const tag = document.createElement('span');
                tag.className='badge bg-success';
                tag.textContent = `${m} ‚Äî ${n} ${p}`;
                tag.setAttribute('data-m', m);
                tag.setAttribute('data-n', n);
                tag.setAttribute('data-p', p);
                tag.style.cursor='pointer';
                tag.addEventListener('click', ()=>{ opChefTags.innerHTML=''; opChefInput.value=''; });
                opChefTags.appendChild(tag);
            }
            if (opChefInput) {
                opChefInput.addEventListener('input', function(){
                    renderChefSuggestions(this.value.trim());
                });
                opChefInput.addEventListener('focus', function(){
                    renderChefSuggestions(this.value.trim());
                });
            }
            if (opChefSugg) {
                opChefSugg.addEventListener('click', function(e){
                    const btn = e.target.closest('button'); if (!btn) return;
                    setChefTag(btn.getAttribute('data-m')||'', btn.getAttribute('data-n')||'', btn.getAttribute('data-p')||'');
                    opChefSugg.style.display='none'; opChefInput.value='';
                });
            }
            document.addEventListener('click', function(e){
                if (!opChefSugg.contains(e.target) && e.target!==opChefInput) opChefSugg.style.display='none';
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des op√©rateurs:', error);
        });
}

// Charger les contr√¥les existants
function chargerControles() {
    fetch('/projet10/api/controles')
        .then(res => res.json())
        .then(data => {
            const tbody = document.getElementById('tbodyControles');
            tbody.innerHTML = '';
            
            data.forEach(controle => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${controle.id}</td>
                    <td>${new Date(controle.date_controle).toLocaleDateString('fr-FR')}</td>
                    <td>${controle.Numero_COMMANDES}</td>
                    <td>${controle.operateur}</td>
                    <td>${controle.machine_impression || '-'}</td>
                    <td>${controle.machine_decoupe || '-'}</td>
                    <td>${controle.rebus}</td>
                    <td>${controle.validation_chef || 'Non valid√©'}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="voirControle(${controle.id})">Voir</button>
                        <button class="btn btn-sm btn-warning" onclick="editerControle(${controle.id})">√âditer</button>
                        <a class="btn btn-sm btn-outline-primary" href="/projet10/fiche/${controle.id}">Fiche</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        })
        .catch(error => {
            console.error('Erreur lors du chargement des contr√¥les:', error);
        });
}

// Charger les statistiques - VERSION ULTRA SIMPLIFI√âE
function chargerStatistiques() {
    console.log('=== DEBUT chargerStatistiques ===');
    const container = document.getElementById('statistiques-container');
    
    if (!container) {
        console.error('ERREUR: Container introuvable!');
        return;
    }
    
    console.log('Container trouv√©, appel API...');
    
    fetch('/projet10/api/statistiques')
        .then(res => res.json())
        .then(data => {
            console.log('Donn√©es re√ßues:', data);
            
            // Formater les nombres avec s√©parateurs de milliers
            const formatNumber = (num) => {
                if (num === null || num === undefined) return '0';
                return num.toLocaleString('fr-FR', { maximumFractionDigits: 0 });
            };
            
            // Formater les d√©cimales avec 3 chiffres apr√®s la virgule
            const formatDecimal = (num) => {
                if (num === null || num === undefined) return '0,000';
                return num.toLocaleString('fr-FR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            };
            
            // Calculer le taux de validation
            const tauxValidation = data.total_controles > 0 
                ? ((data.controles_valides / data.total_controles) * 100).toFixed(3)
                : '0.000';
            
            console.log('Construction du HTML SIMPLIFI√â...');
            
            // VERSION ULTRA SIMPLE POUR DIAGNOSTIC
            const html = `
                <div class="col-12" style="background: #f0f8ff; padding: 30px; border: 3px solid #007bff; margin: 20px 0;">
                    <h1 style="color: #007bff; font-size: 48px; text-align: center;">üìä STATISTIQUES</h1>
                    
                    <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 10px;">
                        <h2 style="color: #28a745;">‚úÖ Donn√©es charg√©es avec succ√®s !</h2>
                        <hr>
                        <p style="font-size: 24px;"><strong>Total Contr√¥les :</strong> <span style="color: #007bff; font-size: 36px;">${data.total_controles}</span></p>
                        <p style="font-size: 24px;"><strong>Contr√¥les Valid√©s :</strong> <span style="color: #28a745; font-size: 36px;">${data.controles_valides}</span></p>
                        <p style="font-size: 24px;"><strong>Total Produit :</strong> <span style="color: #17a2b8; font-size: 36px;">${formatNumber(data.total_produit)}</span> pi√®ces</p>
                        <p style="font-size: 24px;"><strong>Taux de Conformit√© :</strong> <span style="color: #28a745; font-size: 36px;">${formatDecimal(data.taux_conformite)}%</span></p>
                        <p style="font-size: 24px;"><strong>Total Conforme :</strong> <span style="color: #28a745; font-size: 36px;">${formatNumber(data.total_conforme)}</span> pi√®ces</p>
                        <p style="font-size: 24px;"><strong>Total Rebus :</strong> <span style="color: #dc3545; font-size: 36px;">${formatNumber(data.total_non_conforme)}</span> pi√®ces</p>
                        <p style="font-size: 24px;"><strong>Taux de Rebus :</strong> <span style="color: #dc3545; font-size: 36px;">${formatDecimal(data.taux_rebus)}%</span></p>
                        <p style="font-size: 24px;"><strong>Rebus Moyen :</strong> <span style="color: #ffc107; font-size: 36px;">${formatDecimal(data.rebus_moyen)}</span> par contr√¥le</p>
                    </div>
                </div>
            `;
            
            console.log('Injection du HTML...');
            container.innerHTML = html;
            console.log('=== FIN chargerStatistiques ===');
        })
        .catch(error => {
            console.error('=== ERREUR dans chargerStatistiques ===', error);
            const container = document.getElementById('statistiques-container');
            if (container) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <strong>Erreur:</strong> Impossible de charger les statistiques. ${error.message}
                        </div>
                    </div>
                `;
            }
        });
}

// Charger les statistiques par machine
function chargerStatsMachines() {
    console.log('Chargement des statistiques par machine...');
    fetch('/projet10/api/statistiques/machines')
        .then(res => res.json())
        .then(data => {
            console.log('Stats machines re√ßues:', data);
            const container = document.getElementById('stats-additionnelles');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Aucune donn√©e de machine disponible.</div>';
                return;
            }
            
            const formatNumber = (num) => (num || 0).toLocaleString('fr-FR');
            
            let html = `
                <h4 class="text-primary mb-3">üè≠ Performance par Machine d'Impression</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>Machine</th>
                                <th class="text-center">Nb Contr√¥les</th>
                                <th class="text-center">Total Conforme</th>
                                <th class="text-center">Total Rebus</th>
                                <th class="text-center">Total Produit</th>
                                <th class="text-center">Taux Conformit√©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(m => {
                const badgeClass = m.taux_conformite >= 95 ? 'success' : (m.taux_conformite >= 90 ? 'warning' : 'danger');
                html += `
                    <tr>
                        <td><strong>${m.machine}</strong></td>
                        <td class="text-center">${formatNumber(m.nombre_controles)}</td>
                        <td class="text-center text-success">${formatNumber(m.total_conforme)}</td>
                        <td class="text-center text-danger">${formatNumber(m.total_rebus)}</td>
                        <td class="text-center">${formatNumber(m.total_produit)}</td>
                        <td class="text-center">
                            <span class="badge bg-${badgeClass}">${m.taux_conformite}%</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('stats-additionnelles').innerHTML = 
                `<div class="alert alert-danger">Erreur: ${error.message}</div>`;
        });
}

// Charger l'√©volution de la qualit√©
function chargerEvolution() {
    console.log('Chargement de l\'√©volution...');
    const jours = 30;
    fetch(`/projet10/api/statistiques/evolution?jours=${jours}`)
        .then(res => res.json())
        .then(data => {
            console.log('√âvolution re√ßue:', data);
            const container = document.getElementById('stats-additionnelles');
            
            if (!data || data.length === 0) {
                container.innerHTML = '<div class="alert alert-info">Aucune donn√©e d\'√©volution disponible.</div>';
                return;
            }
            
            const formatNumber = (num) => (num || 0).toLocaleString('fr-FR');
            
            let html = `
                <h4 class="text-primary mb-3">üìà √âvolution de la Qualit√© (${jours} derniers jours)</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-info">
                            <tr>
                                <th>Date</th>
                                <th class="text-center">Conforme</th>
                                <th class="text-center">Rebus</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Taux Conformit√©</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(d => {
                const dateFormat = new Date(d.date).toLocaleDateString('fr-FR');
                const badgeClass = d.taux_conformite >= 95 ? 'success' : (d.taux_conformite >= 90 ? 'warning' : 'danger');
                html += `
                    <tr>
                        <td>${dateFormat}</td>
                        <td class="text-center text-success">${formatNumber(d.total_conforme)}</td>
                        <td class="text-center text-danger">${formatNumber(d.total_rebus)}</td>
                        <td class="text-center">${formatNumber(d.total_produit)}</td>
                        <td class="text-center">
                            <span class="badge bg-${badgeClass}">${d.taux_conformite}%</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('stats-additionnelles').innerHTML = 
                `<div class="alert alert-danger">Erreur: ${error.message}</div>`;
        });
}

// Charger les dossiers √† probl√®me
function chargerDossiersProbleme() {
    console.log('Chargement des dossiers √† probl√®me...');
    const seuil = 10; // 10% de rebus
    fetch(`/projet10/api/statistiques/dossiers-probleme?seuil=${seuil}`)
        .then(res => res.json())
        .then(data => {
            console.log('Dossiers probl√®me re√ßus:', data);
            const container = document.getElementById('stats-additionnelles');
            
            if (!data || data.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-success">
                        <strong>‚úÖ Excellent !</strong> Aucun dossier avec un taux de rebus sup√©rieur √† ${seuil}%.
                    </div>
                `;
                return;
            }
            
            const formatNumber = (num) => (num || 0).toLocaleString('fr-FR');
            
            let html = `
                <h4 class="text-danger mb-3">‚ö†Ô∏è Dossiers avec Rebus √âlev√© (>${seuil}%)</h4>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-danger">
                            <tr>
                                <th>N¬∞ Dossier</th>
                                <th>Date</th>
                                <th>Op√©rateur</th>
                                <th>Machine</th>
                                <th class="text-center">Conforme</th>
                                <th class="text-center">Rebus</th>
                                <th class="text-center">Total</th>
                                <th class="text-center">Taux Rebus</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            data.forEach(d => {
                const dateFormat = new Date(d.date).toLocaleDateString('fr-FR');
                html += `
                    <tr>
                        <td><strong>${d.Numero_COMMANDES}</strong></td>
                        <td>${dateFormat}</td>
                        <td>${d.operateur || '-'}</td>
                        <td>${d.machine || '-'}</td>
                        <td class="text-center text-success">${formatNumber(d.total_conforme)}</td>
                        <td class="text-center text-danger">${formatNumber(d.total_rebus)}</td>
                        <td class="text-center">${formatNumber(d.total_produit)}</td>
                        <td class="text-center">
                            <span class="badge bg-danger">${d.taux_rebus}%</span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = html;
        })
        .catch(error => {
            console.error('Erreur:', error);
            document.getElementById('stats-additionnelles').innerHTML = 
                `<div class="alert alert-danger">Erreur: ${error.message}</div>`;
        });
}

// Cr√©er un nouveau contr√¥le
function creerControle() {
    // Validation avant envoi
    if (!validerFormulaire()) {
        return;
    }
    
    const formData = new FormData(document.getElementById('formNouveauControle'));
    const data = {};
    
    // R√©cup√©rer les donn√©es du formulaire
    for (let [key, value] of formData.entries()) {
        if (key.includes('[]')) {
            const fieldName = key.replace('[]', '');
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
        } else {
            data[key] = value;
        }
    }

    // G√©rer les s√©lections pour les op√©rateurs
    // Op√©rateur contr√¥le (multi-tags)
    const opCtrlTagsSel = document.querySelectorAll('#op_ctrl_tags .badge');
    const ctrlList = Array.from(opCtrlTagsSel).map(t => ({
        m: (t.getAttribute('data-m')||'').trim(),
        n: (t.getAttribute('data-n')||'').trim(),
        p: (t.getAttribute('data-p')||'').trim(),
    }));
    data.operateur_matricules = ctrlList.map(x => x.m);
    data.operateur_noms = ctrlList.map(x => x.n);
    data.operateur_prenoms = ctrlList.map(x => x.p);
    data.operateur = ctrlList.map(x => `${x.n} ${x.p}`.trim()).join(', ');
    
    // Op√©rateurs machine impression (tags s√©lectionn√©s + tableaux)
    const opImpTagsSel = document.querySelectorAll('#op_impression_tags .badge');
    data.operateur_machine_impression = Array.from(opImpTagsSel).map(t => `${t.getAttribute('data-n')} ${t.getAttribute('data-p')}`).join(', ');
    data.operateur_machine_impression_matricules = Array.from(opImpTagsSel).map(t => t.getAttribute('data-m'));
    data.operateur_machine_impression_noms = Array.from(opImpTagsSel).map(t => t.getAttribute('data-n'));
    data.operateur_machine_impression_prenoms = Array.from(opImpTagsSel).map(t => t.getAttribute('data-p'));
    
    // Op√©rateurs machine d√©coupe (d√©sactiv√©)
    data.operateur_machine_decoupe = '';
    
    // Chef de section (tag unique)
    const chefTag = document.querySelector('#op_chef_tags .badge');
    const chefM = chefTag ? (chefTag.getAttribute('data-m')||'').trim() : '';
    const chefN = chefTag ? (chefTag.getAttribute('data-n')||'').trim() : '';
    const chefP = chefTag ? (chefTag.getAttribute('data-p')||'').trim() : '';
    data.chef_matricule = chefM;
    data.chef_nom = chefN;
    data.chef_prenom = chefP;
    data.validation_chef = (chefN && chefP) ? `${chefN} ${chefP}` : '';
    
    // Organiser les tol√©rances (cl√© standard: tolerances)
    if (data.tolerance && data.quantite_conforme && data.quantite_non_conforme) {
        data.tolerances = [];
        for (let i = 0; i < data.tolerance.length; i++) {
            const tolLabel = (data.tolerance[i] || '').trim();
            const qConf = Array.isArray(data.quantite_conforme) ? data.quantite_conforme[i] : 0;
            const qNConf = Array.isArray(data.quantite_non_conforme) ? data.quantite_non_conforme[i] : 0;
            if (tolLabel !== '') {
                data.tolerances.push({
                    tolerance: tolLabel,
                    quantite_conforme: parseInt(qConf) || 0,
                    quantite_non_conforme: parseInt(qNConf) || 0
                });
            }
        }
    }
    
    // Supprimer les champs temporaires mais garder les tol√©rances structur√©es
    delete data.tolerance;
    delete data.quantite_conforme;
    delete data.quantite_non_conforme;
    
    // Afficher un indicateur de chargement
    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
    submitBtn.disabled = true;
    
    fetch('/projet10/api/controle', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
        if (response.status === 'success') {
            // Succ√®s
            showNotification('Contr√¥le cr√©√© avec succ√®s!', 'success');
            reinitialiserFormulaire();
            chargerControles();
            // Basculer vers l'onglet des contr√¥les
            document.getElementById('controles-tab').click();
        } else {
            showNotification('Erreur: ' + response.error, 'error');
        }
    })
    .catch(error => {
        console.error('Erreur:', error);
        showNotification('Erreur lors de la cr√©ation du contr√¥le', 'error');
    })
    .finally(() => {
        // Restaurer le bouton
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
}

// Mettre √† jour un contr√¥le
function updateControle(id) {
    const formData = new FormData(document.getElementById('formNouveauControle'));
    const data = {};
    for (let [key, value] of formData.entries()) {
        if (key.includes('[]')) {
            const fieldName = key.replace('[]', '');
            if (!data[fieldName]) data[fieldName] = [];
            data[fieldName].push(value);
        } else {
            data[key] = value;
        }
    }
    // Normaliser les tol√©rances comme dans creerControle()
    if (data.tolerance && data.quantite_conforme && data.quantite_non_conforme) {
        data.tolerances = [];
        for (let i = 0; i < data.tolerance.length; i++) {
            const tolLabel = (data.tolerance[i] || '').trim();
            const qConf = Array.isArray(data.quantite_conforme) ? data.quantite_conforme[i] : 0;
            const qNConf = Array.isArray(data.quantite_non_conforme) ? data.quantite_non_conforme[i] : 0;
            if (tolLabel !== '' || (parseInt(qConf)||0) > 0 || (parseInt(qNConf)||0) > 0) {
                data.tolerances.push({
                    tolerance: tolLabel,
                    quantite_conforme: parseInt(qConf) || 0,
                    quantite_non_conforme: parseInt(qNConf) || 0
                });
            }
        }
        delete data.tolerance;
        delete data.quantite_conforme;
        delete data.quantite_non_conforme;
    }
    // Op√©rateurs contr√¥le multi
    const opCtrlTagsSel = document.querySelectorAll('#op_ctrl_tags .badge');
    const ctrlList = Array.from(opCtrlTagsSel).map(t => ({
        m: (t.getAttribute('data-m')||'').trim(),
        n: (t.getAttribute('data-n')||'').trim(),
        p: (t.getAttribute('data-p')||'').trim(),
    }));
    data.operateur_matricules = ctrlList.map(x => x.m);
    data.operateur_noms = ctrlList.map(x => x.n);
    data.operateur_prenoms = ctrlList.map(x => x.p);
    data.operateur = ctrlList.map(x => `${x.n} ${x.p}`.trim()).join(', ');
    
    // Op√©rateurs machine impression (tags s√©lectionn√©s + tableaux)
    const opImpTagsSel = document.querySelectorAll('#op_impression_tags .badge');
    data.operateur_machine_impression = Array.from(opImpTagsSel).map(t => `${t.getAttribute('data-n')} ${t.getAttribute('data-p')}`).join(', ');
    data.operateur_machine_impression_matricules = Array.from(opImpTagsSel).map(t => t.getAttribute('data-m'));
    data.operateur_machine_impression_noms = Array.from(opImpTagsSel).map(t => t.getAttribute('data-n'));
    data.operateur_machine_impression_prenoms = Array.from(opImpTagsSel).map(t => t.getAttribute('data-p'));
    
    // Op√©rateurs machine d√©coupe (d√©sactiv√©)
    data.operateur_machine_decoupe = '';
    
    // Chef de section (tag unique)
    const chefTag = document.querySelector('#op_chef_tags .badge');
    const chefM = chefTag ? (chefTag.getAttribute('data-m')||'').trim() : '';
    const chefN = chefTag ? (chefTag.getAttribute('data-n')||'').trim() : '';
    const chefP = chefTag ? (chefTag.getAttribute('data-p')||'').trim() : '';
    data.chef_matricule = chefM;
    data.chef_nom = chefN;
    data.chef_prenom = chefP;
    data.validation_chef = (chefN && chefP) ? `${chefN} ${chefP}` : '';

    const submitBtn = document.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Mise √† jour...';
    submitBtn.disabled = true;

    fetch(`/projet10/api/controle/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    }).then(res => res.json())
      .then(response => {
        if (response.status === 'success') {
            showNotification('Contr√¥le mis √† jour', 'success');
            __EDIT_ID__ = null;
            reinitialiserFormulaire();
            chargerControles();
            document.getElementById('controles-tab').click();
        } else {
            showNotification('Erreur: ' + response.error, 'error');
        }
      })
      .catch(err => { console.error(err); showNotification('Erreur lors de la mise √† jour', 'error'); })
      .finally(() => { submitBtn.innerHTML = originalText; submitBtn.disabled = false; });
}

// Valider le formulaire
function validerFormulaire() {
    const dateControle = document.getElementById('date_controle').value;
    const opCtrlSelected = document.querySelector('#op_ctrl_tags .badge');
    const operateur = opCtrlSelected ? 'ok' : '';
    const numeroDossier = document.getElementById('Numero_COMMANDES').value;
    
    // Validation des champs obligatoires
    if (!dateControle) {
        showNotification('La date de contr√¥le est obligatoire', 'error');
        document.getElementById('date_controle').focus();
        return false;
    }
    
    if (!operateur) {
        showNotification('L\'op√©rateur est obligatoire', 'error');
        (document.getElementById('operateur_matricule')||{}).focus?.();
        return false;
    }
    
    if (!numeroDossier) {
        showNotification('Le num√©ro de dossier est obligatoire', 'error');
        document.getElementById('Numero_COMMANDES').focus();
        return false;
    }
    
    // Validation des tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    let hasValidTolerance = false;
    for (let i = 0; i < toleranceInputs.length; i++) {
        const tolerance = toleranceInputs[i].value.trim();
        const conforme = parseInt(conformeInputs[i].value) || 0;
        const nonConforme = parseInt(nonConformeInputs[i].value) || 0;
        
        if (tolerance && (conforme > 0 || nonConforme > 0)) {
            hasValidTolerance = true;
            break;
        }
    }
    
    if (!hasValidTolerance) {
        showNotification('Au moins une tol√©rance avec des quantit√©s doit √™tre renseign√©e', 'error');
        return false;
    }
    
    return true;
}

// Afficher une notification
function showNotification(message, type = 'info') {
    // Cr√©er l'√©l√©ment de notification
    const notification = document.createElement('div');
    notification.className = `alert alert-${type === 'error' ? 'danger' : type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Ajouter au DOM
    document.body.appendChild(notification);
    
    // Supprimer automatiquement apr√®s 5 secondes
    setTimeout(() => {
        if (notification.parentNode) {
            notification.remove();
        }
    }, 5000);
}

// Ajouter une tol√©rance
function ajouterTolerance() {
    const container = document.getElementById('tolerances-container');
    const div = document.createElement('div');
    div.className = 'tolerance-row row mb-2';
    div.innerHTML = `
        <div class="col-md-4">
            <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="quantite_conforme[]" placeholder="Quantit√© conforme" min="0">
        </div>
        <div class="col-md-3">
            <input type="number" class="form-control" name="quantite_non_conforme[]" placeholder="Quantit√© non conforme" min="0">
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-danger" onclick="supprimerTolerance(this)">Supprimer</button>
        </div>
    `;
    container.appendChild(div);
}

// Supprimer une tol√©rance
function supprimerTolerance(button) {
    button.closest('.tolerance-row').remove();
}

// R√©initialiser le formulaire
function reinitialiserFormulaire() {
    document.getElementById('formNouveauControle').reset();
    document.getElementById('tolerances-container').innerHTML = `
        <div class="tolerance-row row mb-2">
            <div class="col-md-4">
                <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="quantite_conforme[]" placeholder="Quantit√© conforme" min="0">
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control" name="quantite_non_conforme[]" placeholder="Quantit√© non conforme" min="0">
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-danger" onclick="supprimerTolerance(this)">Supprimer</button>
            </div>
        </div>
    `;
}

// Voir un contr√¥le
function voirControle(id) {
    fetch(`/projet10/api/controle/${id}`)
        .then(async res => {
            const data = await res.json().catch(() => ({ error: 'R√©ponse invalide' }));
            if (!res.ok || data.error) {
                showNotification(`Erreur lors du chargement du contr√¥le #${id}: ${data.error || res.statusText}`, 'error');
                return;
            }
            const c = data || {};
            const tolerances = Array.isArray(c.tolerances) ? c.tolerances : (Array.isArray(c['tol√©rances']) ? c['tol√©rances'] : []);

            // Fonction pour formater les nombres sans d√©cimales avec s√©parateurs de milliers
            function formatNumber(num) {
                if (num === '' || num === null || num === undefined) return '';
                const n = parseInt(num) || 0;
                return n.toLocaleString('fr-FR', { useGrouping: true, minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }

            // Calculer les totaux
            // IMPORTANT: Seule la derni√®re ligne compte pour les non-conformes (= rebus final)
            // Les non-conformes des lignes pr√©c√©dentes sont retri√©es avec tol√©rances plus √©lev√©es
            let totalConforme = 0;
            let totalNonConforme = 0; // Seule la derni√®re ligne non vide
            
            tolerances.forEach(t => {
                totalConforme += parseInt(t.quantite_conforme || 0);
            });
            
            // Trouver la derni√®re ligne non vide pour le rebus
            for (let i = tolerances.length - 1; i >= 0; i--) {
                const t = tolerances[i];
                if (t.quantite_conforme || t.quantite_non_conforme || t.tolerance) {
                    totalNonConforme = parseInt(t.quantite_non_conforme || 0);
                    break;
                }
            }

            // Construire 9 lignes (compl√©ter avec lignes vides si besoin)
            const rows = [];
            for (let i = 0; i < Math.max(9, tolerances.length); i++) {
                const t = tolerances[i] || { tolerance: '', quantite_conforme: '', quantite_non_conforme: '' };
                const qc = t.quantite_conforme ? formatNumber(t.quantite_conforme) : '';
                const qnc = t.quantite_non_conforme ? formatNumber(t.quantite_non_conforme) : '';
                rows.push(`
                    <tr>
                        <td style="border:1px solid #000; padding:6px; white-space:nowrap;">
                            Tol√©rance&nbsp;: ${t.tolerance || '................................'}
                        </td>
                        <td style="border:1px solid #000; padding:6px; text-align:center;">${qc}</td>
                        <td style="border:1px solid #000; padding:6px; text-align:center;">${qnc}</td>
                    </tr>
                `);
            }

            const dateAff = c.date_controle ? new Date(c.date_controle).toLocaleDateString('fr-FR') : '_________________';
            
            // Afficher les noms complets des op√©rateurs
            const opAff = (c.operateur || '_______________________________');
            const machineImpr = c.machine_impression || '';
            const opMachineImpr = c.operateur_machine_impression || '';
            const rebusAff = formatNumber(c.rebus || 0);
            const validationChef = c.validation_chef || '_______________________________';

            const html = `
                <div style="font-family: Arial, sans-serif; color:#000;">
                    <div style="border:2px solid #000; padding:10px; margin-bottom:16px;">
                        <div style="display:flex; align-items:center; justify-content:space-between;">
                            <div style="writing-mode: vertical-rl; text-orientation: mixed; font-weight:bold;">Formulaire</div>
                            <div style="text-align:center;">
                                <div style="font-weight:bold;">Feuille de suivi machine contr√¥le qualit√©</div>
                                <div style="font-size:12px; margin-top:4px; display:flex; gap:14px; justify-content:center;">
                                    <span>Code : FOR-SMI-14</span>
                                    <span>Version : 00</span>
                                    <span>Date : ${new Date().toLocaleDateString('fr-FR')}</span>
                                    <span>Page : 1/1</span>
                                </div>
                            </div>
                            <div style="text-align:right;">
                                <div style="font-weight:bold;">NOVA</div>
                            </div>
                        </div>
                    </div>

                    <div style="border:1px solid #000; padding:8px; margin-bottom:16px;">
                        <div style="display:flex; gap:24px; flex-wrap:wrap;">
                            <div>Date : ${dateAff}</div>
                            <div>N¬∞ dossier : ${c.Numero_COMMANDES || '_________________'}</div>
                        </div>
                        <div style="margin-top:10px;">op√©rateur : ${opAff}</div>
                        ${machineImpr ? `<div style="margin-top:6px;">Machine Impression : ${machineImpr}</div>` : ''}
                        ${opMachineImpr ? `<div style="margin-top:6px;">Op√©rateur Machine Impression : ${opMachineImpr}</div>` : ''}
                    </div>

                    <div class="table-responsive" style="margin-top:8px;">
                        <table style="width:100%; border-collapse:collapse;">
                            <thead>
                                <tr>
                                    <th style="border:1px solid #000; padding:6px; text-align:center; width:40%;">les tol√©rances des triages</th>
                                    <th style="border:1px solid #000; padding:6px; text-align:center; width:30%;">Quantit√© Conforme</th>
                                    <th style="border:1px solid #000; padding:6px; text-align:center; width:30%;">Quantit√© Non-conforme</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rows.join('')}
                                <tr style="background-color:#f0f0f0; font-weight:bold;">
                                    <td style="border:1px solid #000; padding:6px; text-align:right;">TOTAL :</td>
                                    <td style="border:1px solid #000; padding:6px; text-align:center;">${formatNumber(totalConforme)}</td>
                                    <td style="border:1px solid #000; padding:6px; text-align:center;">${formatNumber(totalNonConforme)} <span style="font-size:0.85em; font-weight:normal;">(derni√®re ligne)</span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <div style="margin-top:16px;">
                        <div style="margin-bottom:8px;">Rebus : ${rebusAff}</div>
                        <div>Validation du chef section : ${validationChef}</div>
                    </div>
                </div>
            `;

            const container = document.getElementById('viewControleContent');
            if (container) container.innerHTML = html;
            const modalEl = document.getElementById('viewControleModal');
            if (modalEl) {
                const bsModal = new bootstrap.Modal(modalEl);
                bsModal.show();
            }
            
            // Ajouter les boutons Imprimer et PDF dans le footer du modal
            const modalFooter = modalEl.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.innerHTML = `
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fermer</button>
                    <button type="button" class="btn btn-primary" onclick="imprimerFiche()"><i class="fas fa-print"></i> Imprimer</button>
                    <button type="button" class="btn btn-success" onclick="enregistrerPDF(${id})"><i class="fas fa-file-pdf"></i> Enregistrer PDF</button>
                `;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            showNotification('Erreur lors du chargement du contr√¥le', 'error');
        });
}

// Imprimer la fiche de contr√¥le
function imprimerFiche() {
    const printContents = document.getElementById('viewControleContent').innerHTML;
    
    // Cr√©er une nouvelle fen√™tre pour l'impression
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Fiche de Contr√¥le Qualit√©</title>');
    printWindow.document.write('<style>body { font-family: Arial, sans-serif; margin: 20px; } @media print { body { margin: 0; } @page { size: A4; margin: 10mm; } }</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(printContents);
    printWindow.document.write('<' + 'script>window.onload = function() { window.print(); window.onafterprint = function() { window.close(); }; };<' + '/script>');
    printWindow.document.write('</body></html>');
    printWindow.document.close();
}

// Enregistrer la fiche en PDF
function enregistrerPDF(controleId) {
    showNotification('G√©n√©ration du PDF en cours...', 'info');
    
    // Utiliser html2pdf.js pour g√©n√©rer le PDF
    const element = document.getElementById('viewControleContent');
    const opt = {
        margin: 10,
        filename: `Fiche_Controle_Qualite_${controleId}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    };
    
    // V√©rifier si html2pdf est charg√©
    if (typeof html2pdf !== 'undefined') {
        html2pdf().set(opt).from(element).save().then(() => {
            showNotification('PDF enregistr√© avec succ√®s', 'success');
        }).catch(err => {
            console.error('Erreur g√©n√©ration PDF:', err);
            showNotification('Erreur lors de la g√©n√©ration du PDF', 'error');
        });
    } else {
        // Fallback: utiliser window.print
        showNotification('Utilisez la fonction Imprimer puis "Enregistrer au format PDF"', 'warning');
        imprimerFiche();
    }
}

// √âditer un contr√¥le
function editerControle(id) {
    __EDIT_ID__ = id;
    fetch(`/projet10/api/controle/${id}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) { showNotification('Erreur: '+data.error, 'error'); return; }
            // Remplir formulaire
            document.getElementById('nouveau-tab').click();
            document.getElementById('date_controle').value = (data.date_controle||'').split('T')[0] || '';
            document.getElementById('Numero_COMMANDES').value = data.Numero_COMMANDES || '';
            // Op√©rateur contr√¥le (multi)
            const opCtrlTags = document.getElementById('op_ctrl_tags');
            opCtrlTags.innerHTML='';
            const list = (data.operateur||'').split(',').map(s=>s.trim()).filter(Boolean);
            // si backend stocke s√©par√©ment, pr√©f√©rer champs d√©di√©s
            if (Array.isArray(data.operateur_noms) && Array.isArray(data.operateur_prenoms) && Array.isArray(data.operateur_matricules)) {
                for (let i=0; i<data.operateur_matricules.length; i++) {
                    const m = data.operateur_matricules[i]||'';
                    const n = data.operateur_noms[i]||'';
                    const p = data.operateur_prenoms[i]||'';
                    const tag = document.createElement('span');
                    tag.className='badge bg-primary';
                    tag.textContent = `${m} ‚Äî ${n} ${p}`;
                    tag.setAttribute('data-m', m);
                    tag.setAttribute('data-n', n);
                    tag.setAttribute('data-p', p);
                    tag.style.cursor='pointer';
                    tag.addEventListener('click', ()=>tag.remove());
                    opCtrlTags.appendChild(tag);
                }
            } else if (list.length) {
                list.forEach(full=>{
                    const parts = full.split(' ');
                    const n = parts[0]||''; const p = parts.slice(1).join(' ');
                    const m = '';
                    const tag = document.createElement('span');
                    tag.className='badge bg-primary';
                    tag.textContent = `${m} ‚Äî ${n} ${p}`;
                    tag.setAttribute('data-m', m);
                    tag.setAttribute('data-n', n);
                    tag.setAttribute('data-p', p);
                    tag.style.cursor='pointer';
                    tag.addEventListener('click', ()=>tag.remove());
                    opCtrlTags.appendChild(tag);
                });
            }
            document.getElementById('machine_impression').value = data.machine_impression || '';
            // Op√©rateurs machine impression (tags)
            const opImpTags = document.getElementById('op_impression_tags');
            opImpTags.innerHTML = '';
            if (Array.isArray(data.operateur_machine_impression_matricules) && Array.isArray(data.operateur_machine_impression_noms) && Array.isArray(data.operateur_machine_impression_prenoms)) {
                for (let i=0; i<data.operateur_machine_impression_matricules.length; i++) {
                    const m = data.operateur_machine_impression_matricules[i]||'';
                    const n = data.operateur_machine_impression_noms[i]||'';
                    const p = data.operateur_machine_impression_prenoms[i]||'';
                    const tag = document.createElement('span');
                    tag.className = 'badge bg-primary';
                    tag.textContent = `${m} ‚Äî ${n} ${p}`;
                    tag.setAttribute('data-m', m);
                    tag.setAttribute('data-n', n);
                    tag.setAttribute('data-p', p);
                    tag.style.cursor = 'pointer';
                    tag.addEventListener('click', () => tag.remove());
                    opImpTags.appendChild(tag);
                }
            } else if (typeof data.operateur_machine_impression === 'string' && data.operateur_machine_impression.trim()) {
                data.operateur_machine_impression.split(',').map(s=>s.trim()).forEach(full=>{
                    const parts = full.split(' ');
                    const n = parts[0]||''; const p = parts.slice(1).join(' ');
                    const m = '';
                    const tag = document.createElement('span');
                    tag.className='badge bg-primary';
                    tag.textContent = `${m} ‚Äî ${n} ${p}`;
                    tag.setAttribute('data-m', m);
                    tag.setAttribute('data-n', n);
                    tag.setAttribute('data-p', p);
                    tag.style.cursor='pointer';
                    tag.addEventListener('click', ()=>tag.remove());
                    opImpTags.appendChild(tag);
                });
            }
            // Chef section
            if (data.chef_matricule) {
                const sel = document.getElementById('chef_matricule');
                if (sel) sel.value = data.chef_matricule;
            }
            const chefNomEl = document.getElementById('chef_nom');
            const chefPrenomEl = document.getElementById('chef_prenom');
            if (data.chef_nom && chefNomEl) chefNomEl.value = data.chef_nom;
            if (data.chef_prenom && chefPrenomEl) chefPrenomEl.value = data.chef_prenom;
            if (!data.chef_nom && !data.chef_prenom && typeof data.validation_chef === 'string') {
                const parts = data.validation_chef.split(' ');
                if (chefNomEl) chefNomEl.value = parts[0]||'';
                if (chefPrenomEl) chefPrenomEl.value = parts.slice(1).join(' ');
            }
            // Tol√©rances (accepte 'tolerances' ou 'tol√©rances') ‚Äî garder la m√™me grille qu'en cr√©ation
            (function(){
                const list = Array.isArray(data.tolerances) ? data.tolerances : (Array.isArray(data['tol√©rances']) ? data['tol√©rances'] : []);
                const tbody = document.getElementById('tolerances-container');
                // 1) S'assurer d'avoir au moins 9 lignes visibles (comme en saisie)
                function appendRow(){
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <span class="me-2">Tol√©rance :</span>
                                <input type="text" class="form-control" name="tolerance[]" placeholder="Type de tol√©rance">
                            </div>
                        </td>
                        <td class="text-center">
                            <input type="number" class="form-control text-center" name="quantite_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                        </td>
                        <td class="text-center">
                            <input type="number" class="form-control text-center" name="quantite_non_conforme[]" placeholder="0" min="0" onchange="calculerTotaux()">
                        </td>
                    `;
                    tbody.appendChild(tr);
                }
                // Compl√©ter jusqu'√† max(9, nb tol√©rances)
                const need = Math.max(9, list.length);
                while (tbody.querySelectorAll('tr').length < need) appendRow();
                // 2) Vider les champs existants puis r√©injecter les valeurs enregistr√©es
                const tolInputs = tbody.querySelectorAll('input[name="tolerance[]"]');
                const qcInputs = tbody.querySelectorAll('input[name="quantite_conforme[]"]');
                const qnInputs = tbody.querySelectorAll('input[name="quantite_non_conforme[]"]');
                tolInputs.forEach(i=> i.value = '');
                qcInputs.forEach(i=> i.value = '');
                qnInputs.forEach(i=> i.value = '');
                for (let i=0; i<list.length; i++){
                    tolInputs[i].value = list[i].tolerance || '';
                    qcInputs[i].value = list[i].quantite_conforme || 0;
                    qnInputs[i].value = list[i].quantite_non_conforme || 0;
                }
            })();
            // Rebus et tol√©rances (si disponibles simplifi√©)
            document.getElementById('rebus').value = data.rebus || 0;
            // Chef section (tag)
            (function(){
                const opChefTags = document.getElementById('op_chef_tags');
                if (!opChefTags) return;
                opChefTags.innerHTML = '';
                const m = data.chef_matricule || '';
                let n = data.chef_nom || '';
                let p = data.chef_prenom || '';
                if ((!n || !p) && typeof data.validation_chef === 'string') {
                    const parts = data.validation_chef.split(' ');
                    n = parts[0]||''; p = parts.slice(1).join(' ');
                }
                if (m || n || p) {
                    const tag = document.createElement('span');
                    tag.className='badge bg-success';
                    tag.textContent = `${m} ‚Äî ${n} ${p}`;
                    tag.setAttribute('data-m', m);
                    tag.setAttribute('data-n', n);
                    tag.setAttribute('data-p', p);
                    tag.style.cursor='pointer';
                    tag.addEventListener('click', ()=>{ opChefTags.innerHTML=''; });
                    opChefTags.appendChild(tag);
                }
            })();
            calculerTotaux();
        })
        .catch(err => { console.error(err); showNotification('Erreur de chargement', 'error'); });
}

// Actualiser les contr√¥les
function actualiserControles() {
    chargerControles();
}

// Calculer les totaux automatiquement
function calculerTotaux() {
    let totalConforme = 0;
    let rebusCalcule = 0; // Quantit√© non-conforme de la derni√®re ligne
    
    // Calculer les totaux des tol√©rances
    const inputsConforme = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const inputsNonConforme = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    inputsConforme.forEach(input => {
        totalConforme += parseInt(input.value) || 0;
    });
    
    // LOGIQUE M√âTIER : Seule la derni√®re ligne non vide compte pour le rebus
    // Les non-conformes des lignes pr√©c√©dentes sont retri√©es avec tol√©rances plus √©lev√©es
    for (let i = inputsNonConforme.length - 1; i >= 0; i--) {
        const val = parseInt(inputsNonConforme[i].value) || 0;
        const valConf = parseInt(inputsConforme[i].value) || 0;
        if (val > 0 || valConf > 0) {
            rebusCalcule = val;
            break;
        }
    }
    
    // Mettre √† jour automatiquement le champ rebus
    const rebusInput = document.getElementById('rebus');
    if (rebusInput) {
        rebusInput.value = rebusCalcule;
    }
    
    // Mettre √† jour les totaux dans le tableau
    document.getElementById('total-conforme').textContent = totalConforme.toLocaleString('fr-FR');
    document.getElementById('total-non-conforme').textContent = rebusCalcule.toLocaleString('fr-FR') + ' (derni√®re ligne)';
    
    // Mettre √† jour le r√©sum√©
    document.getElementById('resume-conforme').textContent = totalConforme.toLocaleString('fr-FR');
    document.getElementById('resume-non-conforme').textContent = rebusCalcule.toLocaleString('fr-FR');
    document.getElementById('resume-rebus').textContent = rebusCalcule.toLocaleString('fr-FR');
    document.getElementById('resume-total').textContent = (totalConforme + rebusCalcule).toLocaleString('fr-FR');
}

// Imprimer le formulaire
function imprimerFormulaire() {
    // Cr√©er une nouvelle fen√™tre pour l'impression
    const printWindow = window.open('', '_blank');
    
    // R√©cup√©rer les donn√©es du formulaire
    const dateControle = document.getElementById('date_controle').value;
    const operateur = `${document.getElementById('operateur_nom')?.value||''} ${document.getElementById('operateur_prenom')?.value||''}`.trim();
    const numeroDossier = document.getElementById('Numero_COMMANDES').value;
    const rebus = document.getElementById('rebus').value;
    const validationChef = document.getElementById('validation_chef').value;
    
    // Construire le contenu HTML pour l'impression
    let printContent = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Feuille de suivi machine contr√¥le qualit√©</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .header { text-align: center; border: 2px solid #000; padding: 10px; margin-bottom: 20px; }
                .form-title { font-size: 18px; font-weight: bold; margin-bottom: 10px; }
                .form-info { font-size: 12px; margin-bottom: 5px; }
                .form-section { margin-bottom: 20px; }
                .form-row { display: flex; margin-bottom: 10px; }
                .form-label { font-weight: bold; margin-right: 10px; min-width: 120px; }
                .form-value { border-bottom: 1px solid #000; flex: 1; padding: 5px; }
                .table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
                .table th, .table td { border: 1px solid #000; padding: 8px; text-align: center; }
                .table th { background-color: #f0f0f0; font-weight: bold; }
                .table .tolerance-col { text-align: left; }
                .footer { margin-top: 30px; }
                .footer-row { display: flex; margin-bottom: 15px; }
                @media print { body { margin: 0; } }
            </style>
        </head>
        <body>
            <div class="header">
                <div style="display: flex; align-items: center; justify-content: space-between;">
                    <div style="writing-mode: vertical-rl; text-orientation: mixed; font-weight: bold;">Formulaire</div>
                    <div>
                        <div class="form-title">Feuille de suivi machine contr√¥le qualit√©</div>
                        <div class="form-info">Code : FOR-SMI-14</div>
                        <div class="form-info">Version : 00</div>
                        <div class="form-info">Date : ${new Date().toLocaleDateString('fr-FR')}</div>
                        <div class="form-info">Page : 1/1</div>
                    </div>
                    <div style="text-align: right;">
                        <div style="font-weight: bold;">NOVA</div>
                    </div>
                </div>
            </div>
            
            <div class="form-section">
                <div class="form-row">
                    <div class="form-label">Date :</div>
                    <div class="form-value">${dateControle || '_________________'}</div>
                </div>
                <div class="form-row">
                    <div class="form-label">Op√©rateur :</div>
                    <div class="form-value">${operateur || '_________________'}</div>
                </div>
                <div class="form-row">
                    <div class="form-label">N¬∞ dossier :</div>
                    <div class="form-value">${numeroDossier || '_________________'}</div>
                </div>
            </div>
            
            <table class="table">
                <thead>
                    <tr>
                        <th style="width: 40%;">Les tol√©rances des triages</th>
                        <th style="width: 30%;">Quantit√© Conforme</th>
                        <th style="width: 30%;">Quantit√© Non-conforme</th>
                    </tr>
                </thead>
                <tbody>`;
    
    // Ajouter les lignes de tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    for (let i = 0; i < 9; i++) {
        const tolerance = toleranceInputs[i] ? toleranceInputs[i].value : '';
        const conforme = conformeInputs[i] ? conformeInputs[i].value : '';
        const nonConforme = nonConformeInputs[i] ? nonConformeInputs[i].value : '';
        
        printContent += `
            <tr>
                <td class="tolerance-col">Tol√©rance : ${tolerance || '_________________'}</td>
                <td>${conforme || '0'}</td>
                <td>${nonConforme || '0'}</td>
            </tr>`;
    }
    
    printContent += `
                </tbody>
            </table>
            
            <div class="footer">
                <div class="footer-row">
                    <div class="form-label">Rebus :</div>
                    <div class="form-value">${rebus || '0'}</div>
                </div>
                <div class="footer-row">
                    <div class="form-label">Validation du chef section :</div>
                    <div class="form-value">${validationChef || '_________________'}</div>
                </div>
            </div>
        </body>
        </html>`;
    
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
}

// R√©initialiser le formulaire avec la structure correcte
function reinitialiserFormulaire() {
    document.getElementById('formNouveauControle').reset();
    
    // R√©initialiser tous les champs de tol√©rances
    const toleranceInputs = document.querySelectorAll('input[name="tolerance[]"]');
    const conformeInputs = document.querySelectorAll('input[name="quantite_conforme[]"]');
    const nonConformeInputs = document.querySelectorAll('input[name="quantite_non_conforme[]"]');
    
    toleranceInputs.forEach(input => input.value = '');
    conformeInputs.forEach(input => input.value = '');
    nonConformeInputs.forEach(input => input.value = '');
    
    // R√©initialiser l'auto-compl√©tion op√©rateur
    const opCtrlTagsEl = document.getElementById('op_ctrl_tags');
    if (opCtrlTagsEl) { opCtrlTagsEl.innerHTML = ''; }
    
    (function(){
        const cm = document.getElementById('chef_matricule'); if (cm) cm.selectedIndex = 0;
        const cn = document.getElementById('chef_nom'); if (cn) cn.value = '';
        const cp = document.getElementById('chef_prenom'); if (cp) cp.value = '';
    })();
    
    // R√©initialiser les tags op√©rateurs multi-s√©lection
    const impTags = document.getElementById('op_impression_tags'); if (impTags) impTags.innerHTML = '';
    const decTags = document.getElementById('op_decoupe_tags'); if (decTags) decTags.innerHTML = '';
    
    // R√©initialiser les totaux
    calculerTotaux();
    
    // D√©finir la date d'aujourd'hui
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('date_controle').value = today;
}
</script>
{% endblock %}