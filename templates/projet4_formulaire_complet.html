
{% extends "base.html" %}
{% block title %}Rapport de Visite Client{% endblock %}

{% block content %}
<h2>Rapport de Visite Client</h2>
<form method="POST">
    <input type="hidden" name="id_societe" id="id_societe">
    <input type="hidden" name="id_personne" id="id_personne">
    <input type="hidden" name="is_new_prospect" id="is_new_prospect" value="false">

    <!-- Case "Nouveau prospect" -->
    <div>
        <label><input type="checkbox" id="checkbox_new_prospect"> Nouveau prospect</label>
    </div>

    <!-- Identification client -->
    <fieldset>
        <legend>Identification client</legend>
        <label for="raison_sociale">Raison sociale :</label><br>
        <input type="text" name="raison_sociale" id="raison_sociale" required autocomplete="off"><br><br>

        <label for="type_client">Type de client :</label>
        <select name="type_client" id="type_client" required>
            <option value="Client">Client</option>
            <option value="Prospect">Prospect</option>
            <option value="Inactif">Client sans commande (12 mois)</option>
        </select><br><br>

        <label for="ville">Ville :</label>
        <input type="text" name="ville" id="ville"><br><br>

        <label for="pays">Pays :</label>
        <input type="text" name="pays" id="pays"><br><br>

        <label for="telephone">Téléphone :</label>
        <input type="tel" name="telephone" id="telephone"><br><br>

        <label for="fax">Fax :</label>
        <input type="text" name="fax" id="fax"><br><br>

        <label for="email">Adresse mail :</label>
        <input type="email" name="email" id="email"><br><br>
    </fieldset>

    <!-- Personne rencontrée -->
    <fieldset>
        <legend>Personne rencontrée</legend>

        <!-- Choix contact si société connue -->
        <div id="contact_select_wrapper" style="display: none;">
            <label for="contact_selector">Choisir un contact :</label>
            <select id="contact_selector"></select>
            <button type="button" id="btn_add_new_contact" style="margin-left: 10px; display: none;">➕ Ajouter un contact</button><br><br>
        </div>

        <label for="contact_nom">Nom :</label>
        <input type="text" name="contact_nom" id="contact_nom"><br><br>

        <label for="contact_fonction">Fonction :</label>
        <input type="text" name="contact_fonction" id="contact_fonction"><br><br>

        <label for="contact_email">Email :</label>
        <input type="email" name="contact_email" id="contact_email"><br><br>

        <label for="contact_telephone">Téléphone :</label>
        <input type="text" name="contact_telephone" id="contact_telephone"><br><br>

        <!-- Select fonction si manquante -->
        <div id="fonctionSelectWrapper" style="display: none;">
            <label for="id_fonction">Ajouter une fonction :</label>
            <select name="id_fonction" id="id_fonction"></select><br><br>
        </div>
    </fieldset>

    <!-- Visite -->
    <fieldset>
        <legend>Détails de la visite</legend>
        <label for="resume_visite">Résumé de la visite :</label><br>
        <textarea name="resume_visite" id="resume_visite" rows="5" cols="50"></textarea><br><br>
    </fieldset>

    <button type="submit">Enregistrer</button>
</form>

<div id="suggestions"></div>
{% endblock %}

{% block extra_js %}
<style>
#suggestion-list div {
    transition: background-color 0.2s ease-in-out, font-weight 0.2s ease-in-out, box-shadow 0.2s;
    border-radius: 4px;
    margin: 2px;
}
#suggestion-list div:hover {
    background-color: #e6f3ff;
    font-weight: bold;
    box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}
</style>
<script>
function chargerSocieteSelectionnee(soc) {
    document.getElementById("raison_sociale").value = soc.raison_sociale;
    document.getElementById("ville").value = soc.ville || "";
    document.getElementById("pays").value = soc.pays || "";
    document.getElementById("telephone").value = soc.telephone || "";
    document.getElementById("fax").value = soc.fax || "";
    document.getElementById("email").value = soc.email || "";
    document.getElementById("id_societe").value = soc.id;
    document.getElementById("is_new_prospect").value = "false";
}

document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("raison_sociale");
    const suggestionsBox = document.createElement("div");
    suggestionsBox.id = "suggestion-list";
    suggestionsBox.style.border = "1px solid #ccc";
    suggestionsBox.style.position = "absolute";
    suggestionsBox.style.backgroundColor = "white";
    suggestionsBox.style.zIndex = "1000";
    suggestionsBox.style.maxHeight = "200px";
    suggestionsBox.style.overflowY = "auto";
    suggestionsBox.style.display = "none";
    input.parentNode.appendChild(suggestionsBox);

    input.addEventListener("input", function () {
        const query = this.value.trim();
        if (query.length < 2) {
            suggestionsBox.style.display = "none";
            suggestionsBox.innerHTML = "";
            return;
        }

        fetch(`/projet4/api/societes?query=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {
                suggestionsBox.innerHTML = "";
                if (data.length === 0) {
                    suggestionsBox.style.display = "none";
                    return;
                }

                data.forEach(soc => {
                    const option = document.createElement("div");
                    option.textContent = soc.raison_sociale + (soc.ville ? ` (${soc.ville})` : "");
                    option.style.padding = "5px";
                    option.style.cursor = "pointer";
                    option.addEventListener("click", () => {
                        chargerSocieteSelectionnee(soc);
                        suggestionsBox.innerHTML = "";
                        suggestionsBox.style.display = "none";
                    });
                    suggestionsBox.appendChild(option);
                });
                suggestionsBox.style.display = "block";
            });
    });

    document.addEventListener("click", function (e) {
        if (!suggestionsBox.contains(e.target) && e.target !== input) {
            suggestionsBox.innerHTML = "";
            suggestionsBox.style.display = "none";
        }
    });
});
</script>
{{ super() }}
{% endblock %}
