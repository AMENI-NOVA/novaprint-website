{% extends (request.args.get('embed') == '1' and "base_embed.html" or "base.html") %}

{% block title %}Nouveau Traitement - Projet 11{% endblock %}

{% block head %}
<!-- Font Awesome pour les ic√¥nes -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- Select2 pour recherche avanc√©e -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<style>
    .chrono-box {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 20px;
        border-radius: 10px;
        text-align: center;
        margin: 20px 0;
    }
    .chrono-display {
        font-size: 48px;
        font-weight: bold;
        font-family: 'Courier New', monospace;
        text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    .badge-service {
        font-size: 14px;
        padding: 8px 15px;
    }
    .info-prevue {
        background: #e3f2fd;
        border-left: 4px solid #2196F3;
        padding: 15px;
        margin: 10px 0;
    }
    .traitement-existant {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 10px;
        margin: 5px 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1>
                        <i class="fas fa-plus-circle"></i> Nouveau Traitement de Production
                    </h1>
                </div>

            <div class="card">
                <div class="card-body">
                    <form id="formNouveauTraitement">
                        <!-- √âTAPE 1: S√©lection du num√©ro de commande -->
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <label for="numero_commande" class="form-label">
                                    <strong>1Ô∏è‚É£ Num√©ro de Commande (Dossier) *</strong>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="numero_commande"
                                       name="numero_commande"
                                       list="commandes_list"
                                       placeholder="-- Tapez pour rechercher une commande --"
                                       autocomplete="off">
                                <datalist id="commandes_list">
                                    {% for cmd in commandes %}
                                    <option value="{{ cmd.numero }}" 
                                            data-reference="{{ cmd.reference }}" 
                                            data-client="{{ cmd.client }}"
                                            data-qte="{{ cmd.qte_commande }}">
                                        {{ cmd.numero }} - {{ cmd.client }}{% if cmd.reference %} - {{ cmd.reference }}{% endif %}
                                    </option>
                                    {% endfor %}
                                </datalist>
                                <small class="text-muted">Choisissez d'abord le dossier/commande que vous voulez traiter</small>
                            </div>
                        </div>

                        <!-- Info commande s√©lectionn√©e -->
                        <div id="infoCommandeSelectionnee" style="display: none;">
                            <div class="alert alert-info">
                                <h5>üìã Commande S√©lectionn√©e</h5>
                                <div class="row">
                                    <div class="col-md-4">
                                        <strong>N¬∞ Commande:</strong> <span id="info_numero_cmd"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>Client:</strong> <span id="info_client_cmd"></span>
                                    </div>
                                    <div class="col-md-4">
                                        <strong>R√©f√©rence:</strong> <span id="info_reference_cmd"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- √âTAPE 2: S√©lection du SERVICE -->
                        <div class="row" id="sectionService" style="display: none;">
                            <div class="col-md-12 mb-3">
                                <label for="service_prevu" class="form-label">
                                    <strong>2Ô∏è‚É£ Service de Production *</strong>
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="service_prevu"
                                       name="service_prevu"
                                       list="services_list"
                                       placeholder="-- Tapez pour rechercher un service --"
                                       autocomplete="off">
                                <datalist id="services_list">
                                    <!-- Les options seront ajout√©es dynamiquement -->
                                </datalist>
                                <small class="text-muted">Choisissez le service dans lequel vous allez produire</small>
                            </div>
                        </div>

                        <!-- √âTAPE 3: Informations PR√âVUES (automatiques) -->
                        <div id="infoPrevues" style="display: none;">
                            <div class="info-prevue">
                                <h5><i class="fas fa-info-circle"></i> Informations Pr√©vues (Automatiques)</h5>
                                <div class="row">
                                    <div class="col-md-3">
                                        <strong>Machine pr√©vue:</strong><br>
                                        <span id="machine_prevue" class="badge bg-primary badge-service"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Quantit√© pr√©vue:</strong><br>
                                        <span id="qte_prevue" class="badge bg-info badge-service"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>Temps pr√©vu:</strong><br>
                                        <span id="temps_prevu" class="badge bg-secondary badge-service"></span>
                                    </div>
                                    <div class="col-md-3">
                                        <strong>ID Fiche:</strong><br>
                                        <span id="id_fiche_info" class="badge bg-dark badge-service"></span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- √âTAPE 4: Traitements existants du service -->
                        <div id="traitementsExistants" style="display: none;">
                            <div class="alert alert-warning">
                                <h5><i class="fas fa-clock-rotate-left"></i> Productions D√©j√† Enregistr√©es dans ce Service</h5>
                                <div id="listeTraitementsService"></div>
                                <hr>
                                <div id="totauxService"></div>
                            </div>
                        </div>

                        <hr id="separator" style="display: none;">

                        <!-- √âTAPE 5: Chronom√®tre et donn√©es de saisie -->
                        <div id="sectionSaisie" style="display: none;">
                            <!-- Chronom√®tre -->
                            <div class="chrono-box" id="chronoBox" style="display: none;">
                                <h5><i class="fas fa-stopwatch"></i> Chronom√®tre de Production</h5>
                                <div class="chrono-display" id="chronoDisplay">00:00:00</div>
                                <small>D√©marr√© √†: <span id="chronoStart"></span></small>
                            </div>

                            <h5 class="mb-3">3Ô∏è‚É£ Informations du Traitement Actuel</h5>

                            <div class="row">
                                <!-- Nombre de Personnes -->
                                <div class="col-md-6 mb-3">
                                    <label for="nb_pers" class="form-label">
                                        <strong>Nombre de Personnes *</strong>
                                    </label>
                                    <input type="number" class="form-control" id="nb_pers" name="nb_pers" min="1" max="10" value="1">
                                    <small class="text-muted">Nombre d'op√©rateurs travaillant ensemble sur ce poste</small>
                                </div>

                                <!-- Machine R√©elle -->
                                <div class="col-md-6 mb-3">
                                    <label for="machine_reelle" class="form-label">
                                        <strong>Machine R√©elle Utilis√©e</strong>
                                    </label>
                                    <select class="form-select" id="machine_reelle" name="machine_reelle">
                                        <option value="">-- S√©lectionnez d'abord un service --</option>
                                    </select>
                                    <small class="text-muted">Machines du service s√©lectionn√© uniquement</small>
                                </div>
                            </div>

                            <!-- Zone dynamique des op√©rateurs -->
                            <div id="operateurs_container">
                                <div class="row">
                    <div class="col-md-12 mb-3">
                        <label class="form-label">
                            <strong>Op√©rateur Principal *</strong>
                        </label>
                    </div>
                                </div>
                                <div id="operateurs_fields">
                                    <!-- Le champ op√©rateur sera g√©n√©r√© dynamiquement ici -->
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="pdt_c" class="form-label">
                                        <strong>Quantit√© produite conforme *</strong>
                                    </label>
                                    <input type="number" class="form-control" id="pdt_c" name="pdt_c" min="0" value="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="pdt_nnc" class="form-label">
                        <strong>Non conformes (bonnes feuilles)</strong>
                                    </label>
                                    <input type="number" class="form-control" id="pdt_nnc" name="pdt_nnc" min="0" value="0">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="pdt_anc" class="form-label">
                        <strong>Non conformes (macules)</strong>
                                    </label>
                                    <input type="number" class="form-control" id="pdt_anc" name="pdt_anc" min="0" value="0">
                                </div>
                            </div>

                            <!-- Champs cach√©s -->
                            <input type="hidden" id="dte_deb" name="dte_deb">
                            <input type="hidden" id="dte_fin" name="dte_fin">
                            <input type="hidden" id="id_fiche_travail" name="id_fiche_travail">
                            <input type="hidden" id="traitement_id" name="traitement_id">

                            <hr>

                            <div class="d-flex justify-content-end gap-2">
                                <button type="button" class="btn btn-secondary" onclick="window.history.back()">
                                    <i class="fas fa-times"></i> Annuler
                                </button>
                                <button type="submit" class="btn btn-success btn-lg" id="btnEnregistrer">
                                    <i class="fas fa-stop-circle"></i> Arr√™ter et Enregistrer
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================================
// VARIABLES GLOBALES
// ============================================================================
let chronoStart = null;
let chronoInterval = null;
let currentNumeroCommande = null;
let currentService = null;
let currentFicheId = null;
let currentTraitementId = null;
let startTraitementEnCours = false;
const estModeEmbed = (new URLSearchParams(window.location.search).get('embed') === '1') || (window.self !== window.top);
let servicesDisponibles = [];
let storedFormValues = null;
let restaurationEtatPlanifiee = false;

function setCurrentTraitementId(id) {
    currentTraitementId = id;
    const hidden = document.getElementById('traitement_id');
    if (hidden) {
        hidden.value = id ? id : '';
    }
}

function mettreAJourMatriculeDepuisTexte(element, texte) {
    if (!element) return;
    const valeur = typeof texte === 'string' ? texte : element.value || '';
    const match = valeur.match(/Matricule:\s*(\d+)/);
    element.setAttribute('data-matricule', match ? match[1] : '');
}

function synchroniserMatriculesOperateurs() {
    document.querySelectorAll('.operateur-input').forEach(input => {
        mettreAJourMatriculeDepuisTexte(input);
    });
}

function restaurerChronoDepuisFormulaire() {
    const dteDebInput = document.getElementById('dte_deb');
    const traitementInput = document.getElementById('traitement_id');
    if (!dteDebInput || !traitementInput) return false;
    const valeurDebut = dteDebInput.value;
    const valeurTraitement = traitementInput.value;
    if (!valeurDebut || !valeurTraitement) return false;
    const parsed = new Date(valeurDebut);
    if (Number.isNaN(parsed.getTime())) return false;
    setCurrentTraitementId(parseInt(valeurTraitement, 10) || null);
    chronoStart = parsed;
    if (chronoInterval) {
        clearInterval(chronoInterval);
    }
    $('#chronoBox').css('display', 'block');
    $('#chronoStart').text(parsed.toLocaleString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    }));
    chronoInterval = setInterval(() => {
        const now = new Date();
        const diff = now - chronoStart;
        const heures = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const secondes = Math.floor((diff % 60000) / 1000);
        $('#chronoDisplay').text(
            `${heures.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondes.toString().padStart(2, '0')}`
        );
    }, 1000);
    return true;
}

function planifierRestaurationEtatSauvegarde() {
    if (restaurationEtatPlanifiee || !storedFormValues) {
        return;
    }
    restaurationEtatPlanifiee = true;
    let tentatives = 0;
    const maxTentatives = 15;
    const essayer = () => {
        const sectionVisible = $('#sectionSaisie').is(':visible');
        const operateurChamp = document.getElementById('operateur_1');
        if (sectionVisible && operateurChamp) {
            synchroniserMatriculesOperateurs();
            const chronoOk = restaurerChronoDepuisFormulaire();
            if (chronoOk) {
                storedFormValues = null;
                return;
            }
        }
        if (tentatives < maxTentatives) {
            tentatives += 1;
            setTimeout(essayer, 300);
        }
    };
    essayer();
}

document.addEventListener('DOMContentLoaded', function() {
    if (!estModeEmbed) {
        const params = sessionStorage.getItem('projet11_form_data');
        if (params) {
            const form = document.getElementById('formNouveauTraitement');
            if (form) {
                const formData = new URLSearchParams(params);
                storedFormValues = {};
                formData.forEach((value, key) => {
                    storedFormValues[key] = value;
                    const input = form.querySelector(`[name="${key}"]`);
                    if (input) {
                        if (input.type === 'checkbox' || input.type === 'radio') {
                            input.checked = (input.value === value);
                        } else {
                            input.value = value;
                        }
                    }
                });
                sessionStorage.removeItem('projet11_form_data');
                if (storedFormValues.numero_commande) {
                    setTimeout(() => {
                        const champCommande = document.getElementById('numero_commande');
                        if (champCommande) {
                            champCommande.dispatchEvent(new Event('change', { bubbles: true }));
                        }
                    }, 120);
                    delete storedFormValues.numero_commande;
                }
                planifierRestaurationEtatSauvegarde();
            }
        }
    }
});
function matcherContient(params, data) {
    if ($.trim(params.term) === '') {
        return data;
    }
    if (typeof data.text === 'undefined') {
        return null;
    }
    const term = params.term.toLowerCase();
    const text = data.text.toLowerCase();
    return text.indexOf(term) > -1 ? data : null;
}

function initialiserSelect2Contient($element, parentSelector, placeholderText = '-- Rechercher --') {
    if (!$element || !$element.length) return;
    if ($element.data('select2')) {
        $element.select2('destroy');
    }
    const select2Instance = $element.select2({
        theme: 'bootstrap-5',
        placeholder: placeholderText,
        allowClear: true,
        width: '100%',
        minimumResultsForSearch: 0,
        dropdownParent: parentSelector ? $(parentSelector) : $(document.body),
        matcher: matcherContient
    });

    $element.on('select2:open', function() {
        setTimeout(() => {
            const searchField = document.querySelector('.select2-container--open .select2-search__field');
            if (searchField) {
                searchField.focus();
                searchField.placeholder = 'Tapez pour rechercher';
            }
        }, 0);
    });
}

// ============================================================================
// √âTAPE 1: S√©lection de la commande
// ============================================================================
// S'assurer que le champ est pr√™t pour la saisie au focus
$('#numero_commande').on('focus', function() {
    $(this).select(); // S√©lectionner tout le texte s'il y en a
});

// Emp√™cher la soumission du formulaire avec la touche Entr√©e sur le champ de commande
$('#numero_commande').on('keypress', function(e) {
    if (e.which === 13) {  // Touche Entr√©e
        e.preventDefault();
        // D√©placer le focus vers le champ de service s'il est visible
        if ($('#sectionService').is(':visible')) {
            $('#service_prevu').focus();
        }
        return false;
    }
});

$('#numero_commande').on('input change', function() {
    const numeroCommande = $(this).val().trim();
    currentNumeroCommande = numeroCommande;
    
    // R√©initialiser
    resetForm();
    
    if (!numeroCommande) {
        return;
    }
    
    // R√©cup√©rer les infos de la commande depuis le datalist
    const selectedOption = $('#commandes_list option[value="' + numeroCommande + '"]');
    
    if (selectedOption.length > 0) {
        $('#info_numero_cmd').text(numeroCommande);
        $('#info_client_cmd').text(selectedOption.data('client') || '-');
        $('#info_reference_cmd').text(selectedOption.data('reference') || '-');
        $('#infoCommandeSelectionnee').show();
    } else {
        // Si le num√©ro n'est pas dans la liste, ne rien afficher
        return;
    }
    
    // Charger les services pr√©vus
    fetch(`/projet11/api/services-prevus/${encodeURIComponent(numeroCommande)}`)
        .then(response => response.json())
        .then(services => {
            const datalistService = $('#services_list');
            datalistService.empty();
            
            if (services.length > 0) {
                // Ajouter les services pr√©vus dans le datalist
                services.forEach(srv => {
                    datalistService.append(`<option value="${srv.nom_service}">${srv.nom_service} (${srv.nb_fiches} poste(s))</option>`);
                });
                
                // Ajouter l'option pour service non pr√©vu
                datalistService.append('<option value="__AUTRE__">üîß Autre service (non pr√©vu)</option>');
            }
            
            $('#sectionService').show();
            
            // Mettre automatiquement le focus sur le champ de service
            setTimeout(function() {
                $('#service_prevu').focus();
            }, 100);

            const storedService = storedFormValues && storedFormValues.service_prevu;
            if (storedService) {
                $('#service_prevu').val(storedService);
                setTimeout(function() {
                    $('#service_prevu').trigger('change');
                }, 150);
                delete storedFormValues.service_prevu;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement des services');
        });
});

// ============================================================================
// √âTAPE 2: S√©lection du service
// ============================================================================
// S'assurer que le champ est pr√™t pour la saisie au focus
$('#service_prevu').on('focus', function() {
    // Le champ est maintenant actif et pr√™t pour la saisie
    $(this).select(); // S√©lectionner tout le texte s'il y en a
});

// G√©rer la touche Entr√©e sur le champ de service
$('#service_prevu').on('keypress keydown', function(e) {
    if (e.which === 13 || e.keyCode === 13) {  // Touche Entr√©e
        e.preventDefault();
        
        // D√©clencher le traitement du service
        const service = $(this).val().trim();
        
        if (service && currentNumeroCommande) {
            // V√©rifier si le service existe dans le datalist
            const serviceExists = $('#services_list option[value="' + service + '"]').length > 0;
            
            if (serviceExists) {
                // D√©clencher l'√©v√©nement change pour charger l'√©tape suivante
                $(this).trigger('change');
                
                // D√©placer le focus vers le champ Nombre de Personnes apr√®s chargement
                setTimeout(function() {
                    if ($('#sectionSaisie').is(':visible') && $('#nb_pers').length > 0) {
                        $('#nb_pers').focus().select();
                    }
                }, 600); // Attendre que les sections se chargent
            }
        }
        
        return false;
    }
});

$('#service_prevu').on('keydown', function(e) {
    if (e.key === 'Tab') {
        e.preventDefault();
        const valeur = $(this).val().trim();
        if (valeur === '__AUTRE__') {
            $(this).trigger('change');
            setTimeout(function() {
                const champServiceManuel = document.getElementById('service_manuel');
                if (champServiceManuel) {
                    champServiceManuel.focus();
                    champServiceManuel.select();
                }
                const bloc = document.getElementById('sectionServiceNonPrevu');
                if (bloc) {
                    bloc.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 200);
        } else {
            $(this).trigger('change');
            setTimeout(function() {
                const sectionSaisie = document.getElementById('sectionSaisie');
                if (sectionSaisie) {
                    sectionSaisie.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
                if ($('#sectionSaisie').is(':visible') && $('#nb_pers').length > 0) {
                    $('#nb_pers').focus().select();
                }
            }, 300);
        }
    }
});

// Variable pour d√©tecter si le service est valide
let serviceSelectionTimeout = null;

$('#service_prevu').on('change', function() {
    const service = $(this).val().trim();
    currentService = service;
    
    if (!service || !currentNumeroCommande) {
        $('#infoPrevues').hide();
        $('#traitementsExistants').hide();
        $('#sectionSaisie').hide();
        $('#separator').hide();
        stopChrono();
        return;
    }
    
    // V√©rifier si le service existe dans le datalist
    const serviceExists = $('#services_list option[value="' + service + '"]').length > 0;
    
    if (!serviceExists) {
        // Le service n'est pas dans la liste, ne rien faire
        return;
    }
    
    // CASE 1: Service non pr√©vu (AUTRE)
    if (service === '__AUTRE__') {
        afficherSelectionServiceNonPrevu();
        return;
    }
    
    // CASE 2: Service pr√©vu
    chargerServicePrevu(service);
});

// ============================================================================
// Charger un service PR√âVU
// ============================================================================
function chargerServicePrevu(service) {
    fetch(`/projet11/api/postes-prevus/${encodeURIComponent(currentNumeroCommande)}/${encodeURIComponent(service)}`)
        .then(response => response.json())
        .then(postes => {
            if (postes.length === 0) {
                alert('Aucun poste pr√©vu pour ce service');
                return;
            }
            
            // Prendre le premier poste (g√©n√©ralement il n'y en a qu'un par service)
            const poste = postes[0];
            currentFicheId = poste.id_fiche_travail;
            
            // Afficher les infos pr√©vues
            $('#machine_prevue').text(poste.nom_poste);
            $('#qte_prevue').text(poste.qte_prevue.toLocaleString('fr-FR'));
            $('#temps_prevu').text(poste.tps_prev_dev.toFixed(3) + ' h');
            $('#id_fiche_info').text('#' + poste.id_fiche_travail);
            $('#id_fiche_travail').val(poste.id_fiche_travail);
            $('#infoPrevues').show();
            
            // Charger les machines du service et pr√©-s√©lectionner la machine pr√©vue
            chargerMachinesService(service, poste.nom_poste);
            
            // Charger les traitements existants pour ce service
            loadTraitementsService(currentNumeroCommande, service, poste.qte_prevue);
            
            $('#separator').show();
            $('#sectionSaisie').show();
        })
        .catch(error => {
            console.error('Erreur:', error);
            alert('Erreur lors du chargement des postes pr√©vus');
        });
}

// ============================================================================
// Afficher s√©lection pour service NON PR√âVU
// ============================================================================
function afficherSelectionServiceNonPrevu() {
    $('#infoPrevues').hide();
    $('#traitementsExistants').hide();
    $('#sectionSaisie').hide();
    
    // Cr√©er un message explicatif
    const html = `
        <div class="alert alert-info">
            <h5><i class="fas fa-exclamation-triangle"></i> Service Non Pr√©vu</h5>
            <p>Vous allez ajouter un service qui n'√©tait pas initialement pr√©vu pour ce dossier.</p>
            <p class="mb-0"><strong>Note:</strong> Les informations pr√©vues ne seront pas disponibles. Vous devrez saisir manuellement la machine et la quantit√©.</p>
        </div>
        <div class="row mb-3">
            <div class="col-md-12">
                <label for="service_manuel" class="form-label">
                    <strong>S√©lectionnez le Service √† Ajouter *</strong>
                </label>
                <input type="text"
                       class="form-control"
                       id="service_manuel"
                       name="service_manuel"
                       list="services_manuel_list"
                       placeholder="-- Tapez pour rechercher un service --"
                       autocomplete="off"
                       required>
                <datalist id="services_manuel_list"></datalist>
            </div>
        </div>
    `;
    
    // Afficher avant la section saisie
    if ($('#sectionServiceNonPrevu').length === 0) {
        $('#separator').before('<div id="sectionServiceNonPrevu"></div>');
    }
    $('#sectionServiceNonPrevu').html(html).show();
    
    setTimeout(function() {
        const bloc = document.getElementById('sectionServiceNonPrevu');
        if (bloc) {
            bloc.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        const champServiceManuel = document.getElementById('service_manuel');
        if (champServiceManuel) {
            champServiceManuel.focus();
            champServiceManuel.select();
        }
    }, 50);
    
    // Charger TOUS les services disponibles
    fetch('/projet11/api/services-tous')
        .then(response => response.json())
        .then(services => {
            servicesDisponibles = services;
            const datalist = $('#services_manuel_list');
            datalist.empty();
            services.forEach(srv => {
                datalist.append(`<option value="${srv.nom_service}"></option>`);
            });
            const storedManual = storedFormValues && storedFormValues.service_manuel;
            if (storedManual) {
                $('#service_manuel').val(storedManual).trigger('change');
                delete storedFormValues.service_manuel;
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
        });
    
    // G√©rer la s√©lection du service manuel
    $(document).on('change input', '#service_manuel', function() {
        const saisir = $(this).val().trim();
        if (!saisir) {
            return;
        }

        const serviceTrouve = servicesDisponibles.find(srv => srv.nom_service.toLowerCase() === saisir.toLowerCase());
        if (!serviceTrouve) {
            return;
        }

        currentService = serviceTrouve.nom_service;
        currentFicheId = 0;
        $('#id_fiche_travail').val(0);
        
        // Afficher un message info
        const infoHtml = `
            <div class="alert alert-warning">
                <h5><i class="fas fa-info-circle"></i> Service Non Pr√©vu - Saisie Manuelle</h5>
                <p><strong>Service:</strong> ${currentService}</p>
                <p>Vous pouvez maintenant renseigner la machine r√©ellement utilis√©e dans la section 3Ô∏è‚É£ ci-dessous.</p>
                <p class="mb-0"><strong>‚ö†Ô∏è Important:</strong> Comme ce service n'√©tait pas pr√©vu, veuillez saisir manuellement la quantit√© produite et les autres informations.</p>
            </div>
        `;
        
        if ($('#infoServiceNonPrevu').length === 0) {
            $('#separator').before('<div id="infoServiceNonPrevu"></div>');
        }
        $('#infoServiceNonPrevu').html(infoHtml).show();
        
        // Charger les machines du service et pr√©-s√©lectionner le poste choisi
        chargerMachinesService(currentService, null);
        
        // CORRECTION: G√©n√©rer les champs op√©rateurs pour les services non pr√©vus
        genererChampsOperateurs(1);
        
        // Afficher la section de saisie
        $('#separator').show();
        $('#sectionSaisie').show();
        
        // Pas de quantit√© pr√©-remplie pour les services non pr√©vus
        $('#pdt_c').val(0).attr('placeholder', 'Quantit√© conforme produite');
        $('#pdt_nnc').val(0).attr('placeholder', 'Non conformes (bonnes feuilles)');
        $('#pdt_anc').val(0).attr('placeholder', 'Non conformes (macules)');
        
        // Mettre le focus sur le premier champ de saisie
        setTimeout(function() {
            $('#nb_pers').focus().select();
        }, 300);
    });
    
    $('#separator').show();
}

// ============================================================================
// Charger les traitements existants du service
// ============================================================================
// Charger les machines/postes d'un service sp√©cifique
function chargerMachinesService(nomService, machinePreselectionne = null) {
    const selectMachine = $('#machine_reelle');
    
    // Vider et d√©sactiver pendant le chargement
    selectMachine.empty().append('<option value="">Chargement...</option>').prop('disabled', true);
    
    if (!nomService) {
        selectMachine.empty().append('<option value="">-- S√©lectionnez d\'abord un service --</option>');
        return;
    }
    
    fetch(`/projet11/api/postes-tous-service/${encodeURIComponent(nomService)}`)
        .then(response => response.json())
        .then(postes => {
            selectMachine.empty();
            
            if (postes.length === 0) {
                selectMachine.append('<option value="">Aucune machine disponible</option>');
            } else {
                selectMachine.append('<option value="">-- S√©lectionnez une machine --</option>');
                
                postes.forEach(poste => {
                    const option = $('<option>')
                        .val(poste.nom)
                        .text(poste.nom);
                    selectMachine.append(option);
                });
            }
            
            // Pr√©-s√©lectionner la machine si fournie
            if (machinePreselectionne) {
                selectMachine.val(machinePreselectionne).trigger('change');
            }
            
            // R√©activer et r√©initialiser Select2
            selectMachine.prop('disabled', false);
            
            // D√©truire et r√©initialiser Select2
            initialiserSelect2Contient(selectMachine, null, '-- Tapez pour rechercher une machine --');
        })
        .catch(error => {
            console.error('Erreur lors du chargement des machines:', error);
            selectMachine.empty().append('<option value="">Erreur de chargement</option>');
            selectMachine.prop('disabled', false);
        });
}

function loadTraitementsService(numeroCommande, service, qtePrevue) {
    fetch(`/projet11/api/traitements-service/${encodeURIComponent(numeroCommande)}/${encodeURIComponent(service)}`)
        .then(response => response.json())
        .then(traitements => {
            if (traitements.length > 0) {
                let html = '';
                let totalProduit = 0;
                
                traitements.forEach((t, index) => {
                    let pdtC = Number(t.pdt_c || 0);
                    let pdtNNC = Number(t.pdt_nnc || 0);
                    let pdtANC = Number(t.pdt_anc || 0);
                    let totalSession = pdtC + pdtNNC + pdtANC;
                    const statut = t.en_cours ? '‚è≥ En cours' : '‚úÖ Termin√©';
                    const duree = `${t.duree_heures.toFixed(3)}h`;
                    let detailsQuantites;
                    if (totalSession === 0 && Number(t.nb_op || 0) > 0) {
                        totalSession = Number(t.nb_op || 0);
                        detailsQuantites = 'üì¶ D√©tail indisponible (donn√©es historiques)';
                    } else {
                        detailsQuantites = [
                            `‚úÖ ${pdtC.toLocaleString('fr-FR')} conf.`,
                            `‚ö†Ô∏è ${pdtNNC.toLocaleString('fr-FR')} NNC`,
                            `‚ôªÔ∏è ${pdtANC.toLocaleString('fr-FR')} ANC`
                        ].join(' | ');
                    }
                    const needsLineBreak = !detailsQuantites.startsWith('üì¶');
                    
                    html += `
                        <div class="traitement-existant">
                            <strong>Session ${index + 1}:</strong> ${t.dte_deb} ‚Üí ${t.dte_fin || 'En cours'} ${statut}<br>
                            <small>
                                üì¶ ${totalSession.toLocaleString('fr-FR')} op√©rations | ${detailsQuantites}
                                ${needsLineBreak ? '<br>' : ''}
                                üè≠ ${t.postes_reel} | 
                                üë§ ${t.operateur} | 
                                ‚è±Ô∏è ${duree} | 
                                üë• ${t.nb_pers} pers.
                            </small>
                        </div>
                    `;
                    
                    totalProduit += totalSession;
                });
                
                const reste = qtePrevue - totalProduit;
                const pourcentage = ((totalProduit / qtePrevue) * 100).toFixed(1);
                
                html = `<div class="mb-3">${html}</div>`;
                
                $('#listeTraitementsService').html(html);
                $('#totauxService').html(`
                    <div class="row text-center">
                        <div class="col-md-3">
                            <strong>Total produit:</strong><br>
                            <span class="badge bg-success">${totalProduit.toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Reste √† produire:</strong><br>
                            <span class="badge bg-warning">${reste.toLocaleString('fr-FR')}</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Avancement:</strong><br>
                            <span class="badge bg-info">${pourcentage}%</span>
                        </div>
                        <div class="col-md-3">
                            <strong>Sessions:</strong><br>
                            <span class="badge bg-secondary">${traitements.length}</span>
                        </div>
                    </div>
                `);
                
                // Afficher le reste dans le placeholder (sans pr√©-remplir)
                $('#pdt_c').val(0).attr('placeholder', `Reste conforme √† produire: ${reste > 0 ? reste : qtePrevue}`);
                $('#pdt_nnc').val(0).attr('placeholder', 'Non conformes (nouvelles feuilles)');
                $('#pdt_anc').val(0).attr('placeholder', 'Non conformes (anciennes feuilles)');
                
                $('#traitementsExistants').show();
            } else {
                $('#traitementsExistants').hide();
                // Afficher la quantit√© pr√©vue dans le placeholder (sans pr√©-remplir)
                $('#pdt_c').val(0).attr('placeholder', `Quantit√© conforme pr√©vue: ${qtePrevue}`);
                $('#pdt_nnc').val(0).attr('placeholder', 'Non conformes (nouvelles feuilles)');
                $('#pdt_anc').val(0).attr('placeholder', 'Non conformes (anciennes feuilles)');
            }
        })
        .catch(error => {
            console.error('Erreur:', error);
            $('#traitementsExistants').hide();
        });
}

// ============================================================================
// G√©n√©ration dynamique des champs op√©rateurs
// ============================================================================
function genererChampsOperateurs(nbPersonnes) {
    const container = $('#operateurs_fields');
    const valeurExistante = $('#operateur_1').val() || '';
    container.empty();
    
    // Toujours g√©n√©rer un seul champ d'op√©rateur (l'op√©rateur principal)
    const operateurHtml = `
        <div class="row mb-2">
            <div class="col-md-12">
                <input type="text" 
                       class="form-control operateur-input" 
                       id="operateur_1" 
                       name="operateur_1" 
                       list="operateurs_list_1"
                       placeholder="-- Tapez pour rechercher un op√©rateur --"
                       autocomplete="off"
                       data-index="1"
                       data-matricule="">
                <datalist id="operateurs_list_1">
                    {% for op in operateurs %}
                    <option value="{{ op.nom }} {{ op.prenom }} (Matricule: {{ op.matricule }})" 
                            data-matricule="{{ op.matricule }}">
                    </option>
                    {% endfor %}
                </datalist>
                <small class="text-muted">‚Äî Saisir l'op√©rateur principal de ce poste</small>
            </div>
        </div>
    `;
    container.append(operateurHtml);
    const champOperateur = document.getElementById('operateur_1');
    const valeurACharger = (storedFormValues && storedFormValues.operateur_1) || valeurExistante || '';
    if (champOperateur && valeurACharger) {
        champOperateur.value = valeurACharger;
        mettreAJourMatriculeDepuisTexte(champOperateur, valeurACharger);
        if (storedFormValues && storedFormValues.operateur_1) {
            delete storedFormValues.operateur_1;
        }
    }
    
    // S'assurer que le champ est pr√™t pour la saisie au focus
    $('.operateur-input').on('focus', function() {
        $(this).select(); // S√©lectionner tout le texte s'il y en a
    });
    
    // Emp√™cher la soumission avec Entr√©e sur les champs op√©rateurs
    $('.operateur-input').on('keypress', function(e) {
        if (e.which === 13) {  // Touche Entr√©e
            e.preventDefault();
            // D√©placer le focus vers le champ de quantit√©
            $('#pdt_c').focus();
            return false;
        }
    });
    
    // Extraire le matricule depuis le texte s√©lectionn√©
    $('.operateur-input').on('input change', function() {
        const valeur = $(this).val();
        // Extraire le matricule entre parenth√®ses : "Nom Prenom (Matricule: 123)"
        const match = valeur.match(/Matricule:\s*(\d+)/);
        if (match) {
            $(this).attr('data-matricule', match[1]);
        } else {
            $(this).attr('data-matricule', '');
        }
    });
    
    // √âv√©nement sur le premier op√©rateur pour d√©marrer le chronom√®tre
    $('#operateur_1').on('input change', function() {
        const matricule = $(this).attr('data-matricule');
        if ($(this).val() && matricule && currentService && currentNumeroCommande) {
            demarrerChrono();
        }
    });
}

// Le nombre de personnes ne change plus le nombre de champs op√©rateurs
// On garde toujours un seul champ pour l'op√©rateur principal

// Gestionnaire de navigation pour le champ Nombre de Personnes
$('#nb_pers').on('keypress', function(e) {
    if (e.which === 13) {  // Touche Entr√©e
        e.preventDefault();
        // D√©placer le focus vers le champ Machine R√©elle
        $('#machine_reelle').focus();
        return false;
    }
});

// Gestionnaire de navigation pour le champ Machine R√©elle
$(document).on('keypress', '#machine_reelle', function(e) {
    if (e.which === 13) {  // Touche Entr√©e
        e.preventDefault();
        // D√©placer le focus vers le champ Op√©rateur
        if ($('#operateur_1').length > 0) {
            $('#operateur_1').focus();
        }
        return false;
    }
});

// Gestionnaire de focus pour le champ Nombre de Personnes
$('#nb_pers').on('focus', function() {
    $(this).select(); // S√©lectionner tout le texte s'il y en a
});

// Gestionnaire de focus pour le champ de quantit√©
$('#pdt_c, #pdt_nnc, #pdt_anc').on('focus', function() {
    $(this).select();
});

// ============================================================================
// Fonctions du chronom√®tre
// ============================================================================
/**
 * Formate une date en heure locale pour SQL Server (sans conversion UTC)
 * Format: YYYY-MM-DDTHH:MM:SS (sans le 'Z' qui indique UTC)
 */
function formatDateTimeLocal(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const hours = String(date.getHours()).padStart(2, '0');
    const minutes = String(date.getMinutes()).padStart(2, '0');
    const seconds = String(date.getSeconds()).padStart(2, '0');
    
    return `${year}-${month}-${day}T${hours}:${minutes}:${seconds}`;
}

function demarrerChrono() {
    if (chronoStart || startTraitementEnCours || currentTraitementId) {
        return; // D√©j√† d√©marr√© ou en cours d'initialisation
    }

    const idFicheTravail = parseInt($('#id_fiche_travail').val(), 10) || 0;
    if (!currentNumeroCommande || !currentService || idFicheTravail === null || idFicheTravail === undefined) {
        alert('Veuillez s√©lectionner une commande et un service avant de d√©marrer le chronom√®tre.');
        return;
    }

    const matriculeOperateur = parseInt($('#operateur_1').attr('data-matricule'), 10);
    if (!matriculeOperateur) {
        alert('Veuillez s√©lectionner un op√©rateur valide avant de d√©marrer le chronom√®tre.');
        return;
    }

    chronoStart = new Date();
    const dateDebut = formatDateTimeLocal(chronoStart);
    $('#dte_deb').val(dateDebut);
    $('#chronoStart').text(chronoStart.toLocaleString('fr-FR', {
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
    }));

    $('#chronoBox').css('display', 'block');

    chronoInterval = setInterval(() => {
        const now = new Date();
        const diff = now - chronoStart;

        const heures = Math.floor(diff / 3600000);
        const minutes = Math.floor((diff % 3600000) / 60000);
        const secondes = Math.floor((diff % 60000) / 1000);

        $('#chronoDisplay').text(
            `${heures.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secondes.toString().padStart(2, '0')}`
        );
    }, 1000);

    const payload = {
        id_fiche_travail: idFicheTravail,
        dte_deb: dateDebut,
        nb_pers: parseInt($('#nb_pers').val(), 10) || 1,
        matricule_personel: matriculeOperateur,
        postes_reel: $('#machine_reelle').val() || null,
        numero_commande: currentNumeroCommande || null,
        nom_service: currentService || null
    };

    startTraitementEnCours = true;

    fetch('/projet11/api/traitements/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(result => {
        startTraitementEnCours = false;
        if (result.success) {
            setCurrentTraitementId(result.id);
        } else {
            stopChrono();
            $('#dte_deb').val('');
            alert(result.error || 'Impossible de d√©marrer le traitement sur le serveur.');
        }
    })
    .catch(error => {
        startTraitementEnCours = false;
        stopChrono();
        $('#dte_deb').val('');
        alert('Erreur lors du d√©marrage du traitement sur le serveur.');
        console.error(error);
    });
}

function stopChrono() {
    if (chronoInterval) {
        clearInterval(chronoInterval);
        chronoInterval = null;
    }
    chronoStart = null;
    $('#chronoBox').css('display', 'none');
    $('#chronoDisplay').text('00:00:00');
}

function resetForm() {
    stopChrono();
    startTraitementEnCours = false;
    if (currentTraitementId) {
        fetch(`/projet11/api/traitements/${currentTraitementId}`, {
            method: 'DELETE'
        }).catch(err => console.error('Erreur suppression traitement d√©marr√©:', err));
        setCurrentTraitementId(null);
    }
    $('#sectionService').hide();
    $('#infoPrevues').hide();
    $('#traitementsExistants').hide();
    $('#sectionSaisie').hide();
    $('#separator').hide();
    currentService = null;
    currentFicheId = null;
}

// ============================================================================
// Soumission du formulaire
// ============================================================================
$('#formNouveauTraitement').on('submit', function(e) {
    e.preventDefault();
    
    // V√©rifications pr√©liminaires - Toutes les sections doivent √™tre visibles
    if (!currentNumeroCommande) {
        alert('Erreur: Veuillez d\'abord s√©lectionner un num√©ro de commande');
        return;
    }
    
    if (!currentService) {
        alert('Erreur: Veuillez s√©lectionner un service de production');
        return;
    }
    
    if ($('#sectionSaisie').css('display') === 'none') {
        alert('Erreur: Veuillez compl√©ter toutes les √©tapes avant de soumettre');
        return;
    }
    
    // Pr√©parer l'arr√™t du chrono et enregistrer la fin (sera appliqu√© apr√®s confirmation)
    const now = new Date();
    const dteFinValue = formatDateTimeLocal(now);
    // CORRECTION: Utiliser l'heure locale du PC au lieu de l'UTC
    $('#dte_fin').val(dteFinValue);
    
    // V√©rifier que le champ operateur_1 existe
    if ($('#operateur_1').length === 0) {
        alert('Erreur: Le champ op√©rateur n\'a pas √©t√© initialis√©. Veuillez recharger la page.');
        console.error('Le champ #operateur_1 n\'existe pas dans le DOM');
        return;
    }
    
    // R√©cup√©rer le matricule de l'op√©rateur principal depuis data-matricule
    const operateurPrincipal = $('#operateur_1').attr('data-matricule');
    console.log('Matricule op√©rateur principal:', operateurPrincipal);
    console.log('Texte complet:', $('#operateur_1').val());
    
    // Validation de l'op√©rateur
    if (!operateurPrincipal) {
        alert('Erreur: Veuillez s√©lectionner au moins l\'op√©rateur principal dans la liste');
        return;
    }
    
    const dteDebValue = $('#dte_deb').val();
    if (!dteDebValue) {
        alert('Veuillez s√©lectionner un op√©rateur pour d√©marrer le chronom√®tre');
        return;
    }
    const idFicheRaw = $('#id_fiche_travail').val();
    const idFicheValue = parseInt(idFicheRaw, 10);
    const nbPersValue = parseInt($('#nb_pers').val(), 10) || 1;
    const matriculeValue = parseInt(operateurPrincipal, 10);
    const posteReelValue = $('#machine_reelle').val() || null;
    
    const pdtC = parseInt($('#pdt_c').val(), 10);
    const pdtNNC = parseInt($('#pdt_nnc').val(), 10);
    const pdtANC = parseInt($('#pdt_anc').val(), 10);
    const safePdtC = Number.isFinite(pdtC) && pdtC >= 0 ? pdtC : 0;
    const safePdtNNC = Number.isFinite(pdtNNC) && pdtNNC >= 0 ? pdtNNC : 0;
    const safePdtANC = Number.isFinite(pdtANC) && pdtANC >= 0 ? pdtANC : 0;
    const totalProduite = safePdtC + safePdtNNC + safePdtANC;

    // Validation
    if (Number.isNaN(idFicheValue)) {
        alert('Erreur: Fiche de travail non s√©lectionn√©e');
        return;
    }
    
    // Pour les services non pr√©vus (id_fiche_travail = 0), v√©rifier les infos suppl√©mentaires
    if (idFicheValue === 0) {
        if (!currentNumeroCommande || !currentService) {
            alert('Erreur: Informations de commande et service requises pour un service non pr√©vu');
            return;
        }
    }
    
    if (!Number.isFinite(matriculeValue)) {
        alert('Erreur: Op√©rateur principal invalide');
        return;
    }
    
    if (totalProduite <= 0) {
        alert('Veuillez saisir au moins une quantit√© produite (conforme ou non conforme)');
        return;
    }
    
    // Calculer la dur√©e
    const debut = new Date(dteDebValue);
    const fin = new Date(dteFinValue);
    const dureeMinutes = Math.floor((fin - debut) / 60000);
    const dureeHeures = (dureeMinutes / 60).toFixed(3);
    
    // Confirmation
    if (!confirm(`Enregistrer ce traitement?\n\nConformes: ${safePdtC.toLocaleString('fr-FR')}\nNon conformes (Nouvelles): ${safePdtNNC.toLocaleString('fr-FR')}\nNon conformes (Anciennes): ${safePdtANC.toLocaleString('fr-FR')}\nTotal: ${totalProduite.toLocaleString('fr-FR')}\nDur√©e: ${dureeHeures}h (${dureeMinutes} min)`)) {
        // L'utilisateur souhaite garder le traitement en cours : r√©initialiser la date de fin
        $('#dte_fin').val('');
        return;
    }

    // Confirmation accept√©e : arr√™ter et masquer le chrono
    stopChrono();
    
    const data = {
        id_fiche_travail: idFicheValue,
        dte_deb: dteDebValue,
        dte_fin: dteFinValue,
        nb_pers: nbPersValue,
        matricule_personel: matriculeValue,
        postes_reel: posteReelValue,
        pdt_c: safePdtC,
        pdt_nnc: safePdtNNC,
        pdt_anc: safePdtANC,
        nb_op: totalProduite,
        numero_commande: currentNumeroCommande || null,
        nom_service: currentService || null
    };
    
    // Log des donn√©es envoy√©es
    console.log('=== DONN√âES ENVOY√âES AU SERVEUR ===');
    console.log('id_fiche_travail:', data.id_fiche_travail, 'type:', typeof data.id_fiche_travail);
    console.log('matricule_personel:', data.matricule_personel, 'type:', typeof data.matricule_personel);
    console.log('dte_deb:', data.dte_deb);
    console.log('dte_fin:', data.dte_fin);
    console.log('pdt_c:', data.pdt_c);
    console.log('pdt_nnc:', data.pdt_nnc);
    console.log('pdt_anc:', data.pdt_anc);
    console.log('total (nb_op):', data.nb_op);
    console.log('nb_pers:', data.nb_pers);
    console.log('postes_reel:', data.postes_reel);
    console.log('Donn√©es compl√®tes:', JSON.stringify(data, null, 2));
    console.log('===================================');
    
    // Envoyer
    let url = '/projet11/api/traitements';
    let method = 'POST';
    if (currentTraitementId) {
        url = `/projet11/api/traitements/${currentTraitementId}`;
        method = 'PUT';
    }

    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            return response.text().then(text => {
                throw new Error(`Erreur ${response.status}: ${text}`);
            });
        }
        return response.json();
    })
    .then(result => {
        console.log('R√©sultat:', result);
        if (result.success) {
            const traitementId = currentTraitementId || result.id || 'N/A';
            setCurrentTraitementId(null);
            alert(`‚úÖ Traitement enregistr√© avec succ√®s!\n\nID: ${traitementId}\nDur√©e: ${dureeHeures}h (${dureeMinutes} min)\nTotal produit: ${totalProduite.toLocaleString('fr-FR')}`);
            if (estModeEmbed) {
                window.location.reload();
            } else {
                window.location.href = '{{ url_for("projet11.liste_traitements") }}';
            }
        } else {
            alert('‚ùå Erreur: ' + (result.error || 'Erreur inconnue'));
        }
    })
    .catch(error => {
        alert('‚ùå Erreur lors de l\'enregistrement: ' + error.message);
        console.error('Erreur compl√®te:', error);
    });
});

// ============================================================================
// Initialisation Select2
// ============================================================================
$(document).ready(function() {
    // Le num√©ro de commande utilise maintenant un datalist HTML5 natif
    // Le service de production utilise maintenant un datalist HTML5 natif
    // Pas besoin d'initialisation Select2 pour ces champs
    
    // Machine R√©elle - Select2 initialis√© dynamiquement par chargerMachinesService()
    
    // G√©n√©rer le champ op√©rateur initial (1 op√©rateur par d√©faut)
    genererChampsOperateurs(1);
});
</script>
{% endblock %}
