{% extends "base.html" %}

{% block title %}Projet 14 - Registre de suivi des d√©chets{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
    .projet14-container {
        max-width: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
        position: relative;
        min-height: auto;
    }

    .page-header {
        text-align: center;
        margin-bottom: 30px;
        background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        color: #1b5e20;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        border: 2px solid #a5d6a7;
    }

    .page-header h1 {
        font-size: 2rem;
        margin-bottom: 10px;
        color: #2e7d32;
        font-weight: 700;
    }

    .page-header p {
        opacity: 0.85;
        margin: 0;
        color: #388e3c;
    }

    .section-selection {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 25px;
        text-align: center;
    }

    .section-selection h3 {
        color: #2c3e50;
        font-size: 1.2rem;
        margin-bottom: 15px;
    }

    .section-options {
        display: flex;
        justify-content: center;
        gap: 20px;
        flex-wrap: wrap;
    }

    .section-btn {
        padding: 15px 30px;
        background: white;
        color: #2c3e50;
        text-decoration: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        transition: all 0.3s;
        border: 2px solid #ddd;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-btn:hover {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
    }

    .section-btn.active {
        background: #27ae60;
        color: white;
        border-color: #27ae60;
    }

    .content-section {
        background: white;
        padding: 25px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .section-title {
        color: #27ae60;
        font-size: 1.5rem;
        margin-bottom: 20px;
        border-bottom: 3px solid #27ae60;
        padding-bottom: 10px;
    }

    /* Filtres - Anciens styles supprim√©s, les nouveaux sont int√©gr√©s dans le tableau */

    .btn {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background: #27ae60;
        color: white;
    }

    .btn-primary:hover {
        background: #229954;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(39, 174, 96, 0.3);
    }

    .btn-secondary {
        background: #95a5a6;
        color: white;
    }

    .btn-secondary:hover {
        background: #7f8c8d;
    }

    .btn-success {
        background: #27ae60;
        color: white;
    }

    .btn-danger {
        background: #e74c3c;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-warning {
        background: #f39c12;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-info {
        background: #3498db;
        color: white;
        padding: 6px 12px;
        font-size: 12px;
    }

    .btn-add {
        background: #27ae60;
        color: white;
        padding: 12px 24px;
        margin-bottom: 20px;
        display: inline-block;
    }

    /* Tableau */
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
        min-width: 1100px;
    }

    .data-table thead {
        background-color: #27ae60;
        color: white;
    }

    .data-table th {
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 0.85rem;
    }

    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #ecf0f1;
        font-size: 0.85rem;
        vertical-align: middle;
    }

    .data-table tbody tr:hover {
        background-color: #f8f9fa;
    }

    .data-table tbody tr:nth-child(even) {
        background-color: #fafbfc;
    }

    /* Filtres dans le tableau */
    .data-table thead tr.filter-row {
        background-color: #1e8449;
    }

    .data-table thead tr.filter-row th {
        padding: 8px;
    }

    .data-table thead tr.filter-row input {
        width: 100%;
        padding: 6px 8px;
        border: 2px solid transparent;
        border-radius: 4px;
        font-size: 0.8rem;
        background-color: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }

    .data-table thead tr.filter-row input:focus {
        outline: none;
        border-color: #fff;
        box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.3);
        background-color: #fff;
        transform: translateY(-1px);
    }

    .data-table thead tr.filter-row input::placeholder {
        color: #7f8c8d;
        font-size: 0.8rem;
        font-style: italic;
        opacity: 0.8;
    }

    /* Tri des colonnes */
    .data-table th.sortable {
        cursor: pointer;
        user-select: none;
        position: relative;
        padding-right: 20px;
    }

    .data-table th.sortable:hover {
        background-color: #1e8449;
    }

    .data-table th.sortable::after {
        content: '‚áÖ';
        position: absolute;
        right: 6px;
        opacity: 0.3;
        font-size: 0.9rem;
    }

    .data-table th.sortable.sort-asc::after {
        content: '‚ñ≤';
        opacity: 1;
        color: #fff;
    }

    .data-table th.sortable.sort-desc::after {
        content: '‚ñº';
        opacity: 1;
        color: #fff;
    }

    /* Animation des lignes filtr√©es */
    .data-table tbody tr.filtered-out {
        display: none;
    }

    /* Ligne d'information et bouton de r√©initialisation */
    .table-info-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        background: #f8f9fa;
        border-radius: 4px;
        margin-bottom: 15px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .table-info-bar .filter-info {
        font-size: 0.9rem;
        color: #7f8c8d;
        font-weight: 500;
    }

    .table-info-bar .filter-info .count {
        color: #27ae60;
        font-weight: 700;
        font-size: 1rem;
    }

    .btn-reset-filters {
        background: linear-gradient(135deg, #e8e8e8 0%, #f5f5f5 100%);
        color: #555;
        padding: 6px 14px;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 5px;
    }

    .btn-reset-filters:hover {
        background: linear-gradient(135deg, #f5f5f5 0%, #e8e8e8 100%);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    .btn-reset-chart:hover {
        background: #7f8c8d !important;
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }

    /* Style pour le champ de recherche du graphique */
    #filter-chart-type {
        transition: all 0.3s ease;
    }

    #filter-chart-type:focus {
        outline: none;
        border-color: #27ae60;
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
        transform: translateY(-1px);
    }

    #filter-chart-type::placeholder {
        color: #95a5a6;
        font-style: italic;
        opacity: 0.8;
    }

    .action-buttons {
        display: flex;
        gap: 3px;
        flex-wrap: nowrap;
        justify-content: center;
        align-items: center;
    }

    /* Boutons d'action avec ic√¥nes SVG */
    .btn-view {
        background: linear-gradient(135deg, #b8d4f1 0%, #d0e4ff 100%);
        color: #1e3a8a;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(184, 212, 241, 0.4);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .btn-view:hover {
        background: linear-gradient(135deg, #d0e4ff 0%, #b8d4f1 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(184, 212, 241, 0.6);
    }
    
    .btn-edit {
        background: linear-gradient(135deg, #d8b5e8 0%, #e8d4f5 100%);
        color: #6b21a8;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(216, 181, 232, 0.4);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .btn-edit:hover {
        background: linear-gradient(135deg, #e8d4f5 0%, #d8b5e8 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(216, 181, 232, 0.6);
    }

    .btn-delete {
        background: linear-gradient(135deg, #ffc9d4 0%, #ffe0e8 100%);
        color: #be123c;
        padding: 6px 10px;
        border: none;
        border-radius: 6px;
        font-size: 0.75rem;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 2px 6px rgba(255, 201, 212, 0.4);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }

    .btn-delete:hover {
        background: linear-gradient(135deg, #ffe0e8 0%, #ffc9d4 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 201, 212, 0.6);
    }

    .month-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: 600;
        color: #2c3e50;
        border: 2px solid rgba(0,0,0,0.1);
    }

    /* Couleurs pastel douces et claires pour chaque mois - Harmonieuses */
    .month-badge.janvier { background: linear-gradient(135deg, #d4f1f4 0%, #c1e7ea 100%); }   /* Bleu glacier doux */
    .month-badge.fevrier { background: linear-gradient(135deg, #ffe8f0 0%, #ffd8e6 100%); }   /* Rose p√¢le lumineux */
    .month-badge.mars { background: linear-gradient(135deg, #fff3e0 0%, #ffe5c2 100%); }      /* P√™che cr√®me */
    .month-badge.avril { background: linear-gradient(135deg, #e8f5e9 0%, #d4ead6 100%); }     /* Vert printanier */
    .month-badge.mai { background: linear-gradient(135deg, #e1f5fe 0%, #cfe9fc 100%); }       /* Azur doux */
    .month-badge.juin { background: linear-gradient(135deg, #f3e5f5 0%, #e8d5f0 100%); }      /* Lavande claire */
    .month-badge.juillet { background: linear-gradient(135deg, #fffde7 0%, #fff9c4 100%); }   /* Vanille lumineuse */
    .month-badge.aout { background: linear-gradient(135deg, #ffe0b2 0%, #ffd699 100%); }      /* Abricot pastel */
    .month-badge.septembre { background: linear-gradient(135deg, #e8eaf6 0%, #d7daf5 100%); } /* Pervenche douce */
    .month-badge.octobre { background: linear-gradient(135deg, #fce4ec 0%, #f8d0de 100%); }   /* Rose tendre */
    .month-badge.novembre { background: linear-gradient(135deg, #e0f2f1 0%, #cfe8e6 100%); }  /* Menthe glac√©e */
    .month-badge.decembre { background: linear-gradient(135deg, #e3f2fd 0%, #d1e7fb 100%); }  /* Ciel d'hiver */

    /* Largeurs de colonnes pour un meilleur alignement */
    .data-table th:nth-child(1),
    .data-table td:nth-child(1) { width: 100px; }  /* Mois */
    
    .data-table th:nth-child(2),
    .data-table td:nth-child(2) { width: 110px; }  /* Date */
    
    .data-table th:nth-child(3),
    .data-table td:nth-child(3) { width: 180px; }  /* Type */
    
    .data-table th:nth-child(4),
    .data-table td:nth-child(4) { width: 90px; text-align: center; }  /* Quantit√© */
    
    .data-table th:nth-child(5),
    .data-table td:nth-child(5) { width: 70px; text-align: center; }  /* Unit√© */
    
    .data-table th:nth-child(6),
    .data-table td:nth-child(6) { width: 120px; }  /* Bon N¬∞ */
    
    .data-table th:nth-child(7),
    .data-table td:nth-child(7) { width: 150px; }  /* R√©ceptionnaire */
    
    .data-table th:nth-child(8),
    .data-table td:nth-child(8) { width: 220px; text-align: center; }  /* Actions */
    
    .data-table th:nth-child(8) { text-align: center; }  /* Titre Actions centr√© */

    /* Modal */
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.5);
        animation: fadeIn 0.3s;
    }

    .modal.show {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .modal-content {
        background-color: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        max-width: 700px;
        width: 90%;
        max-height: 90vh;
        overflow-y: auto;
        animation: slideDown 0.3s;
    }

    @keyframes slideDown {
        from {
            transform: translateY(-50px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #27ae60;
        padding-bottom: 15px;
    }

    .modal-header h2 {
        color: #27ae60;
        margin: 0;
    }

    .close-modal {
        font-size: 28px;
        font-weight: bold;
        color: #aaa;
        cursor: pointer;
        line-height: 1;
    }

    .close-modal:hover {
        color: #000;
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
    }

    .form-group label .required {
        color: #e74c3c;
    }

    .form-group input,
    .form-group select {
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus {
        outline: none;
        border-color: #27ae60;
        box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
    }

    /* Style pour les suggestions datalist */
    input[list]::-webkit-calendar-picker-indicator {
        cursor: pointer;
        opacity: 0.6;
    }

    input[list]::-webkit-calendar-picker-indicator:hover {
        opacity: 1;
    }

    .alert {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 5px;
        display: none;
    }

    .alert-success {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
    }

    .alert.show {
        display: block;
        animation: slideDown 0.3s;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #95a5a6;
    }

    /* Statistiques */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
        border-left: 4px solid #27ae60;
    }

    .stat-card h3 {
        color: #27ae60;
        margin-bottom: 15px;
        font-size: 1em;
    }

    .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #2c3e50;
        margin: 10px 0;
    }

    .stat-unit {
        color: #7f8c8d;
        font-size: 0.9em;
    }

    .chart-container {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .chart-container h3 {
        color: #27ae60;
        margin-bottom: 20px;
        border-bottom: 2px solid #27ae60;
        padding-bottom: 10px;
    }

    .chart-wrapper {
        position: relative;
        height: 400px;
    }

    /* Vue d√©taill√©e */
    .detail-view {
        background: white;
        padding: 30px;
        border-radius: 10px;
    }

    .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .detail-item {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 3px solid #27ae60;
    }

    .detail-label {
        font-weight: 600;
        color: #27ae60;
        margin-bottom: 5px;
        font-size: 0.85em;
    }

    .detail-value {
        color: #2c3e50;
        font-size: 1.1em;
    }

    .print-button {
        background: #3498db;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 5px;
        font-weight: 600;
        cursor: pointer;
        margin-right: 10px;
    }

    .print-button:hover {
        background: #2980b9;
    }

    @media print {
        .no-print {
            display: none !important;
        }
        .modal-content {
            box-shadow: none;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="projet14-container">
    <!-- En-t√™te -->
    <div class="page-header">
        <h1>‚ôªÔ∏è Registre de suivi des d√©chets</h1>
        <p>Code : FOR-SMI-38 | Version : 02 | Date : 28/09/2018</p>
    </div>

    <!-- S√©lection de section -->
    <div class="section-selection">
        <h3>S√©lectionnez une section</h3>
        <div class="section-options">
            <a href="{{ url_for('projet14.registre') }}" class="section-btn {% if section == 'registre' %}active{% endif %}">
                üìã Registre de suivi des d√©chets
            </a>
            <a href="{{ url_for('projet14.saisie') }}" class="section-btn {% if section == 'saisie' %}active{% endif %}">
                ‚ûï Saisie d'un nouveau fichier
            </a>
            <a href="{{ url_for('projet14.statistiques_view') }}" class="section-btn {% if section == 'stats' %}active{% endif %}">
                üìä Statistiques
            </a>
        </div>
    </div>

    <!-- Message de notification -->
    <div id="alert-container"></div>

    <!-- Section Registre -->
    {% if section == 'registre' %}
    <div id="section-registre-content" class="content-section">
        <h2 class="section-title">üìã Registre de suivi des d√©chets</h2>
        
        <!-- Barre d'information -->
        <div class="table-info-bar">
            <div class="filter-info">
                Affichage de <span class="count" id="filter-count">0</span> enregistrement(s)
            </div>
            <button class="btn-reset-filters" onclick="resetFilters()">
                üîÑ R√©initialiser les filtres
            </button>
        </div>

        <!-- Tableau des d√©chets -->
        <div id="registre-table-container" style="overflow-x: auto;">
            <table class="data-table">
                <thead>
                    <tr>
                        <th class="sortable" onclick="trierTableau('mois')">Mois</th>
                        <th class="sortable" onclick="trierTableau('date')">Date</th>
                        <th class="sortable" onclick="trierTableau('type')">Type de d√©chet</th>
                        <th class="sortable" onclick="trierTableau('quantite')">Quantit√©</th>
                        <th class="sortable" onclick="trierTableau('unite')">Unit√©</th>
                        <th class="sortable" onclick="trierTableau('bon')">Bon N¬∞</th>
                        <th class="sortable" onclick="trierTableau('receptionnaire')">R√©ceptionnaire</th>
                        <th>Actions</th>
                    </tr>
                    <tr class="filter-row">
                        <th><input type="text" id="filter-mois" placeholder="Mois..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-date" placeholder="Date..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-type" placeholder="Type..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-quantite" placeholder="Qt√©..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-unite" placeholder="Unit√©..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-bon" placeholder="Bon N¬∞..." oninput="appliquerFiltres()"></th>
                        <th><input type="text" id="filter-receptionnaire" placeholder="R√©ceptionnaire..." oninput="appliquerFiltres()"></th>
                        <th></th>
                    </tr>
                </thead>
                <tbody id="table-body">
                    <tr>
                        <td colspan="8" class="empty-state">
                            <div style="font-size: 2rem;">üì¶</div>
                            <p>Chargement des donn√©es...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- Section Saisie vide (popup s'ouvre automatiquement) -->
    {% if section == 'saisie' %}
    <div id="section-saisie-content" class="content-section">
        <h2 class="section-title">‚ûï Saisie d'un nouveau fichier</h2>
        <p style="text-align: center; color: #7f8c8d; margin-top: 20px;">
            La popup de saisie va s'ouvrir automatiquement.
        </p>
    </div>
    {% endif %}

    <!-- Section Statistiques -->
    {% if section == 'stats' %}
    <div id="section-stats-content" class="content-section">
        <h2 class="section-title">üìä Statistiques</h2>
        
        <!-- Filtre par ann√©e -->
        <div style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
            <label for="filter-annee" style="font-weight: 600; color: #2c3e50;">üìÖ Ann√©e :</label>
            <select id="filter-annee" onchange="chargerStatistiques()" style="padding: 8px 15px; border: 2px solid #27ae60; border-radius: 5px; font-size: 14px; cursor: pointer; background: white;">
                <option value="">Toutes les ann√©es</option>
            </select>
        </div>
        
        <!-- Cartes statistiques -->
        <div class="stats-grid" id="stats-cards">
            <div class="empty-state">
                <p>Chargement des statistiques...</p>
            </div>
        </div>

        <!-- Graphiques -->
        <div class="chart-container">
            <h3>üìà R√©partition par type de d√©chet</h3>
            
            <!-- Filtres sp√©cifiques pour le graphique de r√©partition -->
            <div style="margin-bottom: 15px; display: flex; align-items: center; gap: 15px; flex-wrap: wrap; padding: 12px; background: #f8f9fa; border-radius: 8px;">
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="filter-chart-type" style="font-weight: 600; color: #2c3e50; font-size: 0.9rem;">üîç Type :</label>
                    <input type="text" id="filter-chart-type" oninput="chargerGraphiqueTypes()" placeholder="Rechercher un type..." style="padding: 6px 12px; border: 2px solid #27ae60; border-radius: 5px; font-size: 0.85rem; background: white; min-width: 180px;">
                </div>
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="filter-chart-annee" style="font-weight: 600; color: #2c3e50; font-size: 0.9rem;">üìÖ Ann√©e :</label>
                    <select id="filter-chart-annee" onchange="chargerGraphiqueTypes()" style="padding: 6px 12px; border: 2px solid #27ae60; border-radius: 5px; font-size: 0.85rem; cursor: pointer; background: white;">
                        <option value="">Toutes</option>
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 8px;">
                    <label for="filter-chart-mois" style="font-weight: 600; color: #2c3e50; font-size: 0.9rem;">üìÜ Mois :</label>
                    <select id="filter-chart-mois" onchange="chargerGraphiqueTypes()" style="padding: 6px 12px; border: 2px solid #27ae60; border-radius: 5px; font-size: 0.85rem; cursor: pointer; background: white;">
                        <option value="">Tous</option>
                        <option value="1">Janvier</option>
                        <option value="2">F√©vrier</option>
                        <option value="3">Mars</option>
                        <option value="4">Avril</option>
                        <option value="5">Mai</option>
                        <option value="6">Juin</option>
                        <option value="7">Juillet</option>
                        <option value="8">Ao√ªt</option>
                        <option value="9">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">D√©cembre</option>
                    </select>
                </div>
                
                <button onclick="resetFiltersGraphique()" class="btn-reset-chart" style="padding: 6px 14px; background: #95a5a6; color: white; border: none; border-radius: 5px; font-size: 0.85rem; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                    üîÑ R√©initialiser
                </button>
            </div>
            
            <div class="chart-wrapper">
                <canvas id="chart-types"></canvas>
            </div>
        </div>

        <div class="chart-container">
            <h3 id="chart-mois-titre">üìÖ √âvolution mensuelle - D√©chets solides (12 derniers mois)</h3>
            <div class="chart-wrapper">
                <canvas id="chart-mois"></canvas>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal pour saisie -->
<div id="modal-saisie" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚ûï Saisie d'un nouveau fichier</h2>
            <span class="close-modal" onclick="closeSaisieModal()">&times;</span>
        </div>
        <form id="form-dechet">
            <div class="form-grid">
                <div class="form-group">
                    <label for="date">Date <span class="required">*</span></label>
                    <input type="date" id="date" name="date" value="{{ date_du_jour }}" required>
                </div>

                <div class="form-group">
                    <label for="type">Type de d√©chet <span class="required">*</span></label>
                    <input type="text" id="type" name="type" list="type-list" required placeholder="Saisir le type de d√©chet">
                    <datalist id="type-list">
                        {% for type in types_predefined %}
                        <option value="{{ type }}">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="quantite">Quantit√© <span class="required">*</span></label>
                    <input type="number" id="quantite" name="quantite" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label for="unite">Unit√© <span class="required">*</span></label>
                    <input type="text" id="unite" name="unite" value="kg" required>
                </div>

                <div class="form-group">
                    <label for="bon_reception_num">Bon de r√©ception N¬∞</label>
                    <input type="text" id="bon_reception_num" name="bon_reception_num">
                </div>

                <div class="form-group">
                    <label for="receptionnaire">R√©ceptionnaire</label>
                    <input type="text" id="receptionnaire" name="receptionnaire" placeholder="Nom du fournisseur">
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button type="submit" class="btn btn-primary">üíæ Enregistrer</button>
                <button type="button" class="btn btn-secondary" onclick="closeSaisieModal()">‚ùå Annuler</button>
            </div>
        </form>
    </div>
</div>

<!-- Modal pour voir les d√©tails -->
<div id="modal-detail" class="modal">
    <div class="modal-content">
        <div class="modal-header no-print">
            <h2>üìÑ D√©tails de l'enregistrement</h2>
            <span class="close-modal" onclick="closeDetailModal()">&times;</span>
        </div>
        <div id="detail-content" class="detail-view">
            <!-- Contenu dynamique -->
        </div>
        <div style="margin-top: 20px; text-align: center;" class="no-print">
            <button class="print-button" onclick="window.print()">üñ®Ô∏è Imprimer</button>
            <button class="print-button" onclick="generatePDF()">üìÑ G√©n√©rer PDF</button>
            <button class="btn btn-secondary" onclick="closeDetailModal()">‚ùå Fermer</button>
        </div>
    </div>
</div>

<!-- Modal pour modifier -->
<div id="modal-edit" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>‚úèÔ∏è Modifier l'enregistrement</h2>
            <span class="close-modal" onclick="closeEditModal()">&times;</span>
        </div>
        <form id="form-edit-dechet">
            <input type="hidden" id="edit-id" name="id">
            
            <div class="form-grid">
                <div class="form-group">
                    <label for="edit-date">Date <span class="required">*</span></label>
                    <input type="date" id="edit-date" name="date" required>
                </div>

                <div class="form-group">
                    <label for="edit-type">Type de d√©chet <span class="required">*</span></label>
                    <input type="text" id="edit-type" name="type" list="edit-type-list" required placeholder="Saisir le type de d√©chet">
                    <datalist id="edit-type-list">
                        {% for type in types_predefined %}
                        <option value="{{ type }}">
                        {% endfor %}
                    </datalist>
                </div>

                <div class="form-group">
                    <label for="edit-quantite">Quantit√© <span class="required">*</span></label>
                    <input type="number" id="edit-quantite" name="quantite" step="0.01" min="0" required>
                </div>

                <div class="form-group">
                    <label for="edit-unite">Unit√© <span class="required">*</span></label>
                    <input type="text" id="edit-unite" name="unite" required>
                </div>

                <div class="form-group">
                    <label for="edit-bon_reception_num">Bon de r√©ception N¬∞</label>
                    <input type="text" id="edit-bon_reception_num" name="bon_reception_num">
                </div>

                <div class="form-group">
                    <label for="edit-receptionnaire">R√©ceptionnaire</label>
                    <input type="text" id="edit-receptionnaire" name="receptionnaire">
                </div>
            </div>

            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button type="submit" class="btn btn-success">üíæ Enregistrer les modifications</button>
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">‚ùå Annuler</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
let allDechets = [];
let filteredDechets = [];
let chartTypes = null;
let chartMois = null;

$(document).ready(function() {
    // Plus besoin de Select2, on utilise des inputs normaux avec datalist
    
    // Focus automatique sur le champ type quand la modal s'ouvre
    $('#modal-saisie').on('shown.bs.modal', function() {
        $('#date').focus();
    });

    // Si section saisie, ouvrir automatiquement la popup
    {% if section == 'saisie' %}
    $('#modal-saisie').addClass('show');
    {% endif %}

    // Si section registre, charger les donn√©es
    {% if section == 'registre' %}
    loadDechets();
    {% endif %}

    // Si section stats, charger les statistiques
    {% if section == 'stats' %}
    loadStatistiques();
    {% endif %}

    // Soumission du formulaire d'ajout
    $('#form-dechet').on('submit', function(e) {
        e.preventDefault();
        
        const formData = {
            date: $('#date').val(),
            type: $('#type').val(),
            quantite: parseFloat($('#quantite').val()),
            unite: $('#unite').val(),
            bon_reception_num: $('#bon_reception_num').val(),
            receptionnaire: $('#receptionnaire').val()
        };

        $.ajax({
            url: '{{ url_for("projet14.ajouter") }}',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                showAlert('success', response.message || 'D√©chet enregistr√© avec succ√®s !');
                closeSaisieModal();
                $('#form-dechet')[0].reset();
                // Rediriger vers le registre
                window.location.href = '{{ url_for("projet14.registre") }}';
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.message || 'Erreur lors de l\'enregistrement';
                showAlert('danger', error);
            }
        });
    });

    // Soumission du formulaire de modification
    $('#form-edit-dechet').on('submit', function(e) {
        e.preventDefault();
        
        const id = $('#edit-id').val();
        const formData = {
            date: $('#edit-date').val(),
            type: $('#edit-type').val(),
            quantite: parseFloat($('#edit-quantite').val()),
            unite: $('#edit-unite').val(),
            bon_reception_num: $('#edit-bon_reception_num').val(),
            receptionnaire: $('#edit-receptionnaire').val()
        };

        $.ajax({
            url: `/projet14/modifier/${id}`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function(response) {
                showAlert('success', response.message || 'D√©chet modifi√© avec succ√®s !');
                closeEditModal();
                loadDechets();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.message || 'Erreur lors de la modification';
                showAlert('danger', error);
            }
        });
    });
});

function loadDechets() {
    $.ajax({
        url: '{{ url_for("projet14.liste") }}',
        method: 'GET',
        success: function(data) {
            // Afficher le tableau avec toutes les donn√©es
            displayDechets(data);
        },
        error: function() {
            showAlert('danger', 'Erreur lors du chargement des donn√©es');
        }
    });
}

function displayDechets(dechets) {
    const tbody = document.getElementById('table-body');
    
    if (!dechets || dechets.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="empty-state">
                    <div style="font-size: 2rem;">üì¶</div>
                    <p>Aucun d√©chet enregistr√©</p>
                </td>
            </tr>
        `;
        document.getElementById('filter-count').textContent = '0';
        return;
    }

    let html = '';
    dechets.forEach(d => {
        // Convertir le num√©ro de mois en nom fran√ßais et classe CSS
        const monthName = getMonthName(d.mois_num);
        const monthClass = getMonthClass(d.mois_num);
        
        html += `
            <tr>
                <td><span class="month-badge ${monthClass}">${monthName}</span></td>
                <td>${d.date}</td>
                <td>${d.type}</td>
                <td><strong>${d.quantite}</strong></td>
                <td>${d.unite}</td>
                <td>${d.bon_reception_num || '-'}</td>
                <td>${d.receptionnaire || '-'}</td>
                <td>
                    <div class="action-buttons">
                        <button class="btn-view" onclick="viewDetail(${d.id})" title="Voir la fiche">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                                <circle cx="12" cy="12" r="3"></circle>
                            </svg>
                        </button>
                        <button class="btn-edit" onclick="editDechet(${d.id})" title="Modifier">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                        </button>
                        <button class="btn-delete" onclick="deleteDechet(${d.id})" title="Supprimer">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"></polyline>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                <line x1="10" y1="11" x2="10" y2="17"></line>
                                <line x1="14" y1="11" x2="14" y2="17"></line>
                            </svg>
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });

    tbody.innerHTML = html;
    
    // Mettre √† jour le compteur avec le nombre total de lignes
    appliquerFiltres();
}

// Variables globales pour le tri
let currentSortColumn = '';
let currentSortDirection = 'asc';

// Fonction pour convertir un num√©ro de mois (1-12) en nom fran√ßais
function getMonthName(monthNum) {
    const monthNames = [
        'Janvier',    // 1
        'F√©vrier',    // 2
        'Mars',       // 3
        'Avril',      // 4
        'Mai',        // 5
        'Juin',       // 6
        'Juillet',    // 7
        'Ao√ªt',       // 8
        'Septembre',  // 9
        'Octobre',    // 10
        'Novembre',   // 11
        'D√©cembre'    // 12
    ];
    
    if (!monthNum || monthNum < 1 || monthNum > 12) return '';
    return monthNames[monthNum - 1];
}

// Fonction pour d√©terminer la classe CSS du mois
function getMonthClass(monthNum) {
    const monthClasses = [
        'janvier',    // 1
        'fevrier',    // 2
        'mars',       // 3
        'avril',      // 4
        'mai',        // 5
        'juin',       // 6
        'juillet',    // 7
        'aout',       // 8
        'septembre',  // 9
        'octobre',    // 10
        'novembre',   // 11
        'decembre'    // 12
    ];
    
    if (!monthNum || monthNum < 1 || monthNum > 12) return '';
    return monthClasses[monthNum - 1];
}

function appliquerFiltres() {
    const filterMois = document.getElementById('filter-mois').value.toLowerCase().trim();
    const filterDate = document.getElementById('filter-date').value.toLowerCase().trim();
    const filterType = document.getElementById('filter-type').value.toLowerCase().trim();
    const filterQuantite = document.getElementById('filter-quantite').value.toLowerCase().trim();
    const filterUnite = document.getElementById('filter-unite').value.toLowerCase().trim();
    const filterBon = document.getElementById('filter-bon').value.toLowerCase().trim();
    const filterReceptionnaire = document.getElementById('filter-receptionnaire').value.toLowerCase().trim();
    
    const tbody = document.getElementById('table-body');
    const rows = tbody.getElementsByTagName('tr');
    let visibleCount = 0;
    
    // Parcourir toutes les lignes du tableau
    for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        
        // Ignorer la ligne d'√©tat vide
        if (row.classList.contains('empty-state') || row.querySelector('.empty-state')) {
            continue;
        }
        
        const cells = row.getElementsByTagName('td');
        if (cells.length < 7) continue;
        
        const moisText = cells[0].textContent.toLowerCase();
        const dateText = cells[1].textContent.toLowerCase();
        const typeText = cells[2].textContent.toLowerCase();
        const quantiteText = cells[3].textContent.toLowerCase();
        const uniteText = cells[4].textContent.toLowerCase();
        const bonText = cells[5].textContent.toLowerCase();
        const receptionnaireText = cells[6].textContent.toLowerCase();
        
        // V√©rifier si la ligne correspond √† tous les filtres
        const matchMois = !filterMois || moisText.includes(filterMois);
        const matchDate = !filterDate || dateText.includes(filterDate);
        const matchType = !filterType || typeText.includes(filterType);
        const matchQuantite = !filterQuantite || quantiteText.includes(filterQuantite);
        const matchUnite = !filterUnite || uniteText.includes(filterUnite);
        const matchBon = !filterBon || bonText.includes(filterBon);
        const matchReceptionnaire = !filterReceptionnaire || receptionnaireText.includes(filterReceptionnaire);
        
        if (matchMois && matchDate && matchType && matchQuantite && matchUnite && matchBon && matchReceptionnaire) {
            row.classList.remove('filtered-out');
            visibleCount++;
        } else {
            row.classList.add('filtered-out');
        }
    }
    
    // Mettre √† jour le compteur
    document.getElementById('filter-count').textContent = visibleCount;
}

function resetFilters() {
    // R√©initialiser tous les champs de filtre
    document.getElementById('filter-mois').value = '';
    document.getElementById('filter-date').value = '';
    document.getElementById('filter-type').value = '';
    document.getElementById('filter-quantite').value = '';
    document.getElementById('filter-unite').value = '';
    document.getElementById('filter-bon').value = '';
    document.getElementById('filter-receptionnaire').value = '';
    
    // R√©initialiser les indicateurs de tri
    document.querySelectorAll('.data-table th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    currentSortColumn = '';
    currentSortDirection = 'asc';
    
    // R√©afficher toutes les lignes
    appliquerFiltres();
}

function trierTableau(column) {
    const tbody = document.getElementById('table-body');
    const rows = Array.from(tbody.getElementsByTagName('tr')).filter(row => 
        !row.classList.contains('empty-state') && 
        !row.querySelector('.empty-state')
    );
    
    if (rows.length === 0) return;
    
    // D√©terminer la direction du tri
    if (currentSortColumn === column) {
        // Inverser la direction si on clique sur la m√™me colonne
        currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
    } else {
        // Nouvelle colonne : tri ascendant par d√©faut
        currentSortColumn = column;
        currentSortDirection = 'asc';
    }
    
    // Retirer les classes de tri de tous les en-t√™tes
    document.querySelectorAll('.data-table th.sortable').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
    });
    
    // Ajouter la classe appropri√©e √† l'en-t√™te actif
    const columnMap = {
        'mois': 0,
        'date': 1,
        'type': 2,
        'quantite': 3,
        'unite': 4,
        'bon': 5,
        'receptionnaire': 6
    };
    
    const columnIndex = columnMap[column];
    const headers = document.querySelectorAll('.data-table th.sortable');
    if (headers[Object.keys(columnMap).indexOf(column)]) {
        headers[Object.keys(columnMap).indexOf(column)].classList.add('sort-' + currentSortDirection);
    }
    
    // Trier les lignes
    rows.sort((a, b) => {
        const cellA = a.getElementsByTagName('td')[columnIndex];
        const cellB = b.getElementsByTagName('td')[columnIndex];
        
        if (!cellA || !cellB) return 0;
        
        let valA = cellA.textContent.trim();
        let valB = cellB.textContent.trim();
        
        // Traitement sp√©cial pour les quantit√©s (num√©riques)
        if (column === 'quantite') {
            valA = parseFloat(valA.replace(/[^0-9.-]/g, '')) || 0;
            valB = parseFloat(valB.replace(/[^0-9.-]/g, '')) || 0;
            
            if (currentSortDirection === 'asc') {
                return valA - valB;
            } else {
                return valB - valA;
            }
        }
        
        // Traitement sp√©cial pour les dates (format YYYY-MM-DD)
        if (column === 'date') {
            const dateA = new Date(valA);
            const dateB = new Date(valB);
            
            if (currentSortDirection === 'asc') {
                return dateA - dateB;
            } else {
                return dateB - dateA;
            }
        }
        
        // Traitement sp√©cial pour les mois (nom fran√ßais -> num√©ro)
        if (column === 'mois') {
            const monthOrder = {
                'janvier': 1, 'f√©vrier': 2, 'mars': 3, 'avril': 4,
                'mai': 5, 'juin': 6, 'juillet': 7, 'ao√ªt': 8,
                'septembre': 9, 'octobre': 10, 'novembre': 11, 'd√©cembre': 12
            };
            
            const monthA = monthOrder[valA.toLowerCase()] || 0;
            const monthB = monthOrder[valB.toLowerCase()] || 0;
            
            if (currentSortDirection === 'asc') {
                return monthA - monthB;
            } else {
                return monthB - monthA;
            }
        }
        
        // Comparaison alphab√©tique pour les autres colonnes
        if (currentSortDirection === 'asc') {
            return valA.localeCompare(valB, 'fr', { numeric: true });
        } else {
            return valB.localeCompare(valA, 'fr', { numeric: true });
        }
    });
    
    // R√©organiser les lignes dans le tbody
    rows.forEach(row => tbody.appendChild(row));
}

function viewDetail(id) {
    $.ajax({
        url: `/projet14/modifier/${id}`,
        method: 'GET',
        success: function(dechet) {
            let html = `
                <div class="detail-grid">
                    <div class="detail-item">
                        <div class="detail-label">Date</div>
                        <div class="detail-value">${dechet.date}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Type de d√©chet</div>
                        <div class="detail-value">${dechet.type}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Quantit√©</div>
                        <div class="detail-value">${dechet.quantite} ${dechet.unite}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Bon de r√©ception N¬∞</div>
                        <div class="detail-value">${dechet.bon_reception_num || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">R√©ceptionnaire</div>
                        <div class="detail-value">${dechet.receptionnaire || '-'}</div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Date d'enregistrement</div>
                        <div class="detail-value">${dechet.date_creation}</div>
                    </div>
                </div>
            `;
            $('#detail-content').html(html);
            $('#modal-detail').addClass('show');
        },
        error: function() {
            showAlert('danger', 'Erreur lors du chargement des d√©tails');
        }
    });
}

function editDechet(id) {
    $.ajax({
        url: `/projet14/modifier/${id}`,
        method: 'GET',
        success: function(dechet) {
            $('#edit-id').val(dechet.id);
            $('#edit-date').val(dechet.date);
            $('#edit-type').val(dechet.type);
            $('#edit-quantite').val(dechet.quantite);
            $('#edit-unite').val(dechet.unite);
            $('#edit-bon_reception_num').val(dechet.bon_reception_num || '');
            $('#edit-receptionnaire').val(dechet.receptionnaire || '');
            
            $('#modal-edit').addClass('show');
        },
        error: function() {
            showAlert('danger', 'Erreur lors du chargement des donn√©es');
        }
    });
}

function deleteDechet(id) {
    if (confirm('√ätes-vous s√ªr de vouloir supprimer cet enregistrement ?')) {
        $.ajax({
            url: `/projet14/supprimer/${id}`,
            method: 'POST',
            success: function(response) {
                showAlert('success', response.message || 'D√©chet supprim√© avec succ√®s !');
                loadDechets();
            },
            error: function(xhr) {
                const error = xhr.responseJSON?.message || 'Erreur lors de la suppression';
                showAlert('danger', error);
            }
        });
    }
}

function loadStatistiques() {
    // Charger d'abord les ann√©es disponibles pour le s√©lecteur
    chargerAnneesDisponibles();
    
    // Puis charger les statistiques
    chargerStatistiques();
}

function chargerAnneesDisponibles() {
    $.ajax({
        url: '{{ url_for("projet14.liste") }}',
        method: 'GET',
        success: function(dechets) {
            // Extraire les ann√©es uniques des dates
            const annees = new Set();
            dechets.forEach(d => {
                if (d.date) {
                    const annee = d.date.split('-')[0];
                    annees.add(annee);
                }
            });
            
            // Trier les ann√©es par ordre d√©croissant
            const anneesTriees = Array.from(annees).sort((a, b) => b - a);
            
            // Populer les s√©lecteurs d'ann√©e
            let options = '<option value="">Toutes les ann√©es</option>';
            anneesTriees.forEach(annee => {
                options += `<option value="${annee}">${annee}</option>`;
            });
            $('#filter-annee').html(options);
            
            // Populer aussi le filtre du graphique
            let optionsChart = '<option value="">Toutes</option>';
            anneesTriees.forEach(annee => {
                optionsChart += `<option value="${annee}">${annee}</option>`;
            });
            $('#filter-chart-annee').html(optionsChart);
        },
        error: function() {
            console.error('Erreur lors du chargement des ann√©es');
        }
    });
}

function chargerStatistiques() {
    const annee = $('#filter-annee').val();
    const url = annee 
        ? '{{ url_for("projet14.api_statistiques") }}?annee=' + annee
        : '{{ url_for("projet14.api_statistiques") }}';
    
    // Mettre √† jour le titre du graphique mensuel
    if (annee) {
        $('#chart-mois-titre').text(`üìÖ √âvolution mensuelle - D√©chets solides (ann√©e ${annee})`);
    } else {
        $('#chart-mois-titre').text('üìÖ √âvolution mensuelle - D√©chets solides (12 derniers mois)');
    }
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(stats) {
            displayStatistiques(stats);
        },
        error: function() {
            showAlert('danger', 'Erreur lors du chargement des statistiques');
        }
    });
}

function displayStatistiques(stats) {
    // Cartes statistiques
    let html = `
        <div class="stat-card">
            <h3>Total d'enregistrements</h3>
            <div class="stat-value">${stats.total_enregistrements}</div>
            <div class="stat-unit">enregistrements</div>
        </div>
        <div class="stat-card" style="border-left-color: #27ae60;">
            <h3>üü¢ D√©chets solides (kg)</h3>
            <div class="stat-value">${stats.total_quantite_kg.toFixed(2)}</div>
            <div class="stat-unit">kg</div>
        </div>
        <div class="stat-card" style="border-left-color: #3498db;">
            <h3>üîµ D√©chets liquides (m¬≥)</h3>
            <div class="stat-value">${stats.total_quantite_m3.toFixed(2)}</div>
            <div class="stat-unit">m¬≥</div>
        </div>
        <div class="stat-card">
            <h3>Types de d√©chets</h3>
            <div class="stat-value">${stats.stats_par_type.length}</div>
            <div class="stat-unit">types diff√©rents</div>
        </div>
    `;
    
    // Ajouter une carte pour "Autres unit√©s" si n√©cessaire
    if (stats.total_quantite_autre > 0) {
        html += `
        <div class="stat-card" style="border-left-color: #e67e22;">
            <h3>üü† Autres unit√©s</h3>
            <div class="stat-value">${stats.total_quantite_autre.toFixed(2)}</div>
            <div class="stat-unit">unit√©s diverses</div>
        </div>
        `;
    }
    
    $('#stats-cards').html(html);

    // Charger le graphique par type avec les filtres actuels
    chargerGraphiqueTypes();

    // Graphique par mois - Uniquement d√©chets solides (kg)
    const ctxMois = document.getElementById('chart-mois').getContext('2d');
    if (chartMois) chartMois.destroy();
    chartMois = new Chart(ctxMois, {
        type: 'bar',
        data: {
            labels: stats.stats_par_mois.map(s => s.mois),
            datasets: [{
                label: 'D√©chets solides (kg)',
                data: stats.stats_par_mois.map(s => s.total_quantite_kg),
                backgroundColor: 'rgba(39, 174, 96, 0.7)',
                borderColor: 'rgba(39, 174, 96, 1)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: { 
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Quantit√© (kg)'
                    }
                }
            },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'D√©chets solides : ' + context.parsed.y.toFixed(2) + ' kg';
                        }
                    }
                }
            }
        }
    });
}

// Couleurs fixes pour chaque type de d√©chet (insensible √† la casse)
const typeColors = {
    'papier offset': 'rgba(52, 152, 219, 0.8)',      // Bleu ciel
    'carton blanc gris': 'rgba(241, 196, 15, 0.8)',  // Jaune/Or
    'carton blanc bois': 'rgba(39, 174, 96, 0.8)',   // Vert
    'eaux pollu√©es': 'rgba(0, 188, 212, 0.9)',       // üíß Cyan √©clatant (liquide)
    'eaux polluees': 'rgba(0, 188, 212, 0.9)',       // üíß Cyan √©clatant (variante)
    // Couleurs par d√©faut pour d'autres types
    'default': [
        'rgba(231, 76, 60, 0.8)',   // Rouge
        'rgba(155, 89, 182, 0.8)',  // Violet
        'rgba(26, 188, 156, 0.8)',  // Turquoise
        'rgba(230, 126, 34, 0.8)',  // Orange
        'rgba(149, 165, 166, 0.8)', // Gris
        'rgba(243, 156, 18, 0.8)'   // Orange fonc√©
    ]
};

// Fonction pour obtenir la couleur d'un type (insensible √† la casse)
function getColorForType(typeName, defaultIndex) {
    const normalizedName = typeName.toLowerCase().trim();
    return typeColors[normalizedName] || typeColors['default'][defaultIndex % typeColors['default'].length];
}

// Charger le graphique des types avec filtres
function chargerGraphiqueTypes() {
    const typeRecherche = $('#filter-chart-type').val().toLowerCase().trim();
    const annee = $('#filter-chart-annee').val();
    const mois = $('#filter-chart-mois').val();
    
    // Construire l'URL avec les param√®tres
    let url = '{{ url_for("projet14.liste") }}';
    
    $.ajax({
        url: url,
        method: 'GET',
        success: function(dechets) {
            // Filtrer les d√©chets selon les crit√®res s√©lectionn√©s
            let dechetsFiltres = dechets;
            
            // Filtre par type (contient)
            if (typeRecherche) {
                dechetsFiltres = dechetsFiltres.filter(d => {
                    if (d.type) {
                        return d.type.toLowerCase().includes(typeRecherche);
                    }
                    return false;
                });
            }
            
            // Filtre par ann√©e
            if (annee) {
                dechetsFiltres = dechetsFiltres.filter(d => {
                    if (d.date) {
                        return d.date.startsWith(annee);
                    }
                    return false;
                });
            }
            
            // Filtre par mois
            if (mois) {
                dechetsFiltres = dechetsFiltres.filter(d => {
                    if (d.date) {
                        const moisDate = parseInt(d.date.split('-')[1], 10);
                        return moisDate === parseInt(mois, 10);
                    }
                    return false;
                });
            }
            
            // Calculer les totaux par type
            const statsParType = {};
            dechetsFiltres.forEach(d => {
                const type = d.type.trim();
                if (!statsParType[type]) {
                    statsParType[type] = 0;
                }
                statsParType[type] += d.quantite;
            });
            
            // Convertir en tableau et trier par quantit√©
            const statsArray = Object.entries(statsParType)
                .map(([type, quantite]) => ({ type, quantite }))
                .sort((a, b) => b.quantite - a.quantite);
            
            // Cr√©er le graphique
            const ctxTypes = document.getElementById('chart-types').getContext('2d');
            if (chartTypes) chartTypes.destroy();
            
            if (statsArray.length === 0) {
                // Afficher un message si aucune donn√©e
                ctxTypes.clearRect(0, 0, ctxTypes.canvas.width, ctxTypes.canvas.height);
                ctxTypes.font = '16px Arial';
                ctxTypes.fillStyle = '#95a5a6';
                ctxTypes.textAlign = 'center';
                ctxTypes.fillText('Aucune donn√©e disponible pour cette p√©riode', ctxTypes.canvas.width / 2, ctxTypes.canvas.height / 2);
                return;
            }
            
            chartTypes = new Chart(ctxTypes, {
                type: 'doughnut',
                data: {
                    labels: statsArray.map(s => s.type),
                    datasets: [{
                        data: statsArray.map(s => s.quantite),
                        backgroundColor: statsArray.map((s, index) => getColorForType(s.type, index)),
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    return label + ': ' + value.toFixed(2) + ' kg';
                                }
                            }
                        }
                    }
                }
            });
        },
        error: function() {
            showAlert('danger', 'Erreur lors du chargement des donn√©es du graphique');
        }
    });
}

// R√©initialiser les filtres du graphique
function resetFiltersGraphique() {
    $('#filter-chart-type').val('');
    $('#filter-chart-annee').val('');
    $('#filter-chart-mois').val('');
    chargerGraphiqueTypes();
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} show">
            ${message}
        </div>
    `;
    $('#alert-container').html(alertHtml);
    setTimeout(() => {
        $('.alert').removeClass('show');
        setTimeout(() => $('#alert-container').html(''), 300);
    }, 5000);
}

function closeDetailModal() {
    $('#modal-detail').removeClass('show');
}

function closeEditModal() {
    $('#modal-edit').removeClass('show');
    $('#form-edit-dechet')[0].reset();
}

function closeSaisieModal() {
    $('#modal-saisie').removeClass('show');
    // Rediriger vers la page principale
    window.location.href = '{{ url_for("projet14.index") }}';
}

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    const content = $('#detail-content').text();
    doc.text(content, 10, 10);
    doc.save('fiche-dechet.pdf');
}

// Fermer les modals en cliquant en dehors
window.onclick = function(event) {
    if (event.target.className === 'modal show') {
        event.target.classList.remove('show');
    }
}
</script>
{% endblock %}
