{% extends "base.html" %}

{% block title %}Statistiques Contr√¥le Qualit√© - Projet10{% endblock %}

{% block head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h2 class="mb-0">Statistiques de Contr√¥le Qualit√©</h2>
            <a class="btn btn-outline-secondary" href="{{ url_for('projet10.index') }}">‚Üê Retour</a>
        </div>
    </div>

    <div class="row" id="stats-root">
        <div class="col-12 text-center text-muted py-4">Chargement des statistiques...</div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    chargerStatsPage();
});

function chargerStatsPage(){
    const root = document.getElementById('stats-root');
    fetch('/projet10/api/statistiques')
        .then(r=>r.json())
        .then(data=>{
            const fmt = (n)=> (n ?? 0).toLocaleString('fr-FR', { maximumFractionDigits: 0 });
            const f3 = (n)=> (n ?? 0).toLocaleString('fr-FR', { minimumFractionDigits: 3, maximumFractionDigits: 3 });
            root.innerHTML = `
                <div class="col-12 mb-3">
                    <div class="alert alert-secondary">Les statistiques sont :</div>
                </div>

                <div class="col-md-3 mb-3">
                    <div class="card text-center border-primary shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Total Contr√¥les</h6>
                            <h2 class="text-primary mb-0">${fmt(data.total_controles)}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-success shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Contr√¥les Valid√©s</h6>
                            <h2 class="text-success mb-0">${fmt(data.controles_valides)}</h2>
                            <small class="text-muted">${(data.total_controles>0?((data.controles_valides/data.total_controles)*100).toFixed(3):'0.000')}% valid√©s</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-info shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Total Produit</h6>
                            <h2 class="text-info mb-0">${fmt(data.total_produit||0)}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="card text-center border-success shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Taux de Conformit√©</h6>
                            <h2 class="text-success mb-0">${f3(data.taux_conformite||0)}%</h2>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-3">
                    <div class="card text-center border-success shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Total Conforme</h6>
                            <h2 class="text-success mb-0">${fmt(data.total_conforme||0)}</h2>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center border-danger shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Total Non-Conforme (Rebus)</h6>
                            <h2 class="text-danger mb-0">${fmt(data.total_non_conforme||0)}</h2>
                            <small class="text-muted">${f3(data.taux_rebus||0)}% de rebus</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center border-warning shadow-sm">
                        <div class="card-body">
                            <h6 class="text-muted">Rebus Moyen</h6>
                            <h2 class="text-warning mb-0">${f3(data.rebus_moyen||0)}</h2>
                            <small class="text-muted">par contr√¥le</small>
                        </div>
                    </div>
                </div>

                <div class="col-12 mt-4 d-flex gap-2 justify-content-center flex-wrap">
                    <a class="btn btn-outline-primary" href="#" onclick="return chargerStatsMachines();">üè≠ Voir par Machine</a>
                    <a class="btn btn-outline-info" href="#" onclick="return chargerEvolution();">üìà Voir √âvolution</a>
                    <a class="btn btn-outline-danger" href="#" onclick="return chargerDossiersProbleme();">‚ö†Ô∏è Dossiers √† Probl√®me</a>
                    <a class="btn btn-outline-success" href="#" onclick="return chargerComparaisons();">‚öñÔ∏è Comparaisons</a>
                </div>

                <div class="col-12 mt-4" id="stats-additionnelles"></div>
            `;
        })
        .catch(err=>{
            root.innerHTML = `<div class="col-12"><div class="alert alert-danger">Erreur: ${err.message}</div></div>`
        });
}

function chargerStatsMachines(){
    const container = document.getElementById('stats-additionnelles');
    container.innerHTML = '<div class="alert alert-secondary">Chargement machines...</div>';
    fetch('/projet10/api/statistiques/machines').then(r=>r.json()).then(data=>{
        if(!data || !data.length){ container.innerHTML = '<div class="alert alert-info">Aucune donn√©e.</div>'; return false; }
        const fmt=(n)=> (n||0).toLocaleString('fr-FR');
        let html = `
            <h4 class="text-primary mb-3">üè≠ Performance par Machine</h4>
            <div class="table-responsive">
            <table class="table table-striped table-hover">
            <thead class="table-primary"><tr>
              <th>Machine</th><th class="text-center">Nb Contr√¥les</th><th class="text-center">Total Conforme</th>
              <th class="text-center">Total Rebus</th><th class="text-center">Total Produit</th><th class="text-center">Taux Conformit√©</th>
            </tr></thead><tbody>`;
        data.forEach(m=>{
            html += `<tr>
                <td><strong>${m.machine}</strong></td>
                <td class="text-center">${fmt(m.nombre_controles)}</td>
                <td class="text-center text-success">${fmt(m.total_conforme)}</td>
                <td class="text-center text-danger">${fmt(m.total_rebus)}</td>
                <td class="text-center">${fmt(m.total_produit)}</td>
                <td class="text-center">${m.taux_conformite}%</td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }).catch(err=>{ container.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`; });
    return false;
}

function chargerEvolution(){
    const container = document.getElementById('stats-additionnelles');
    container.innerHTML = '<div class="alert alert-secondary">Chargement √©volution...</div>';
    fetch('/projet10/api/statistiques/evolution?jours=30').then(r=>r.json()).then(data=>{
        if(!data || !data.length){ container.innerHTML = '<div class="alert alert-info">Aucune donn√©e.</div>'; return false; }
        
        // Pr√©parer les donn√©es pour les graphiques
        const labels = data.map(d => new Date(d.date).toLocaleDateString('fr-FR', {day: '2-digit', month: '2-digit'}));
        const conformeData = data.map(d => d.total_conforme || 0);
        const rebusData = data.map(d => d.total_rebus || 0);
        const totalData = data.map(d => d.total_produit || 0);
        const tauxData = data.map(d => parseFloat(d.taux_conformite) || 0);
        
        // Cr√©er le HTML avec deux graphiques
        container.innerHTML = `
            <h4 class="text-primary mb-3">üìà √âvolution (30 jours)</h4>
            <div class="row">
                <div class="col-lg-8 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title text-center text-muted mb-3">Production et Qualit√©</h6>
                            <canvas id="chartEvolutionProduction"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 mb-4">
                    <div class="card shadow-sm">
                        <div class="card-body">
                            <h6 class="card-title text-center text-muted mb-3">Taux de Conformit√© (%)</h6>
                            <canvas id="chartEvolutionTaux"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Graphique 1: √âvolution des quantit√©s (Conforme, Rebus, Total)
        const ctx1 = document.getElementById('chartEvolutionProduction').getContext('2d');
        new Chart(ctx1, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Total Produit',
                        data: totalData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Conforme',
                        data: conformeData,
                        borderColor: 'rgb(40, 167, 69)',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Rebus',
                        data: rebusData,
                        borderColor: 'rgb(220, 53, 69)',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + context.parsed.y.toLocaleString('fr-FR');
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fr-FR');
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                },
                interaction: {
                    mode: 'nearest',
                    axis: 'x',
                    intersect: false
                }
            }
        });
        
        // Graphique 2: √âvolution du taux de conformit√©
        const ctx2 = document.getElementById('chartEvolutionTaux').getContext('2d');
        new Chart(ctx2, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Taux de Conformit√©',
                    data: tauxData,
                    borderColor: 'rgb(0, 123, 255)',
                    backgroundColor: 'rgba(0, 123, 255, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: true,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.parsed.y.toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3}) + '%';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            callback: function(value) {
                                return value.toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3}) + '%';
                            }
                        }
                    },
                    x: {
                        ticks: {
                            maxRotation: 45,
                            minRotation: 45
                        }
                    }
                }
            }
        });
        
    }).catch(err=>{ container.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`; });
    return false;
}

function chargerDossiersProbleme(){
    const container = document.getElementById('stats-additionnelles');
    container.innerHTML = '<div class="alert alert-secondary">Chargement dossiers...</div>';
    fetch('/projet10/api/statistiques/dossiers-probleme?seuil=5').then(r=>r.json()).then(data=>{
        if(!data || !data.length){ container.innerHTML = '<div class="alert alert-success">‚úÖ Aucun dossier au-dessus du seuil.</div>'; return false; }
        const fmt=(n)=> (n||0).toLocaleString('fr-FR');
        let html = `
            <h4 class="text-danger mb-3">‚ö†Ô∏è Dossiers √† Probl√®me</h4>
            <div class="table-responsive">
            <table class="table table-striped table-hover">
            <thead class="table-danger"><tr>
              <th>N¬∞ Dossier</th><th>Date</th><th>Op√©rateur</th><th>Machine</th>
              <th class="text-center">Conforme</th><th class="text-center">Rebus</th><th class="text-center">Total</th><th class="text-center">Taux Rebus</th>
            </tr></thead><tbody>`;
        data.forEach(d=>{
            const df = new Date(d.date).toLocaleDateString('fr-FR');
            html += `<tr>
                <td><strong>${d.Numero_COMMANDES}</strong></td>
                <td>${df}</td>
                <td>${d.operateur||'-'}</td>
                <td>${d.machine||'-'}</td>
                <td class="text-center text-success">${fmt(d.total_conforme)}</td>
                <td class="text-center text-danger">${fmt(d.total_rebus)}</td>
                <td class="text-center">${fmt(d.total_produit)}</td>
                <td class="text-center">${d.taux_rebus}%</td>
            </tr>`;
        });
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }).catch(err=>{ container.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`; });
    return false;
}

function chargerComparaisons(){
    const container = document.getElementById('stats-additionnelles');
    
    // Calculer les dates pour ce mois et le mois dernier
    const now = new Date();
    const debutMoisActuel = new Date(now.getFullYear(), now.getMonth(), 1);
    const finMoisActuel = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    const debutMoisPrecedent = new Date(now.getFullYear(), now.getMonth() - 1, 1);
    const finMoisPrecedent = new Date(now.getFullYear(), now.getMonth(), 0);
    
    const formatDate = (d) => d.toISOString().split('T')[0];
    
    container.innerHTML = `
        <h4 class="text-success mb-4">‚öñÔ∏è Comparaisons</h4>
        
        <!-- Onglets de comparaison -->
        <ul class="nav nav-tabs mb-3" id="comparaisonTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="periodes-tab" data-bs-toggle="tab" data-bs-target="#periodes-content" type="button">
                    üìÖ Comparer des P√©riodes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="machines-tab" data-bs-toggle="tab" data-bs-target="#machines-content" type="button">
                    üè≠ Comparer des Machines
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="comparaisonTabsContent">
            <!-- ONGLET COMPARAISON P√âRIODES -->
            <div class="tab-pane fade show active" id="periodes-content" role="tabpanel">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <h6 class="text-primary">P√©riode 1</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Date d√©but</label>
                                        <input type="date" class="form-control form-control-sm" id="p1-debut" value="${formatDate(debutMoisActuel)}">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Date fin</label>
                                        <input type="date" class="form-control form-control-sm" id="p1-fin" value="${formatDate(finMoisActuel)}">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-info">P√©riode 2</h6>
                                <div class="row">
                                    <div class="col-6">
                                        <label class="form-label small">Date d√©but</label>
                                        <input type="date" class="form-control form-control-sm" id="p2-debut" value="${formatDate(debutMoisPrecedent)}">
                                    </div>
                                    <div class="col-6">
                                        <label class="form-label small">Date fin</label>
                                        <input type="date" class="form-control form-control-sm" id="p2-fin" value="${formatDate(finMoisPrecedent)}">
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-success" onclick="comparerPeriodes()">üîç Comparer les P√©riodes</button>
                        </div>
                    </div>
                </div>
                <div id="resultat-periodes"></div>
            </div>
            
            <!-- ONGLET COMPARAISON MACHINES -->
            <div class="tab-pane fade" id="machines-content" role="tabpanel">
                <div class="card shadow-sm mb-4">
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="form-label">Machine 1</label>
                                <select class="form-select" id="machine1-select">
                                    <option value="">Chargement...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Machine 2</label>
                                <select class="form-select" id="machine2-select">
                                    <option value="">Chargement...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">P√©riode (jours)</label>
                                <select class="form-select" id="jours-select">
                                    <option value="7">7 jours</option>
                                    <option value="15">15 jours</option>
                                    <option value="30" selected>30 jours</option>
                                    <option value="60">60 jours</option>
                                    <option value="90">90 jours</option>
                                </select>
                            </div>
                        </div>
                        <div class="text-center">
                            <button class="btn btn-success" onclick="comparerMachines()">üîç Comparer les Machines</button>
                        </div>
                    </div>
                </div>
                <div id="resultat-machines"></div>
            </div>
        </div>
    `;
    
    // Charger la liste des machines
    chargerListeMachines();
    
    return false;
}

function chargerListeMachines(){
    fetch('/projet10/api/machines-disponibles')
        .then(r => r.json())
        .then(machines => {
            const select1 = document.getElementById('machine1-select');
            const select2 = document.getElementById('machine2-select');
            
            const optionsHTML = '<option value="">-- S√©lectionner --</option>' + 
                machines.map(m => `<option value="${m}">${m}</option>`).join('');
            
            select1.innerHTML = optionsHTML;
            select2.innerHTML = optionsHTML;
        })
        .catch(err => console.error('Erreur chargement machines:', err));
}

function comparerPeriodes(){
    const p1Debut = document.getElementById('p1-debut').value;
    const p1Fin = document.getElementById('p1-fin').value;
    const p2Debut = document.getElementById('p2-debut').value;
    const p2Fin = document.getElementById('p2-fin').value;
    
    if(!p1Debut || !p1Fin || !p2Debut || !p2Fin){
        alert('Veuillez remplir toutes les dates');
        return;
    }
    
    const resultat = document.getElementById('resultat-periodes');
    resultat.innerHTML = '<div class="alert alert-secondary">Comparaison en cours...</div>';
    
    fetch(`/projet10/api/statistiques/comparaison-periodes?date_debut1=${p1Debut}&date_fin1=${p1Fin}&date_debut2=${p2Debut}&date_fin2=${p2Fin}`)
        .then(r => r.json())
        .then(data => {
            const fmt = (n) => (n || 0).toLocaleString('fr-FR');
            const f3 = (n) => (n || 0).toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3});
            
            const p1 = data.periode1;
            const p2 = data.periode2;
            
            // Calculer les diff√©rences
            const diffControles = p1.nombre_controles - p2.nombre_controles;
            const diffConforme = p1.total_conforme - p2.total_conforme;
            const diffRebus = p1.total_rebus - p2.total_rebus;
            const diffTaux = p1.taux_conformite - p2.taux_conformite;
            
            const flecheControles = diffControles > 0 ? '‚ÜóÔ∏è' : (diffControles < 0 ? '‚ÜòÔ∏è' : '‚û°Ô∏è');
            const flecheConforme = diffConforme > 0 ? '‚ÜóÔ∏è' : (diffConforme < 0 ? '‚ÜòÔ∏è' : '‚û°Ô∏è');
            const flecheRebus = diffRebus > 0 ? '‚ö†Ô∏è‚ÜóÔ∏è' : (diffRebus < 0 ? '‚úÖ‚ÜòÔ∏è' : '‚û°Ô∏è');
            const flecheTaux = diffTaux > 0 ? '‚úÖ‚ÜóÔ∏è' : (diffTaux < 0 ? '‚ö†Ô∏è‚ÜòÔ∏è' : '‚û°Ô∏è');
            
            resultat.innerHTML = `
                <div class="row">
                    <!-- Graphique comparatif -->
                    <div class="col-lg-8 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-center mb-3">Comparaison Graphique</h6>
                                <canvas id="chartComparaisonPeriodes"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tableau comparatif -->
                    <div class="col-lg-4 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-center mb-3">Diff√©rences</h6>
                                <table class="table table-sm">
                                    <tr>
                                        <td><strong>Contr√¥les</strong></td>
                                        <td class="text-end">${flecheControles} ${diffControles > 0 ? '+' : ''}${fmt(diffControles)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Conforme</strong></td>
                                        <td class="text-end">${flecheConforme} ${diffConforme > 0 ? '+' : ''}${fmt(diffConforme)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Rebus</strong></td>
                                        <td class="text-end">${flecheRebus} ${diffRebus > 0 ? '+' : ''}${fmt(diffRebus)}</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Taux Conf.</strong></td>
                                        <td class="text-end">${flecheTaux} ${diffTaux > 0 ? '+' : ''}${f3(diffTaux)}%</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Cr√©er le graphique
            const ctx = document.getElementById('chartComparaisonPeriodes').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Contr√¥les', 'Conforme', 'Rebus', 'Total Produit'],
                    datasets: [
                        {
                            label: 'P√©riode 1',
                            data: [p1.nombre_controles, p1.total_conforme, p1.total_rebus, p1.total_produit],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 2
                        },
                        {
                            label: 'P√©riode 2',
                            data: [p2.nombre_controles, p2.total_conforme, p2.total_rebus, p2.total_produit],
                            backgroundColor: 'rgba(255, 159, 64, 0.6)',
                            borderColor: 'rgb(255, 159, 64)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y.toLocaleString('fr-FR');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR');
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            resultat.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`;
        });
}

function comparerMachines(){
    const machine1 = document.getElementById('machine1-select').value;
    const machine2 = document.getElementById('machine2-select').value;
    const jours = document.getElementById('jours-select').value;
    
    if(!machine1 || !machine2){
        alert('Veuillez s√©lectionner les deux machines');
        return;
    }
    
    const resultat = document.getElementById('resultat-machines');
    resultat.innerHTML = '<div class="alert alert-secondary">Comparaison en cours...</div>';
    
    fetch(`/projet10/api/statistiques/comparaison-machines?machine1=${encodeURIComponent(machine1)}&machine2=${encodeURIComponent(machine2)}&jours=${jours}`)
        .then(r => r.json())
        .then(data => {
            const fmt = (n) => (n || 0).toLocaleString('fr-FR');
            const f3 = (n) => (n || 0).toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3});
            
            const m1 = data.machine1;
            const m2 = data.machine2;
            
            resultat.innerHTML = `
                <div class="row">
                    <!-- Graphique comparatif des machines -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-center mb-3">Comparaison Quantit√©s</h6>
                                <canvas id="chartComparaisonMachinesQte"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Graphique comparatif taux -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-center mb-3">Comparaison Taux de Conformit√©</h6>
                                <canvas id="chartComparaisonMachinesTaux"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Tableau d√©taill√© -->
                    <div class="col-12">
                        <div class="card shadow-sm">
                            <div class="card-body">
                                <h6 class="text-center mb-3">D√©tails de Comparaison (${jours} derniers jours)</h6>
                                <div class="table-responsive">
                                    <table class="table table-striped">
                                        <thead class="table-primary">
                                            <tr>
                                                <th>Machine</th>
                                                <th class="text-center">Nb Contr√¥les</th>
                                                <th class="text-center">Conforme</th>
                                                <th class="text-center">Rebus</th>
                                                <th class="text-center">Total</th>
                                                <th class="text-center">Taux Conformit√©</th>
                                                <th class="text-center">Taux Rebus</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td><strong class="text-primary">${m1.machine}</strong></td>
                                                <td class="text-center">${fmt(m1.nombre_controles)}</td>
                                                <td class="text-center text-success">${fmt(m1.total_conforme)}</td>
                                                <td class="text-center text-danger">${fmt(m1.total_rebus)}</td>
                                                <td class="text-center">${fmt(m1.total_produit)}</td>
                                                <td class="text-center"><strong>${f3(m1.taux_conformite)}%</strong></td>
                                                <td class="text-center">${f3(m1.taux_rebus)}%</td>
                                            </tr>
                                            <tr>
                                                <td><strong class="text-info">${m2.machine}</strong></td>
                                                <td class="text-center">${fmt(m2.nombre_controles)}</td>
                                                <td class="text-center text-success">${fmt(m2.total_conforme)}</td>
                                                <td class="text-center text-danger">${fmt(m2.total_rebus)}</td>
                                                <td class="text-center">${fmt(m2.total_produit)}</td>
                                                <td class="text-center"><strong>${f3(m2.taux_conformite)}%</strong></td>
                                                <td class="text-center">${f3(m2.taux_rebus)}%</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Graphique 1: Quantit√©s
            const ctx1 = document.getElementById('chartComparaisonMachinesQte').getContext('2d');
            new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: ['Contr√¥les', 'Conforme', 'Rebus', 'Total'],
                    datasets: [
                        {
                            label: m1.machine,
                            data: [m1.nombre_controles, m1.total_conforme, m1.total_rebus, m1.total_produit],
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgb(54, 162, 235)',
                            borderWidth: 2
                        },
                        {
                            label: m2.machine,
                            data: [m2.nombre_controles, m2.total_conforme, m2.total_rebus, m2.total_produit],
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgb(75, 192, 192)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'top' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('fr-FR');
                                }
                            }
                        }
                    }
                }
            });
            
            // Graphique 2: Taux de conformit√©
            const ctx2 = document.getElementById('chartComparaisonMachinesTaux').getContext('2d');
            new Chart(ctx2, {
                type: 'doughnut',
                data: {
                    labels: [m1.machine, m2.machine],
                    datasets: [{
                        label: 'Taux de Conformit√©',
                        data: [m1.taux_conformite, m2.taux_conformite],
                        backgroundColor: [
                            'rgba(54, 162, 235, 0.6)',
                            'rgba(75, 192, 192, 0.6)'
                        ],
                        borderColor: [
                            'rgb(54, 162, 235)',
                            'rgb(75, 192, 192)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.toLocaleString('fr-FR', {minimumFractionDigits: 3, maximumFractionDigits: 3}) + '%';
                                }
                            }
                        }
                    }
                }
            });
        })
        .catch(err => {
            resultat.innerHTML = `<div class="alert alert-danger">Erreur: ${err.message}</div>`;
        });
}
</script>
{% endblock %}




